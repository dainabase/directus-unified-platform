<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet">
    <style>
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-success { border-left: 4px solid #28a745; }
        .test-error { border-left: 4px solid #dc3545; }
        .test-loading { border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <div class="page">
        <div class="container py-4">
            <h1 class="mb-4">Test d'intégration API Notion</h1>
            
            <!-- Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">Configuration</h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">URL du serveur API</label>
                        <input type="text" id="api-url" class="form-control" value="http://localhost:3001/api" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Clé API Notion (dans server/.env)</label>
                        <input type="password" id="notion-key" class="form-control" placeholder="Configurée côté serveur" disabled />
                        <small class="text-muted">La clé API doit être configurée dans le fichier server/.env</small>
                    </div>
                    <button id="test-connection" class="btn btn-primary">Tester la connexion</button>
                </div>
            </div>
            
            <!-- Tests -->
            <div class="row">
                <!-- Test serveur -->
                <div class="col-md-6">
                    <div class="test-section">
                        <h4>1. Test du serveur</h4>
                        <p class="text-muted">Vérifier que le serveur Node.js est accessible</p>
                        <button class="test-btn" data-test="server">Tester</button>
                        <div class="test-result" id="result-server"></div>
                    </div>
                </div>
                
                <!-- Test authentification -->
                <div class="col-md-6">
                    <div class="test-section">
                        <h4>2. Test d'authentification</h4>
                        <p class="text-muted">Se connecter avec un utilisateur test</p>
                        <div class="mb-2">
                            <input type="email" id="test-email" class="form-control mb-2" placeholder="Email" value="client@hypervisual.ch" />
                            <input type="password" id="test-password" class="form-control" placeholder="Mot de passe" value="client123" />
                        </div>
                        <button class="test-btn" data-test="auth">Tester</button>
                        <div class="test-result" id="result-auth"></div>
                    </div>
                </div>
                
                <!-- Test bases de données -->
                <div class="col-md-6">
                    <div class="test-section">
                        <h4>3. Test des bases de données</h4>
                        <p class="text-muted">Vérifier l'accès aux bases Notion</p>
                        <select id="database-select" class="form-select mb-2">
                            <option value="projects">Projets</option>
                            <option value="factures-clients">Factures Clients</option>
                            <option value="contacts">Contacts</option>
                            <option value="entreprises">Entreprises</option>
                            <option value="notes-frais">Notes de Frais</option>
                        </select>
                        <button class="test-btn" data-test="database">Tester</button>
                        <div class="test-result" id="result-database"></div>
                    </div>
                </div>
                
                <!-- Test création -->
                <div class="col-md-6">
                    <div class="test-section">
                        <h4>4. Test de création</h4>
                        <p class="text-muted">Créer une note de frais test</p>
                        <button class="test-btn" data-test="create">Créer</button>
                        <div class="test-result" id="result-create"></div>
                    </div>
                </div>
                
                <!-- Test statistiques -->
                <div class="col-md-6">
                    <div class="test-section">
                        <h4>5. Test des statistiques</h4>
                        <p class="text-muted">Récupérer les statistiques</p>
                        <button class="test-btn" data-test="stats">Tester</button>
                        <div class="test-result" id="result-stats"></div>
                    </div>
                </div>
                
                <!-- Test complet dashboard -->
                <div class="col-md-6">
                    <div class="test-section">
                        <h4>6. Test dashboard complet</h4>
                        <p class="text-muted">Charger toutes les données du dashboard</p>
                        <button class="test-btn" data-test="dashboard">Tester</button>
                        <div class="test-result" id="result-dashboard"></div>
                    </div>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">Instructions</h3>
                </div>
                <div class="card-body">
                    <ol>
                        <li>Assurez-vous d'avoir configuré la clé API Notion dans <code>server/.env</code></li>
                        <li>Démarrez le serveur : <code>cd server && npm start</code></li>
                        <li>Partagez vos bases de données Notion avec l'intégration</li>
                        <li>Lancez les tests dans l'ordre</li>
                    </ol>
                    
                    <h4 class="mt-3">Commandes utiles :</h4>
                    <pre class="bg-dark text-white p-3 rounded">
# Installer les dépendances
cd server && npm install

# Tester la connexion Notion
node test-notion-connection.js

# Démarrer le serveur
npm start

# Voir les logs
npm run dev</pre>
                </div>
            </div>
        </div>
    </div>
    
    <script src="assets/js/Core/api-client.js"></script>
    <script>
        // Configuration
        const updateApiUrl = () => {
            const url = document.getElementById('api-url').value;
            window.apiClient.baseURL = url;
        };
        
        document.getElementById('api-url').addEventListener('change', updateApiUrl);
        
        // Tests
        const tests = {
            // Test serveur
            async server() {
                const result = document.getElementById('result-server');
                result.className = 'test-result test-loading';
                result.textContent = 'Test en cours...';
                
                try {
                    const response = await fetch(`${window.apiClient.baseURL.replace('/api', '')}/health`);
                    const data = await response.json();
                    
                    result.className = 'test-result test-success';
                    result.textContent = `✅ Serveur OK\n${JSON.stringify(data, null, 2)}`;
                } catch (error) {
                    result.className = 'test-result test-error';
                    result.textContent = `❌ Erreur serveur\n${error.message}\n\nAssurez-vous que le serveur est démarré:\ncd server && npm start`;
                }
            },
            
            // Test authentification
            async auth() {
                const result = document.getElementById('result-auth');
                result.className = 'test-result test-loading';
                result.textContent = 'Connexion en cours...';
                
                try {
                    const email = document.getElementById('test-email').value;
                    const password = document.getElementById('test-password').value;
                    
                    const response = await window.apiClient.login(email, password);
                    
                    result.className = 'test-result test-success';
                    result.textContent = `✅ Connexion réussie\n${JSON.stringify(response, null, 2)}`;
                    
                    // Récupérer l'utilisateur courant
                    const user = await window.apiClient.getCurrentUser();
                    result.textContent += `\n\nUtilisateur:\n${JSON.stringify(user, null, 2)}`;
                    
                } catch (error) {
                    result.className = 'test-result test-error';
                    result.textContent = `❌ Erreur d'authentification\n${error.message}`;
                }
            },
            
            // Test bases de données
            async database() {
                const result = document.getElementById('result-database');
                result.className = 'test-result test-loading';
                result.textContent = 'Chargement...';
                
                try {
                    const database = document.getElementById('database-select').value;
                    let data;
                    
                    switch(database) {
                        case 'projects':
                            data = await window.apiClient.getProjects({ page_size: 3 });
                            break;
                        case 'factures-clients':
                            data = await window.apiClient.getFacturesClients({ page_size: 3 });
                            break;
                        case 'contacts':
                            data = await window.apiClient.getContacts({ page_size: 3 });
                            break;
                        case 'entreprises':
                            data = await window.apiClient.getEntreprises({ page_size: 3 });
                            break;
                        case 'notes-frais':
                            data = await window.apiClient.getNotesFrais({ page_size: 3 });
                            break;
                    }
                    
                    result.className = 'test-result test-success';
                    result.textContent = `✅ Base "${database}" accessible\n`;
                    result.textContent += `Nombre d'entrées: ${data.results.length}\n`;
                    result.textContent += `Aperçu:\n${JSON.stringify(data.results.slice(0, 2), null, 2)}`;
                    
                } catch (error) {
                    result.className = 'test-result test-error';
                    result.textContent = `❌ Erreur d'accès à la base\n${error.message}`;
                }
            },
            
            // Test création
            async create() {
                const result = document.getElementById('result-create');
                result.className = 'test-result test-loading';
                result.textContent = 'Création en cours...';
                
                try {
                    const noteData = {
                        'Description': 'Test API - Note de frais',
                        'Date Dépense': new Date().toISOString().split('T')[0],
                        'Montant': 50,
                        'TVA Incluse': 4.05,
                        'Catégorie': { select: { name: 'Repas affaires' } },
                        'Statut Validation': { select: { name: 'Brouillon' } }
                    };
                    
                    const response = await window.apiClient.createNoteFrais(noteData);
                    
                    result.className = 'test-result test-success';
                    result.textContent = `✅ Note de frais créée\n${JSON.stringify(response, null, 2)}`;
                    
                } catch (error) {
                    result.className = 'test-result test-error';
                    result.textContent = `❌ Erreur de création\n${error.message}`;
                }
            },
            
            // Test statistiques
            async stats() {
                const result = document.getElementById('result-stats');
                result.className = 'test-result test-loading';
                result.textContent = 'Chargement des statistiques...';
                
                try {
                    const [projectStats, financeStats, crmStats] = await Promise.all([
                        window.apiClient.getProjectStatistics(),
                        window.apiClient.getFinanceStatistics(new Date().getFullYear()),
                        window.apiClient.getCRMStatistics()
                    ]);
                    
                    result.className = 'test-result test-success';
                    result.textContent = `✅ Statistiques récupérées\n\n`;
                    result.textContent += `Projets:\n${JSON.stringify(projectStats, null, 2)}\n\n`;
                    result.textContent += `Finance:\n${JSON.stringify(financeStats, null, 2)}\n\n`;
                    result.textContent += `CRM:\n${JSON.stringify(crmStats, null, 2)}`;
                    
                } catch (error) {
                    result.className = 'test-result test-error';
                    result.textContent = `❌ Erreur statistiques\n${error.message}`;
                }
            },
            
            // Test dashboard complet
            async dashboard() {
                const result = document.getElementById('result-dashboard');
                result.className = 'test-result test-loading';
                result.textContent = 'Simulation du chargement dashboard...';
                
                try {
                    const startTime = Date.now();
                    
                    // Simuler le chargement du dashboard
                    const [projects, factures, stats] = await Promise.all([
                        window.apiClient.getProjects({ status: 'En cours', page_size: 5 }),
                        window.apiClient.getFacturesClients({ page_size: 5 }),
                        window.apiClient.getProjectStatistics()
                    ]);
                    
                    const loadTime = Date.now() - startTime;
                    
                    result.className = 'test-result test-success';
                    result.textContent = `✅ Dashboard chargé en ${loadTime}ms\n\n`;
                    result.textContent += `Projets actifs: ${projects.results.length}\n`;
                    result.textContent += `Factures récentes: ${factures.results.length}\n`;
                    result.textContent += `Stats: ${JSON.stringify(stats, null, 2)}`;
                    
                } catch (error) {
                    result.className = 'test-result test-error';
                    result.textContent = `❌ Erreur dashboard\n${error.message}`;
                }
            }
        };
        
        // Event listeners
        document.querySelectorAll('.test-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const testName = e.target.dataset.test;
                await tests[testName]();
            });
        });
        
        // Test de connexion initial
        document.getElementById('test-connection').addEventListener('click', async () => {
            updateApiUrl();
            await tests.server();
        });
    </script>
</body>
</html>