<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>Mes Projets - Espace Client</title>
    
    <!-- CSS Tabler -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css" rel="stylesheet">
    <link href="../../../assets/css/custom.css" rel="stylesheet">
</head>
<body data-bs-theme="light">
    <div class="page">
        <!-- Navbar from client dashboard -->
        <header class="navbar navbar-expand-md navbar-light d-print-none">
            <div class="container-xl">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                    <a href="../dashboard.html">
                        <img src="../../../assets/img/logo.svg" width="110" height="32" alt="Dashboard" class="navbar-brand-image">
                        Espace Client
                    </a>
                </h1>
                <div class="navbar-nav flex-row order-md-last">
                    <div class="nav-item d-none d-md-flex me-3">
                        <div class="btn-list">
                            <span class="badge bg-blue">CLIENT</span>
                        </div>
                    </div>
                    <div class="d-none d-md-flex">
                        <a href="#" class="nav-link px-0 hide-theme-dark" onclick="document.body.setAttribute('data-bs-theme', 'dark')" title="Activer le mode sombre" data-bs-toggle="tooltip" data-bs-placement="bottom">
                            <i class="ti ti-moon"></i>
                        </a>
                        <a href="#" class="nav-link px-0 hide-theme-light" onclick="document.body.setAttribute('data-bs-theme', 'light')" title="Activer le mode clair" data-bs-toggle="tooltip" data-bs-placement="bottom">
                            <i class="ti ti-sun"></i>
                        </a>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
                            <span class="avatar avatar-sm bg-blue-lt">CL</span>
                            <div class="d-none d-xl-block ps-2">
                                <div>Client Premium</div>
                                <div class="mt-1 small text-secondary">Espace projets</div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                            <a href="../profile.html" class="dropdown-item">
                                <i class="ti ti-user me-2"></i>
                                Mon profil
                            </a>
                            <a href="./projects.html" class="dropdown-item">
                                <i class="ti ti-folder me-2"></i>
                                Mes projets
                            </a>
                            <a href="../documents.html" class="dropdown-item">
                                <i class="ti ti-file me-2"></i>
                                Documents
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item text-danger" onclick="logout()">
                                <i class="ti ti-logout me-2"></i>
                                Déconnexion
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Horizontal menu -->
        <header class="navbar-expand-md">
            <div class="collapse navbar-collapse" id="navbar-menu">
                <div class="navbar">
                    <div class="container-xl">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" href="../dashboard.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-home"></i>
                                    </span>
                                    <span class="nav-link-title">Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-item active">
                                <a class="nav-link" href="./projects.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-folder"></i>
                                    </span>
                                    <span class="nav-link-title">Projets</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./invoices.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-file-invoice"></i>
                                    </span>
                                    <span class="nav-link-title">Factures</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="../documents.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-files"></i>
                                    </span>
                                    <span class="nav-link-title">Documents</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="../support.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-help"></i>
                                    </span>
                                    <span class="nav-link-title">Support</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">Mes Projets</h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#new-project-modal">
                                    <i class="ti ti-plus"></i> Nouveau projet
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="page-body">
                <div class="container-xl">
                    <!-- Filtres -->
                    <div class="row mb-3">
                        <div class="col-auto">
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="status-filter" id="filter-all" value="" checked>
                                <label class="btn" for="filter-all">Tous</label>
                                
                                <input type="radio" class="btn-check" name="status-filter" id="filter-active" value="active">
                                <label class="btn" for="filter-active">En cours</label>
                                
                                <input type="radio" class="btn-check" name="status-filter" id="filter-completed" value="completed">
                                <label class="btn" for="filter-completed">Terminés</label>
                                
                                <input type="radio" class="btn-check" name="status-filter" id="filter-pending" value="pending">
                                <label class="btn" for="filter-pending">En attente</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Liste des projets -->
                    <div class="row row-cards" id="projects-container">
                        <!-- Sera rempli par JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal nouveau projet -->
    <div class="modal modal-blur fade" id="new-project-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nouveau projet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nom du projet</label>
                        <input type="text" class="form-control" id="project-name" placeholder="Ex: Refonte site web">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="project-description" rows="3" placeholder="Décrivez votre projet..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Budget estimé</label>
                                <input type="number" class="form-control" id="project-budget" placeholder="CHF">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Date souhaitée</label>
                                <input type="date" class="form-control" id="project-date">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn me-auto" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="createProject()">
                        <i class="ti ti-check"></i> Créer le projet
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script src="../../../assets/js/app.js"></script>
    <script src="../../../assets/js/auth-directus.js"></script>
    
    <script>
        let allProjects = [];
        
        async function loadProjects() {
            try {
                const response = await window.App.api.get('/items/projects');
                allProjects = response.data || [];
                displayProjects(allProjects);
            } catch (error) {
                console.error('Erreur:', error);
                window.App.utils.showAlert('Erreur de chargement des projets', 'danger');
            }
        }
        
        function displayProjects(projects) {
            const container = document.getElementById('projects-container');
            
            if (projects.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="card"><div class="card-body text-center text-muted">Aucun projet trouvé</div></div></div>';
                return;
            }
            
            container.innerHTML = projects.map(project => `
                <div class="col-md-6 col-lg-4">
                    <div class="card">
                        <div class="card-status-start bg-${getProjectColor(project.status)}"></div>
                        <div class="card-body">
                            <h3 class="card-title">${project.name || 'Projet sans nom'}</h3>
                            <p class="text-muted">${project.description || 'Pas de description'}</p>
                            
                            <div class="mb-3">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="text-muted">Progression</span>
                                    </div>
                                    <div class="col">
                                        <div class="progress">
                                            <div class="progress-bar" style="width: ${project.progress || 0}%" role="progressbar">
                                                <span class="visually-hidden">${project.progress || 0}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <span class="small">${project.progress || 0}%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col">
                                        <div class="text-muted">Budget</div>
                                        <strong>${window.App.utils.formatCurrency(project.budget || 0)}</strong>
                                    </div>
                                    <div class="col-auto">
                                        <div class="text-muted">Deadline</div>
                                        <strong>${project.deadline ? new Date(project.deadline).toLocaleDateString('fr-CH') : 'Non définie'}</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <div class="me-auto">
                                    <span class="badge bg-${getProjectColor(project.status)}">
                                        ${getProjectStatus(project.status)}
                                    </span>
                                </div>
                                <div>
                                    <a href="./project-detail.html?id=${project.id}" class="btn btn-sm">
                                        Voir détails
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function getProjectColor(status) {
            const colors = {
                'active': 'primary',
                'completed': 'success',
                'pending': 'warning',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }
        
        function getProjectStatus(status) {
            const labels = {
                'active': 'En cours',
                'completed': 'Terminé',
                'pending': 'En attente',
                'cancelled': 'Annulé'
            };
            return labels[status] || status;
        }
        
        // Filtres
        document.querySelectorAll('input[name="status-filter"]').forEach(input => {
            input.addEventListener('change', function() {
                const status = this.value;
                const filtered = status ? allProjects.filter(p => p.status === status) : allProjects;
                displayProjects(filtered);
            });
        });
        
        async function createProject() {
            const name = document.getElementById('project-name').value;
            const description = document.getElementById('project-description').value;
            const budget = document.getElementById('project-budget').value;
            const date = document.getElementById('project-date').value;
            
            if (!name) {
                window.App.utils.showAlert('Veuillez entrer un nom de projet', 'warning');
                return;
            }
            
            try {
                const data = {
                    name: name,
                    description: description,
                    budget: parseFloat(budget) || 0,
                    deadline: date,
                    status: 'pending',
                    progress: 0
                };
                
                // En production, faire un vrai POST
                // const response = await window.App.api.post('/items/projects', data);
                
                window.App.utils.showAlert('Projet créé avec succès!', 'success');
                
                // Fermer le modal
                bootstrap.Modal.getInstance(document.getElementById('new-project-modal')).hide();
                
                // Recharger les projets
                loadProjects();
                
            } catch (error) {
                console.error('Erreur:', error);
                window.App.utils.showAlert('Erreur lors de la création du projet', 'danger');
            }
        }
        
        function logout() {
            if (window.AuthDirectus) {
                window.AuthDirectus.logout();
            }
        }
        
        // Charger au démarrage
        document.addEventListener('DOMContentLoaded', loadProjects);
    </script>
</body>
</html>