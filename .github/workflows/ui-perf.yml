name: UI Performance

on:
  push:
    branches: [main, feat/design-system-apple]
    paths:
      - 'packages/ui/**'
  pull_request:
    paths:
      - 'packages/ui/**'

jobs:
  performance:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build UI library
        run: pnpm -C packages/ui build:vite
        
      - name: Check bundle size
        run: |
          echo "üìä Bundle Size Report"
          echo "===================="
          
          # Get the size of the main bundle
          BUNDLE_SIZE=$(stat -c%s packages/ui/dist/index.es.js)
          BUNDLE_SIZE_KB=$((BUNDLE_SIZE / 1024))
          
          # Get gzipped size
          gzip -c packages/ui/dist/index.es.js > packages/ui/dist/index.es.js.gz
          GZIP_SIZE=$(stat -c%s packages/ui/dist/index.es.js.gz)
          GZIP_SIZE_KB=$((GZIP_SIZE / 1024))
          
          echo "Bundle size: ${BUNDLE_SIZE_KB}KB"
          echo "Gzipped size: ${GZIP_SIZE_KB}KB"
          
          # Check if under budget (200KB gzipped)
          if [ $GZIP_SIZE_KB -gt 200 ]; then
            echo "‚ùå Bundle size exceeds budget (200KB gzipped)"
            echo "Current: ${GZIP_SIZE_KB}KB, Budget: 200KB"
            exit 1
          else
            echo "‚úÖ Bundle size within budget"
          fi
          
      - name: Generate bundle visualization
        run: pnpm -C packages/ui analyze:bundle
        
      - name: Upload bundle stats
        uses: actions/upload-artifact@v3
        with:
          name: bundle-stats
          path: packages/ui/dist/stats.html
          
      - name: Performance metrics
        run: |
          echo "üìà Performance Metrics"
          echo "====================="
          
          # Build time
          START_TIME=$(date +%s)
          pnpm -C packages/ui build:vite
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          
          echo "Build time: ${BUILD_TIME}s"
          
          # Check if build time is under 30 seconds
          if [ $BUILD_TIME -gt 30 ]; then
            echo "‚ö†Ô∏è Build time exceeds target (30s)"
          else
            echo "‚úÖ Build time within target"
          fi
          
      - name: Tree-shaking verification
        run: |
          echo "üå≥ Tree-shaking Verification"
          echo "============================"
          
          # Check if sideEffects is false
          SIDE_EFFECTS=$(node -e "const pkg = require('./packages/ui/package.json'); console.log(pkg.sideEffects)")
          
          if [ "$SIDE_EFFECTS" = "false" ]; then
            echo "‚úÖ sideEffects: false configured"
          else
            echo "‚ùå sideEffects not properly configured"
            exit 1
          fi
          
          # Check for proper exports
          node -e "
            const pkg = require('./packages/ui/package.json');
            if (pkg.exports && pkg.exports['.']) {
              console.log('‚úÖ Proper exports configured');
            } else {
              console.log('‚ùå Missing proper exports');
              process.exit(1);
            }
          "
          
      - name: Comment PR with metrics
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read the metrics (this is simplified, in real scenario you'd parse the actual output)
            const comment = `## üìä Performance Report
            
            | Metric | Value | Status |
            |--------|-------|--------|
            | Bundle Size | < 200KB | ‚úÖ |
            | Build Time | < 30s | ‚úÖ |
            | Tree-shaking | Enabled | ‚úÖ |
            
            View full [bundle analysis](artifacts-url)`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
