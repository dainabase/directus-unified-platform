name: Auto-Fix Build Issues

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'packages/ui/**'
      - '.github/workflows/auto-fix-build.yml'

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clean workspace
        working-directory: packages/ui
        run: |
          echo "ğŸ§¹ Cleaning workspace..."
          rm -rf node_modules package-lock.json dist coverage

      - name: Run fix imports script
        working-directory: packages/ui
        run: |
          echo "ğŸ”§ Running fix imports script..."
          node scripts/fix-imports.js

      - name: Install fresh dependencies
        working-directory: packages/ui
        run: |
          echo "ğŸ“¦ Installing fresh dependencies..."
          npm install

      - name: Attempt build
        working-directory: packages/ui
        run: |
          echo "ğŸ—ï¸ Attempting build..."
          npm run build || echo "Build had issues, continuing..."

      - name: Check TypeScript
        working-directory: packages/ui
        run: |
          echo "ğŸ” Checking TypeScript..."
          npm run type-check || echo "TypeScript check had issues, continuing..."

      - name: Run tests
        working-directory: packages/ui
        run: |
          echo "ğŸ§ª Running tests..."
          npm test || echo "Tests had issues, continuing..."

      - name: Commit fixes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git diff --staged --quiet || git commit -m "fix: Auto-fix import and dependency issues"
          git push || echo "No changes to push"

      - name: Build status report
        if: always()
        working-directory: packages/ui
        run: |
          echo "ğŸ“Š Build Status Report"
          echo "====================="
          if [ -d "dist" ]; then
            echo "âœ… Build output exists"
            ls -la dist/ | head -10
            echo "Bundle size: $(du -sh dist/ | cut -f1)"
          else
            echo "âŒ No build output found"
          fi
          echo ""
          echo "Dependencies installed:"
          npm list --depth=0 || true
