<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Int√©gration Notion - OCR Vision AI</title>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">
</head>
<body>
    <div class="page">
        <div class="page-wrapper">
            <div class="page-body">
                <div class="container-xl">
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">üîß Test Int√©gration Notion API</h3>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <h4 class="alert-title">Configuration requise</h4>
                                        <ol class="mb-0">
                                            <li>Cl√© API Notion (commence par secret_)</li>
                                            <li>Proxy PHP d√©ploy√© sur /api/notion-proxy.php</li>
                                            <li>IDs des databases Notion configur√©s</li>
                                        </ol>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <h4>1. Configuration API</h4>
                                            <div class="mb-3">
                                                <label class="form-label">Cl√© API Notion</label>
                                                <input type="password" class="form-control" id="notion-api-key" placeholder="secret_...">
                                                <small class="text-muted">Obtenez votre cl√© sur notion.so/my-integrations</small>
                                            </div>
                                            <button class="btn btn-primary" onclick="saveNotionKey()">Sauvegarder la cl√©</button>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h4>2. Test de connexion</h4>
                                            <button class="btn btn-success" onclick="testNotionConnection()">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2"/>
                                                    <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/>
                                                    <path d="M14 4l0 4l-6 0l0 -4"/>
                                                </svg>
                                                Tester la connexion
                                            </button>
                                            <div id="connection-result" class="mt-3"></div>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <h4>3. Test d'envoi de document</h4>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Type de document</label>
                                                <select class="form-select" id="test-doc-type">
                                                    <option value="FACTURE_CLIENT">Facture Client</option>
                                                    <option value="FACTURE_FOURNISSEUR">Facture Fournisseur</option>
                                                    <option value="NOTE_FRAIS">Note de Frais</option>
                                                    <option value="CONTRAT">Contrat</option>
                                                    <option value="DOCUMENT_GENERAL">Document G√©n√©ral</option>
                                                    <option value="TRANSACTION_BANCAIRE">Transaction Bancaire</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Num√©ro document</label>
                                                <input type="text" class="form-control" id="test-doc-number" value="TEST-001">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Montant</label>
                                                <input type="number" class="form-control" id="test-amount" value="1234.56">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-primary" onclick="testSendDocument()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M22 7.535v9.465a3 3 0 0 1 -2.824 2.995l-.176 .005h-14a3 3 0 0 1 -2.995 -2.824l-.005 -.176v-9.465l9.445 6.297l.116 .066a1 1 0 0 0 .878 0l.116 -.066l9.445 -6.297z"/>
                                            <path d="M19 4c1.08 0 2.027 .57 2.555 1.427l-9.555 6.37l-9.555 -6.37a2.999 2.999 0 0 1 2.354 -1.42l.201 -.007h14z"/>
                                        </svg>
                                        Envoyer test vers Notion
                                    </button>
                                    
                                    <div id="send-result" class="mt-3"></div>
                                    
                                    <hr class="my-4">
                                    
                                    <h4>4. V√©rification des databases</h4>
                                    <button class="btn btn-outline-primary" onclick="listDatabases()">Lister les databases</button>
                                    <div id="databases-list" class="mt-3"></div>
                                    
                                    <hr class="my-4">
                                    
                                    <h4>5. Configuration du proxy</h4>
                                    <div class="alert alert-warning">
                                        <h4 class="alert-title">Important: Proxy Backend requis</h4>
                                        <p>L'API Notion ne peut pas √™tre appel√©e directement depuis le navigateur (CORS). Vous devez d√©ployer le proxy PHP:</p>
                                        <ol>
                                            <li>Copiez <code>/api/notion-proxy.php</code> sur votre serveur</li>
                                            <li>Assurez-vous que PHP est install√© (version 7.4+)</li>
                                            <li>V√©rifiez que CURL est activ√© dans PHP</li>
                                            <li>L'URL du proxy doit √™tre accessible depuis cette page</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
    <script src="../../assets/js/Superadmin/ocr-templates-final.js"></script>
    
    <script>
        // Charger la cl√© API au d√©marrage
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('notion_api_key');
            if (savedKey) {
                document.getElementById('notion-api-key').value = savedKey;
            }
        });
        
        function saveNotionKey() {
            const key = document.getElementById('notion-api-key').value;
            if (key && key.startsWith('secret_')) {
                localStorage.setItem('notion_api_key', key);
                showAlert('success', 'Cl√© API sauvegard√©e!');
            } else {
                showAlert('error', 'Cl√© API invalide (doit commencer par secret_)');
            }
        }
        
        async function testNotionConnection() {
            const resultDiv = document.getElementById('connection-result');
            const apiKey = localStorage.getItem('notion_api_key');
            
            if (!apiKey) {
                showAlert('error', 'Configurez d\'abord votre cl√© API Notion');
                return;
            }
            
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Test en cours...';
            
            try {
                const response = await fetch('/api/notion-proxy.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': apiKey
                    },
                    body: JSON.stringify({
                        action: 'get_databases'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ Connexion r√©ussie! ${data.results?.length || 0} databases trouv√©es.
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erreur de connexion');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Erreur: ${error.message}
                        ${error.message.includes('Failed to fetch') ? '<br>V√©rifiez que le proxy PHP est d√©ploy√©!' : ''}
                    </div>
                `;
            }
        }
        
        async function testSendDocument() {
            const resultDiv = document.getElementById('send-result');
            const apiKey = localStorage.getItem('notion_api_key');
            const docType = document.getElementById('test-doc-type').value;
            const docNumber = document.getElementById('test-doc-number').value;
            const amount = parseFloat(document.getElementById('test-amount').value);
            
            if (!apiKey) {
                showAlert('error', 'Configurez d\'abord votre cl√© API Notion');
                return;
            }
            
            const template = DOCUMENT_TYPES[docType];
            if (!template) {
                showAlert('error', 'Type de document invalide');
                return;
            }
            
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Envoi en cours...';
            
            try {
                // Pr√©parer les donn√©es de test
                const testData = {
                    parent: { database_id: template.database_id },
                    properties: {}
                };
                
                // Ajouter les propri√©t√©s selon le template
                if (docType === 'FACTURE_CLIENT') {
                    testData.properties = {
                        "Num√©ro": { title: [{ text: { content: docNumber } }] },
                        "Client": { rich_text: [{ text: { content: "Client Test" } }] },
                        "Date √âmission": { date: { start: new Date().toISOString().split('T')[0] } },
                        "Montant TTC": { number: amount },
                        "Statut": { select: { name: "Envoy√©" } }
                    };
                }
                
                const response = await fetch('/api/notion-proxy.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': apiKey
                    },
                    body: JSON.stringify({
                        action: 'create_page',
                        data: testData
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ Document cr√©√© avec succ√®s!
                            ${data.url ? `<br><a href="${data.url}" target="_blank">Ouvrir dans Notion</a>` : ''}
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erreur d\'envoi');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Erreur: ${error.message}
                    </div>
                `;
            }
        }
        
        async function listDatabases() {
            const resultDiv = document.getElementById('databases-list');
            const apiKey = localStorage.getItem('notion_api_key');
            
            if (!apiKey) {
                showAlert('error', 'Configurez d\'abord votre cl√© API Notion');
                return;
            }
            
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Chargement...';
            
            try {
                // V√©rifier chaque database du projet
                let html = '<div class="table-responsive"><table class="table"><thead><tr><th>Type</th><th>Database ID</th><th>Statut</th></tr></thead><tbody>';
                
                for (const [type, template] of Object.entries(DOCUMENT_TYPES)) {
                    const response = await fetch('/api/notion-proxy.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': apiKey
                        },
                        body: JSON.stringify({
                            action: 'verify_database',
                            database_id: template.database_id
                        })
                    });
                    
                    const data = await response.json();
                    const status = data.exists ? 
                        '<span class="badge bg-success">‚úì Trouv√©e</span>' : 
                        '<span class="badge bg-danger">‚úó Non trouv√©e</span>';
                    
                    html += `<tr><td>${type}</td><td><code>${template.database_id}</code></td><td>${status}</td></tr>`;
                }
                
                html += '</tbody></table></div>';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Erreur: ${error.message}
                    </div>
                `;
            }
        }
        
        function showAlert(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const html = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.querySelector('.card-body').insertAdjacentHTML('afterbegin', html);
        }
    </script>
</body>
</html>