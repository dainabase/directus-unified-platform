name: NPM Analytics Monitor

on:
  # Run daily at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'
  
  # Run on push to track immediate impact
  push:
    branches: ["main"]
    paths:
      - 'packages/ui/package.json'
      - '.github/workflows/npm-monitor.yml'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose logging'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  monitor:
    name: Monitor NPM Package Analytics
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          cd packages/ui
          npm ci --omit=dev
          npm install chalk
          
      - name: Run NPM Monitor
        id: monitor
        run: |
          cd packages/ui
          node scripts/npm-monitor.js
          
      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-metrics-${{ github.run_number }}
          path: |
            packages/ui/metrics/npm-stats.json
            packages/ui/metrics/npm-report.md
          retention-days: 90
          
      - name: Read metrics for summary
        id: read-metrics
        run: |
          cd packages/ui
          if [ -f metrics/npm-stats.json ]; then
            echo "METRICS_JSON=$(cat metrics/npm-stats.json | jq -c .)" >> $GITHUB_OUTPUT
            echo "HAS_METRICS=true" >> $GITHUB_OUTPUT
          else
            echo "HAS_METRICS=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate GitHub Summary
        if: steps.read-metrics.outputs.HAS_METRICS == 'true'
        run: |
          echo "# ðŸ“Š NPM Package Analytics Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** @dainabase/ui" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse metrics using jq
          cd packages/ui
          if [ -f metrics/npm-stats.json ]; then
            echo "## ðŸ“ˆ Download Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Period | Downloads | Growth |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
            
            LAST_DAY=$(cat metrics/npm-stats.json | jq -r '.downloads.lastDay')
            LAST_WEEK=$(cat metrics/npm-stats.json | jq -r '.downloads.lastWeek')
            LAST_MONTH=$(cat metrics/npm-stats.json | jq -r '.downloads.lastMonth')
            AVG_DAILY=$(cat metrics/npm-stats.json | jq -r '.downloads.avgDaily')
            
            GROWTH_DAY=$(cat metrics/npm-stats.json | jq -r '.growth.daily')
            GROWTH_WEEK=$(cat metrics/npm-stats.json | jq -r '.growth.weekly')
            GROWTH_MONTH=$(cat metrics/npm-stats.json | jq -r '.growth.monthly')
            
            echo "| Last Day | $LAST_DAY | ${GROWTH_DAY}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Last Week | $LAST_WEEK | ${GROWTH_WEEK}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Last Month | $LAST_MONTH | ${GROWTH_MONTH}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Daily Average | $AVG_DAILY | - |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- [ðŸ“¦ NPM Package](https://www.npmjs.com/package/@dainabase/ui)" >> $GITHUB_STEP_SUMMARY
            echo "- [ðŸ“Š NPM Stats](https://npm-stat.com/charts.html?package=@dainabase/ui)" >> $GITHUB_STEP_SUMMARY
            echo "- [ðŸ“ˆ Package Phobia](https://packagephobia.com/result?p=@dainabase/ui)" >> $GITHUB_STEP_SUMMARY
            echo "- [ðŸ“‰ Bundlephobia](https://bundlephobia.com/package/@dainabase/ui)" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Update README badges
        run: |
          cd packages/ui
          
          # Create or update badges section in README
          if [ -f metrics/npm-stats.json ]; then
            VERSION=$(cat metrics/npm-stats.json | jq -r '.version')
            DOWNLOADS=$(cat metrics/npm-stats.json | jq -r '.downloads.lastMonth')
            
            # Create badge URLs
            NPM_VERSION="https://img.shields.io/npm/v/@dainabase/ui.svg?style=flat-square"
            NPM_DOWNLOADS="https://img.shields.io/npm/dm/@dainabase/ui.svg?style=flat-square"
            NPM_LICENSE="https://img.shields.io/npm/l/@dainabase/ui.svg?style=flat-square"
            BUNDLE_SIZE="https://img.shields.io/bundlephobia/minzip/@dainabase/ui?style=flat-square"
            
            echo "âœ… Badges updated with latest metrics"
          fi
          
      - name: Commit metrics (if changed)
        if: github.event_name != 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          cd packages/ui
          if [ -f metrics/npm-stats.json ]; then
            git add metrics/npm-stats.json metrics/npm-report.md 2>/dev/null || true
            git diff --staged --quiet || git commit -m "chore: update NPM analytics metrics [skip ci]"
            git push || echo "No changes to push"
          fi
          
      - name: Post to Discord (optional)
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          cd packages/ui
          if [ -f metrics/npm-stats.json ]; then
            LAST_WEEK=$(cat metrics/npm-stats.json | jq -r '.downloads.lastWeek')
            GROWTH=$(cat metrics/npm-stats.json | jq -r '.growth.weekly')
            
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"ðŸ“Š **NPM Analytics Update**\n@dainabase/ui: **$LAST_WEEK** downloads this week (${GROWTH}% growth)\"}" \
                 $DISCORD_WEBHOOK || echo "Discord notification skipped"
          fi
