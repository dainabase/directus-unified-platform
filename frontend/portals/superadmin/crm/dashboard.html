<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Dashboard CRM • SuperAdmin</title>
    <link rel="icon" href="../../assets/img/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="../../assets/img/favicon.ico" type="image/x-icon">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">
    <link href="../../assets/css/custom.css" rel="stylesheet">
    
    <!-- ApexCharts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@latest/dist/apexcharts.css">
    
    <style>
        /* Dark mode toggle visibility */
        [data-bs-theme="dark"] .hide-theme-dark { display: none !important; }
        [data-bs-theme="light"] .hide-theme-light { display: none !important; }
        
        /* JetBrains Mono pour les valeurs numériques */
        .metric-value,
        .h1,
        .h2,
        .revenue-amount,
        .percentage-value,
        .score-value,
        .stats-number,
        .chart-value {
            font-family: 'JetBrains Mono', monospace !important;
            font-weight: 600;
        }
        
        .stat-card {
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        .stat-card.border-red { border-left-color: #d63031; }
        .stat-card.border-blue { border-left-color: #206bc4; }
        .stat-card.border-green { border-left-color: #2fb344; }
        .stat-card.border-yellow { border-left-color: #f59f00; }
        
        .entity-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .entity-hypervisual { background: #206bc4; color: white; }
        .entity-dainamics { background: #2fb344; color: white; }
        .entity-enki { background: #f59f00; color: white; }
        .entity-takeout { background: #d63031; color: white; }
        .entity-lexaia { background: #6f42c1; color: white; }
        
        .score-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .score-high { background: #d1f3db; color: #2fb344; }
        .score-medium { background: #fef3c7; color: #f59f00; }
        .score-low { background: #fee2e2; color: #d63031; }
        
        .alert-item {
            border-left: 3px solid #d63031;
            background: #fef2f2;
        }
    </style>
</head>

<body data-bs-theme="light">
    <div class="page">
        <!-- Navbar -->
        <header class="navbar navbar-expand-md navbar-light navbar-overlap d-print-none">
            <div class="container-xl">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                    <a href="../index.html">
                        <img src="../../assets/img/logo.svg" width="110" height="32" alt="SuperAdmin" class="navbar-brand-image">
                    </a>
                </h1>
                <div class="navbar-nav flex-row order-md-last">
                    <div class="nav-item d-none d-md-flex me-3">
                        <div class="btn-list">
                            <span class="badge bg-red">SUPERADMIN</span>
                        </div>
                    </div>
                    <!-- Dark Mode Toggle -->
                    <div class="nav-item d-none d-md-flex me-3">
                        <div class="btn-list-item">
                            <a href="#" class="nav-link px-0 hide-theme-dark" title="Enable dark mode" data-bs-toggle="tooltip" data-bs-placement="bottom" onclick="document.body.setAttribute('data-bs-theme', 'dark')">
                                <i class="ti ti-moon"></i>
                            </a>
                            <a href="#" class="nav-link px-0 hide-theme-light" title="Enable light mode" data-bs-toggle="tooltip" data-bs-placement="bottom" onclick="document.body.setAttribute('data-bs-theme', 'light')">
                                <i class="ti ti-sun"></i>
                            </a>
                        </div>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                            <span class="avatar avatar-sm" style="background-image: url(https://eu.ui-avatars.com/api/?name=Paul+Martin&background=c44569&color=fff)"></span>
                            <div class="d-none d-xl-block ps-2">
                                <div>Paul Martin</div>
                                <div class="mt-1 small text-secondary">
                                    <span class="badge bg-red">SUPERADMIN</span>
                                </div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                            <a href="../system/settings.html" class="dropdown-item">Paramètres système</a>
                            <a href="../system/audit-logs.html" class="dropdown-item">Logs d'audit</a>
                            <div class="dropdown-divider"></div>
                            <a href="../../index.html" class="dropdown-item">Déconnexion</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <header class="navbar-expand-md">
            <div class="collapse navbar-collapse" id="navbar-menu">
                <div class="navbar">
                    <div class="container-xl">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" href="../dashboard.html">
                                    <span class="nav-link-icon"><i class="ti ti-home"></i></span>
                                    <span class="nav-link-title">Vue d'ensemble</span>
                                </a>
                            </li>
                            <li class="nav-item dropdown active">
                                <a class="nav-link dropdown-toggle" href="#navbar-crm" data-bs-toggle="dropdown" role="button">
                                    <span class="nav-link-icon"><i class="ti ti-users"></i></span>
                                    <span class="nav-link-title">CRM</span>
                                </a>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item active" href="dashboard.html">
                                        <span class="nav-link-icon"><i class="ti ti-dashboard"></i></span>
                                        Dashboard CRM
                                    </a>
                                    <a class="dropdown-item" href="companies.html">
                                        <span class="nav-link-icon"><i class="ti ti-building"></i></span>
                                        Entreprises
                                    </a>
                                    <a class="dropdown-item" href="contacts.html">
                                        <span class="nav-link-icon"><i class="ti ti-users"></i></span>
                                        Contacts VIP
                                    </a>
                                    <a class="dropdown-item" href="pipeline.html">
                                        <span class="nav-link-icon"><i class="ti ti-chart-line"></i></span>
                                        Pipeline global
                                    </a>
                                </div>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#navbar-finance" data-bs-toggle="dropdown" role="button">
                                    <span class="nav-link-icon"><i class="ti ti-currency-dollar"></i></span>
                                    <span class="nav-link-title">Finance</span>
                                </a>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="../finance/monthly-reports.html">Reporting consolidé</a>
                                    <a class="dropdown-item" href="../finance/accounting.html">Comptabilité</a>
                                    <a class="dropdown-item" href="../finance/vat-reports.html">TVA multi-entités</a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page wrapper -->
        <div class="page-wrapper">
            <!-- Page header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <div class="page-pretitle">CRM SuperAdmin</div>
                            <h2 class="page-title">Dashboard consolidé multi-entités</h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <span class="d-none d-sm-inline">
                                    <a href="#" class="btn btn-outline-secondary" onclick="CRMSuperadmin.exportDashboard()">
                                        <i class="ti ti-download"></i>
                                        Export
                                    </a>
                                </span>
                                <a href="#" class="btn btn-primary" onclick="CRMSuperadmin.refreshDashboard()">
                                    <i class="ti ti-refresh"></i>
                                    Actualiser
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- KPIs Row -->
                    <div class="row row-deck row-cards mb-4">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card border-red">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">CA Total Groupe</div>
                                        <div class="ms-auto lh-1">
                                            <div class="dropdown">
                                                <a class="dropdown-toggle text-secondary" href="#" data-bs-toggle="dropdown">
                                                    <i class="ti ti-dots-vertical"></i>
                                                </a>
                                                <div class="dropdown-menu dropdown-menu-end">
                                                    <a class="dropdown-item" href="#">Voir détails</a>
                                                    <a class="dropdown-item" href="#">Export CSV</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-baseline">
                                        <div class="h1 mb-0 me-2" id="kpi-revenue">CHF 0</div>
                                        <div class="me-auto">
                                            <span class="text-green d-inline-flex align-items-center lh-1">
                                                <i class="ti ti-trending-up"></i> 
                                                <span id="kpi-revenue-growth">0%</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-secondary mt-1">
                                        <span id="kpi-revenue-period">YTD 2025</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card border-blue">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Entreprises Actives</div>
                                    </div>
                                    <div class="d-flex align-items-baseline">
                                        <div class="h1 mb-0 me-2" id="kpi-companies">0</div>
                                        <div class="me-auto">
                                            <span class="text-blue d-inline-flex align-items-center lh-1">
                                                <i class="ti ti-plus"></i> 
                                                <span id="kpi-companies-new">0</span> ce mois
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-secondary mt-1">
                                        Score moyen: <span id="kpi-companies-score">0</span>/100
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card border-green">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Pipeline Total</div>
                                    </div>
                                    <div class="d-flex align-items-baseline">
                                        <div class="h1 mb-0 me-2" id="kpi-pipeline">CHF 0</div>
                                    </div>
                                    <div class="text-secondary mt-1">
                                        <span id="kpi-pipeline-count">0</span> opportunités
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card border-yellow">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Taux Conversion</div>
                                    </div>
                                    <div class="d-flex align-items-baseline">
                                        <div class="h1 mb-0 me-2" id="kpi-conversion">0%</div>
                                        <div class="me-auto">
                                            <span class="text-yellow d-inline-flex align-items-center lh-1">
                                                <i class="ti ti-arrow-up"></i> 
                                                <span id="kpi-conversion-trend">0%</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-secondary mt-1">
                                        Moy. <span id="kpi-conversion-days">0</span> jours
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="row row-cards mb-4">
                        <!-- Pipeline par entité -->
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Pipeline par entité</h3>
                                    <div class="card-actions">
                                        <div class="dropdown">
                                            <a href="#" class="btn-action dropdown-toggle" data-bs-toggle="dropdown">
                                                <i class="ti ti-dots-vertical"></i>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href="#" onclick="CRMSuperadmin.switchChartView('value')">
                                                    Vue valeur
                                                </a>
                                                <a class="dropdown-item" href="#" onclick="CRMSuperadmin.switchChartView('count')">
                                                    Vue nombre
                                                </a>
                                                <a class="dropdown-item" href="#" onclick="CRMSuperadmin.switchChartView('weighted')">
                                                    Vue pondérée
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="chart-pipeline-entities" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Répartition par étape -->
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Répartition par étape</h3>
                                </div>
                                <div class="card-body">
                                    <div id="chart-pipeline-stages" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tables Row -->
                    <div class="row row-cards">
                        <!-- Top 10 Entreprises -->
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Top 10 Entreprises stratégiques</h3>
                                    <div class="card-actions">
                                        <a href="companies.html" class="btn btn-sm btn-outline-secondary">
                                            Voir tout
                                            <i class="ti ti-arrow-right ms-1"></i>
                                        </a>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-vcenter card-table">
                                        <thead>
                                            <tr>
                                                <th>Entreprise</th>
                                                <th>Entité</th>
                                                <th>Score</th>
                                                <th class="text-end">CA Réalisé</th>
                                                <th class="text-end">Pipeline</th>
                                                <th class="w-1"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="top-companies-table">
                                            <!-- Populated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alertes -->
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-alert-circle text-red me-2"></i>
                                        Alertes CRM
                                    </h3>
                                    <div class="card-actions">
                                        <span class="badge bg-red" id="alerts-count">0</span>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush" id="alerts-list">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@latest/dist/apexcharts.min.js"></script>
    
    <!-- App scripts -->
    <script src="../../assets/js/app.js"></script>
    <script src="../../assets/js/Core/notion-connector.js"></script>
    <script src="../../assets/js/Core/permissions-notion.js"></script>
    <script src="../../assets/js/superadmin/crm-superadmin.js"></script>
    
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Check permissions
            if (!await PermissionsSuperadmin.checkPermission('superadmin.crm.view')) {
                window.location.href = '../unauthorized.html';
                return;
            }
            
            // Initialize CRM module
            await CRMSuperadmin.init();
            
            // Load dashboard data
            await CRMSuperadmin.loadDashboard();
            
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Auto-refresh every 5 minutes
            setInterval(() => {
                CRMSuperadmin.refreshDashboard();
            }, 300000);
        });
    </script>
</body>
</html>