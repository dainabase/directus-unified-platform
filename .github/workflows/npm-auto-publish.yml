name: Auto NPM Publish

on:
  push:
    tags:
      - 'v*'
      - 'ui-v*'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run (no actual publish)'
        required: false
        type: boolean
        default: false

jobs:
  auto-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
      
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            VERSION=${VERSION#v}  # Remove v prefix if present
            VERSION=${VERSION#ui-v}  # Remove ui-v prefix if present
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is-tag=true" >> $GITHUB_OUTPUT
          else
            echo "version=0.0.0-dev" >> $GITHUB_OUTPUT
            echo "is-tag=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run tests
        run: |
          cd packages/ui
          pnpm test:coverage
          
          # Check minimum coverage
          COVERAGE=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
          echo "ðŸ“Š Coverage: ${COVERAGE}%"
          
          if (( $(echo "$COVERAGE < 30" | bc -l) )); then
            echo "âŒ Coverage too low for auto-publish"
            exit 1
          fi
      
      - name: Build package
        run: |
          cd packages/ui
          pnpm build
          
          # Check bundle size
          BUNDLE_SIZE=$(du -sk dist | cut -f1)
          echo "ðŸ“¦ Bundle size: ${BUNDLE_SIZE}KB"
          
          if [ "$BUNDLE_SIZE" -gt 100 ]; then
            echo "âš ï¸ Warning: Bundle size exceeds 100KB"
          fi
      
      - name: Update package version
        if: steps.version.outputs.is-tag == 'true'
        run: |
          cd packages/ui
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version
      
      - name: Generate changelog
        id: changelog
        run: |
          echo "## ðŸ“ Changelog for v${{ steps.version.outputs.version }}" > CHANGELOG_TEMP.md
          echo "" >> CHANGELOG_TEMP.md
          
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            echo "### Changes since $LAST_TAG" >> CHANGELOG_TEMP.md
            git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG_TEMP.md
          else
            echo "### Initial Release" >> CHANGELOG_TEMP.md
            git log --pretty=format:"- %s (%h)" -10 >> CHANGELOG_TEMP.md
          fi
          
          echo "" >> CHANGELOG_TEMP.md
          cat CHANGELOG_TEMP.md >> $GITHUB_STEP_SUMMARY
      
      - name: Publish to NPM
        if: github.event.inputs.dry-run != 'true'
        run: |
          cd packages/ui
          
          # Determine publish tag
          VERSION="${{ steps.version.outputs.version }}"
          if [[ "$VERSION" == *"beta"* ]]; then
            TAG="beta"
          elif [[ "$VERSION" == *"alpha"* ]]; then
            TAG="alpha"
          elif [[ "$VERSION" == *"rc"* ]]; then
            TAG="next"
          else
            TAG="latest"
          fi
          
          echo "ðŸ“¦ Publishing version $VERSION with tag: $TAG"
          
          # Configure auth
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
          
          # Publish with provenance
          npm publish --tag $TAG --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Dry run summary
        if: github.event.inputs.dry-run == 'true'
        run: |
          echo "## ðŸ§ª Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Would have published:" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Package: @dainabase/ui" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All checks passed, ready to publish!" >> $GITHUB_STEP_SUMMARY
      
      - name: Create GitHub Release
        if: steps.version.outputs.is-tag == 'true' && github.event.inputs.dry-run != 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: "@dainabase/ui v${{ steps.version.outputs.version }}"
          body_path: CHANGELOG_TEMP.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') }}
      
      - name: Success notification
        if: success() && github.event.inputs.dry-run != 'true'
        run: |
          echo "## ðŸŽ‰ Successfully Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: [@dainabase/ui](https://www.npmjs.com/package/@dainabase/ui)" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Install**: \`npm install @dainabase/ui@${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
