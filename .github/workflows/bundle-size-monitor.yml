name: Bundle Size Monitor

on:
  push:
    branches: [main]
    paths:
      - 'packages/ui/**'
      - '.github/workflows/bundle-size-monitor.yml'
  pull_request:
    branches: [main]
    paths:
      - 'packages/ui/**'
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        required: false
        default: 'false'

jobs:
  check-bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          cd packages/ui
          npm ci
          
      - name: Build and analyze bundle
        id: build
        run: |
          cd packages/ui
          
          # Build the package
          npm run build
          
          # Get bundle sizes
          CORE_SIZE=$(find dist -name "index.js" -o -name "index.mjs" | xargs du -b | awk '{sum+=$1} END {print sum}')
          TOTAL_SIZE=$(find dist -name "*.js" -o -name "*.mjs" | xargs du -b | awk '{sum+=$1} END {print sum}')
          
          # Convert to KB
          CORE_KB=$((CORE_SIZE / 1024))
          TOTAL_KB=$((TOTAL_SIZE / 1024))
          
          echo "Core bundle size: ${CORE_KB}KB"
          echo "Total size (with lazy chunks): ${TOTAL_KB}KB"
          
          # Set outputs
          echo "core_size=${CORE_KB}" >> $GITHUB_OUTPUT
          echo "total_size=${TOTAL_KB}" >> $GITHUB_OUTPUT
          
          # Check if core exceeds limit
          if [ $CORE_KB -gt 40 ]; then
            echo "::error::Core bundle size (${CORE_KB}KB) exceeds 40KB limit!"
            exit 1
          fi
          
          # Warning if approaching limit
          if [ $CORE_KB -gt 35 ]; then
            echo "::warning::Core bundle size (${CORE_KB}KB) is approaching 40KB limit!"
          fi
          
      - name: Generate bundle report
        if: always()
        run: |
          cd packages/ui
          
          # Create detailed report
          echo "# ðŸ“Š Bundle Size Report" > bundle-report.md
          echo "" >> bundle-report.md
          echo "## Core Bundle" >> bundle-report.md
          echo "- **Size**: ${{ steps.build.outputs.core_size }}KB / 40KB" >> bundle-report.md
          echo "- **Status**: $([ ${{ steps.build.outputs.core_size }} -le 40 ] && echo 'âœ… PASS' || echo 'ðŸ”´ FAIL')" >> bundle-report.md
          echo "" >> bundle-report.md
          echo "## Bundle Breakdown" >> bundle-report.md
          echo "\`\`\`" >> bundle-report.md
          find dist -name "*.js" -o -name "*.mjs" | xargs du -h | sort -hr | head -20 >> bundle-report.md
          echo "\`\`\`" >> bundle-report.md
          echo "" >> bundle-report.md
          echo "## Optimization Suggestions" >> bundle-report.md
          
          if [ ${{ steps.build.outputs.core_size }} -gt 40 ]; then
            echo "ðŸ”´ **URGENT**: Core bundle exceeds 40KB limit!" >> bundle-report.md
            echo "- Move more components to lazy bundles" >> bundle-report.md
            echo "- Review dependencies in core exports" >> bundle-report.md
            echo "- Check for unintended imports" >> bundle-report.md
          elif [ ${{ steps.build.outputs.core_size }} -gt 35 ]; then
            echo "ðŸŸ¡ **WARNING**: Approaching 40KB limit" >> bundle-report.md
            echo "- Consider optimizing current core components" >> bundle-report.md
            echo "- Review tree-shaking effectiveness" >> bundle-report.md
          else
            echo "âœ… **EXCELLENT**: Bundle size is optimal" >> bundle-report.md
            echo "- Core bundle is under target" >> bundle-report.md
            echo "- Lazy loading strategy is working" >> bundle-report.md
          fi
          
          echo "" >> bundle-report.md
          echo "---" >> bundle-report.md
          echo "*Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> bundle-report.md
          
      - name: Upload bundle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-report
          path: packages/ui/bundle-report.md
          
      - name: Comment PR with bundle size
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('packages/ui/bundle-report.md', 'utf8');
            
            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Bundle Size Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }
            
      - name: Update status badge
        if: github.ref == 'refs/heads/main' && always()
        run: |
          CORE_SIZE="${{ steps.build.outputs.core_size }}"
          COLOR="green"
          
          if [ $CORE_SIZE -gt 40 ]; then
            COLOR="red"
          elif [ $CORE_SIZE -gt 35 ]; then
            COLOR="yellow"
          fi
          
          # This would update a status badge in README or documentation
          echo "Bundle size: ${CORE_SIZE}KB - Color: ${COLOR}"
          
      - name: Fail if bundle too large
        if: steps.build.outputs.core_size > 40
        run: |
          echo "ðŸ”´ Build failed: Core bundle size exceeds 40KB limit!"
          echo "Current size: ${{ steps.build.outputs.core_size }}KB"
          echo "Please optimize imports or move components to lazy bundles."
          exit 1
