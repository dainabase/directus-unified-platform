name: NPM Release - @dainabase/ui

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (no actual publish)'
        required: false
        default: true
        type: boolean
  push:
    tags:
      - 'ui-v*'
      - 'v*'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  release-checks:
    name: Pre-Release Verification
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Get package version
        id: version
        run: |
          cd packages/ui
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Package version: $VERSION"
      
      - name: Run tests
        run: |
          cd packages/ui
          pnpm test:ci
      
      - name: Check test coverage
        run: |
          cd packages/ui
          pnpm test:coverage
          COVERAGE=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
          echo "ðŸ“Š Test coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "âŒ Coverage below 90% threshold"
            exit 1
          fi
      
      - name: Build package
        run: |
          cd packages/ui
          pnpm build:optimized
      
      - name: Check bundle size
        run: |
          cd packages/ui
          BUNDLE_SIZE=$(du -b dist/index.js | cut -f1)
          BUNDLE_KB=$((BUNDLE_SIZE / 1024))
          echo "ðŸ“¦ Bundle size: ${BUNDLE_KB}KB"
          if [ $BUNDLE_KB -gt 40 ]; then
            echo "âŒ Bundle exceeds 40KB limit"
            exit 1
          fi
      
      - name: Run security audit
        run: |
          cd packages/ui
          pnpm audit --production --audit-level=high || true
      
      - name: Lint check
        run: |
          cd packages/ui
          pnpm lint
      
      - name: Type check
        run: |
          cd packages/ui
          pnpm type-check
      
      - name: Run pre-release script
        run: |
          cd packages/ui
          node scripts/pre-release-check.js

  npm-publish:
    name: Publish to NPM
    needs: release-checks
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Setup Node with NPM registry
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
          scope: '@dainabase'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build final package
        run: |
          cd packages/ui
          pnpm clean
          pnpm build:optimized
      
      - name: Configure NPM
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          npm whoami
      
      - name: Publish to NPM
        run: |
          cd packages/ui
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Verify publication
        run: |
          sleep 10
          npm view @dainabase/ui@${{ needs.release-checks.outputs.version }}

  github-release:
    name: Create GitHub Release
    needs: [release-checks, npm-publish]
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: Install and build
        run: |
          pnpm install --frozen-lockfile
          cd packages/ui
          pnpm build:optimized
      
      - name: Create package tarball
        run: |
          cd packages/ui
          npm pack
          mv *.tgz dainabase-ui-${{ needs.release-checks.outputs.version }}.tgz
      
      - name: Generate release notes
        id: notes
        run: |
          VERSION=${{ needs.release-checks.outputs.version }}
          echo "# Release Notes for v${VERSION}" > release-notes.md
          echo "" >> release-notes.md
          cat packages/ui/RELEASE_NOTES_v${VERSION}.md >> release-notes.md 2>/dev/null || echo "See CHANGELOG.md for details" >> release-notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.release-checks.outputs.version }}
          name: "@dainabase/ui v${{ needs.release-checks.outputs.version }}"
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            packages/ui/dainabase-ui-${{ needs.release-checks.outputs.version }}.tgz
            packages/ui/dist/index.js
            packages/ui/dist/index.d.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post-release:
    name: Post-Release Tasks
    needs: [release-checks, npm-publish, github-release]
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Update documentation
        run: |
          echo "ðŸ“š Documentation update triggered"
          # Trigger docs deployment workflow if exists
      
      - name: Notify Discord
        if: secrets.DISCORD_WEBHOOK
        run: |
          VERSION=${{ needs.release-checks.outputs.version }}
          curl -X POST ${{ secrets.DISCORD_WEBHOOK }} \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ðŸš€ @dainabase/ui v'${VERSION}' Released!",
                "description": "A new version has been published to NPM",
                "color": 5814783,
                "fields": [
                  {
                    "name": "Version",
                    "value": "'${VERSION}'",
                    "inline": true
                  },
                  {
                    "name": "NPM",
                    "value": "[View Package](https://www.npmjs.com/package/@dainabase/ui)",
                    "inline": true
                  },
                  {
                    "name": "GitHub",
                    "value": "[Release Notes](https://github.com/dainabase/directus-unified-platform/releases/tag/v'${VERSION}')",
                    "inline": true
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
      
      - name: Create success summary
        run: |
          VERSION=${{ needs.release-checks.outputs.version }}
          echo "## ðŸŽ‰ Release Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### @dainabase/ui v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NPM Package Published" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Release Created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Documentation Updated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Team Notified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [NPM Package](https://www.npmjs.com/package/@dainabase/ui/v/${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/dainabase/directus-unified-platform/releases/tag/v${VERSION})" >> $GITHUB_STEP_SUMMARY

  dry-run:
    name: Dry Run Report
    needs: release-checks
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run == 'true'
    
    steps:
      - name: Generate dry run report
        run: |
          echo "## ðŸ§ª Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pre-Release Checks âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ needs.release-checks.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage threshold met" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle size within limits" >> $GITHUB_STEP_SUMMARY
          echo "- Security audit passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "To publish for real, run this workflow again with:" >> $GITHUB_STEP_SUMMARY
          echo "- Dry run: `false`" >> $GITHUB_STEP_SUMMARY
          echo "- Release type: `${{ github.event.inputs.release_type }}`" >> $GITHUB_STEP_SUMMARY