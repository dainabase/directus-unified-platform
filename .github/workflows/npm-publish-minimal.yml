name: NPM Publish - Ultra Minimal

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode'
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: Checkout only the UI package
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            packages/ui
          sparse-checkout-cone-mode: false
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'
      
      - name: Minimal build setup
        working-directory: packages/ui
        run: |
          echo "ðŸ”¥ DELETING ALL THE CRAP..."
          rm -rf node_modules package-lock.json
          
          echo "ðŸ“¦ Installing ONLY what we need..."
          npm install --no-save \
            typescript \
            tsup \
            @types/react \
            @types/react-dom \
            react \
            react-dom \
            tailwind-merge \
            clsx \
            class-variance-authority \
            @radix-ui/react-slot \
            @radix-ui/react-primitive
          
          echo "ðŸ”¨ Building with tsup directly..."
          npx tsup src/index.ts \
            --format cjs,esm \
            --dts \
            --external react \
            --external react-dom \
            --minify \
            --clean \
            --outDir dist
          
          echo "âœ… Build done!"
          
      - name: Check output
        working-directory: packages/ui
        run: |
          echo "ðŸ“Š What we got:"
          ls -la dist/
          
      - name: Configure npm
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          
      - name: Force publish
        working-directory: packages/ui
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Remove all scripts to avoid any pre-publish hooks
          npm pkg delete scripts.prepublishOnly
          npm pkg delete scripts.prepare
          npm pkg delete scripts.prepack
          
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ðŸš€ Dry run..."
            npm publish --dry-run --access public
          else
            echo "ðŸš€ YOLO Publishing..."
            npm publish --access public --force
            echo "âœ… DONE! Check: https://www.npmjs.com/package/@dainabase/ui"
          fi
