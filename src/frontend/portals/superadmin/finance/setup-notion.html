<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Notion - OCR Vision AI</title>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">
</head>
<body>
    <div class="page">
        <div class="page-wrapper">
            <div class="page-body">
                <div class="container-xl">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">üöÄ Configuration automatique Notion</h3>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-success">
                                        <h4 class="alert-title">‚úÖ Cl√© d'int√©gration configur√©e!</h4>
                                        <p>Votre cl√© Notion a √©t√© enregistr√©e dans le syst√®me.</p>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h4>√âtat de la configuration</h4>
                                        <div class="list-group">
                                            <div class="list-group-item">
                                                <div class="row align-items-center">
                                                    <div class="col-auto">
                                                        <span class="badge bg-success">‚úì</span>
                                                    </div>
                                                    <div class="col">
                                                        <div class="text-body">Cl√© d'int√©gration</div>
                                                        <div class="text-muted small">ntn_4663...41Yx (masqu√©e)</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="list-group-item">
                                                <div class="row align-items-center">
                                                    <div class="col-auto">
                                                        <span class="badge bg-warning" id="proxy-status">?</span>
                                                    </div>
                                                    <div class="col">
                                                        <div class="text-body">Proxy PHP</div>
                                                        <div class="text-muted small" id="proxy-message">V√©rification en cours...</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="list-group-item">
                                                <div class="row align-items-center">
                                                    <div class="col-auto">
                                                        <span class="badge bg-secondary" id="db-status">-</span>
                                                    </div>
                                                    <div class="col">
                                                        <div class="text-body">Databases Notion</div>
                                                        <div class="text-muted small" id="db-message">Non v√©rifi√©</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h4>Actions</h4>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button class="btn btn-primary" onclick="testConnection()">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2"/>
                                                    <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/>
                                                    <path d="M14 4l0 4l-6 0l0 -4"/>
                                                </svg>
                                                Tester la connexion
                                            </button>
                                            
                                            <button class="btn btn-success" onclick="verifyDatabases()">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M12 6c-2.824 0 -5.329 .5 -6.999 1.28a1 1 0 0 0 -.001 1.44c1.67 .78 4.175 1.28 6.999 1.28s5.329 -.5 6.999 -1.28a1 1 0 0 0 .001 -1.44c-1.67 -.78 -4.175 -1.28 -6.999 -1.28z"/>
                                                    <path d="M5 7.72v4.56c0 1.44 3.134 2.72 7 2.72s7 -1.28 7 -2.72v-4.56"/>
                                                    <path d="M5 12.28v4.44c0 1.44 3.134 2.28 7 2.28s7 -.84 7 -2.28v-4.44"/>
                                                </svg>
                                                V√©rifier les databases
                                            </button>
                                            
                                            <a href="ocr-premium-dashboard.html" class="btn btn-outline-primary">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M9 11l-4 4l4 4m-4 -4h11a4 4 0 0 0 0 -8h-1"/>
                                                </svg>
                                                Retour √† l'OCR
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div id="test-results"></div>
                                    
                                    <hr class="my-4">
                                    
                                    <div class="alert alert-info">
                                        <h4 class="alert-title">üìã Prochaines √©tapes</h4>
                                        <ol class="mb-0">
                                            <li><strong>Partagez vos databases</strong> avec l'int√©gration dans Notion:
                                                <ul>
                                                    <li>Ouvrez chaque database dans Notion</li>
                                                    <li>Cliquez sur "Share" en haut √† droite</li>
                                                    <li>Invitez votre int√©gration</li>
                                                </ul>
                                            </li>
                                            <li><strong>D√©ployez le proxy PHP</strong> sur votre serveur (si pas encore fait)</li>
                                            <li><strong>Testez l'envoi</strong> d'un document depuis l'interface OCR</li>
                                        </ol>
                                    </div>
                                    
                                    <details class="mt-4">
                                        <summary class="cursor-pointer text-muted">Configuration avanc√©e</summary>
                                        <div class="mt-3">
                                            <pre class="bg-dark text-white p-3 rounded"><code>// Cl√© stock√©e dans localStorage
localStorage.setItem('notion_api_key', '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');

// Fichier de config PHP (optionnel)
// api/config-notion.php contient la cl√© pour le serveur</code></pre>
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
    <script src="../../assets/js/Superadmin/ocr-templates-final.js"></script>
    
    <script>
        // Stocker automatiquement la cl√©
        const NOTION_KEY = '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';
        localStorage.setItem('notion_api_key', NOTION_KEY);
        
        // V√©rifier le proxy au chargement
        document.addEventListener('DOMContentLoaded', () => {
            checkProxyStatus();
        });
        
        async function checkProxyStatus() {
            const statusBadge = document.getElementById('proxy-status');
            const messageDiv = document.getElementById('proxy-message');
            
            try {
                const response = await fetch('/api/notion-proxy.php', {
                    method: 'OPTIONS'
                });
                
                if (response.ok) {
                    statusBadge.textContent = '‚úì';
                    statusBadge.className = 'badge bg-success';
                    messageDiv.textContent = 'Proxy accessible';
                } else {
                    throw new Error('Proxy non accessible');
                }
            } catch (error) {
                statusBadge.textContent = '‚úó';
                statusBadge.className = 'badge bg-danger';
                messageDiv.textContent = 'Proxy non d√©ploy√© - Mode simulation actif';
            }
        }
        
        async function testConnection() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<div class="spinner-border"></div> Test en cours...';
            
            try {
                const response = await fetch('/api/notion-proxy.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'get_databases',
                        api_key: NOTION_KEY
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h4 class="alert-title">‚úÖ Connexion r√©ussie!</h4>
                            <p>${data.results?.length || 0} databases trouv√©es dans votre workspace Notion.</p>
                        </div>
                    `;
                    
                    // Mettre √† jour le statut
                    document.getElementById('db-status').textContent = '‚úì';
                    document.getElementById('db-status').className = 'badge bg-success';
                    document.getElementById('db-message').textContent = `${data.results?.length || 0} databases accessibles`;
                } else {
                    throw new Error(data.error || 'Erreur de connexion');
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h4 class="alert-title">‚ùå Erreur de connexion</h4>
                        <p>${error.message}</p>
                        ${error.message.includes('Failed to fetch') ? '<p>Assurez-vous que le proxy PHP est d√©ploy√© sur votre serveur.</p>' : ''}
                    </div>
                `;
            }
        }
        
        async function verifyDatabases() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<div class="spinner-border"></div> V√©rification des databases...';
            
            try {
                let html = '<div class="table-responsive"><table class="table"><thead><tr><th>Type</th><th>Database</th><th>Statut</th></tr></thead><tbody>';
                let foundCount = 0;
                
                for (const [type, template] of Object.entries(DOCUMENT_TYPES)) {
                    try {
                        const response = await fetch('/api/notion-proxy.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                action: 'verify_database',
                                database_id: template.database_id,
                                api_key: NOTION_KEY
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.exists) {
                            foundCount++;
                            html += `<tr>
                                <td>${type}</td>
                                <td>${template.database_name}</td>
                                <td><span class="badge bg-success">‚úì Trouv√©e</span></td>
                            </tr>`;
                        } else {
                            html += `<tr>
                                <td>${type}</td>
                                <td>${template.database_name}</td>
                                <td><span class="badge bg-warning">‚ö† Non partag√©e</span></td>
                            </tr>`;
                        }
                    } catch (e) {
                        html += `<tr>
                            <td>${type}</td>
                            <td>${template.database_name}</td>
                            <td><span class="badge bg-danger">‚úó Erreur</span></td>
                        </tr>`;
                    }
                }
                
                html += '</tbody></table></div>';
                
                if (foundCount === 0) {
                    html = `
                        <div class="alert alert-warning">
                            <h4 class="alert-title">‚ö†Ô∏è Aucune database trouv√©e</h4>
                            <p>Assurez-vous de partager vos databases Notion avec l'int√©gration.</p>
                        </div>
                    ` + html;
                } else if (foundCount === Object.keys(DOCUMENT_TYPES).length) {
                    html = `
                        <div class="alert alert-success">
                            <h4 class="alert-title">‚úÖ Toutes les databases sont accessibles!</h4>
                        </div>
                    ` + html;
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h4 class="alert-title">‚ùå Erreur</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>