<!DOCTYPE html>
<html>
<head>
    <title>Test API Direct</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #666;
            margin-top: 30px;
        }
        pre {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .loading {
            color: orange;
        }
        .stats {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Test Directus API Direct</h1>
    <div id="status" class="loading">‚è≥ Chargement...</div>
    <div id="results"></div>
    
    <script>
        const API_URL = 'http://localhost:8055';
        const TOKEN = 'dashboard-api-token-2025';
        
        async function testAPI() {
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            
            try {
                // Test projects
                statusEl.innerHTML = '<span class="loading">‚è≥ Chargement des projets...</span>';
                const projectsRes = await fetch(`${API_URL}/items/projects?limit=10`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const projects = await projectsRes.json();
                
                // Test invoices
                statusEl.innerHTML = '<span class="loading">‚è≥ Chargement des factures...</span>';
                const invoicesRes = await fetch(`${API_URL}/items/client_invoices?limit=10`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const invoices = await invoicesRes.json();
                
                // Test companies
                statusEl.innerHTML = '<span class="loading">‚è≥ Chargement des entreprises...</span>';
                const companiesRes = await fetch(`${API_URL}/items/companies?limit=10`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const companies = await companiesRes.json();
                
                // Test bank transactions
                statusEl.innerHTML = '<span class="loading">‚è≥ Chargement des transactions...</span>';
                const transactionsRes = await fetch(`${API_URL}/items/bank_transactions?limit=10`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const transactions = await transactionsRes.json();
                
                // Calculer des stats
                const totalProjects = projects.data?.length || 0;
                const totalInvoices = invoices.data?.length || 0;
                const totalRevenue = invoices.data?.reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0) || 0;
                const totalBalance = transactions.data?.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0) || 0;
                
                // Compter par entreprise
                const projectsByCompany = {};
                projects.data?.forEach(p => {
                    const company = p.owner_company || 'Sans entreprise';
                    projectsByCompany[company] = (projectsByCompany[company] || 0) + 1;
                });
                
                statusEl.innerHTML = '<span class="success">‚úÖ API connect√©e avec succ√®s !</span>';
                
                resultsEl.innerHTML = `
                    <div class="stats">
                        <h3>üìä Statistiques</h3>
                        <p>Total projets: <strong>${totalProjects}</strong></p>
                        <p>Total factures: <strong>${totalInvoices}</strong></p>
                        <p>Revenue (10 factures): <strong>${totalRevenue.toLocaleString()} CHF</strong></p>
                        <p>Balance (10 transactions): <strong>${totalBalance.toLocaleString()} CHF</strong></p>
                    </div>
                    
                    <div class="stats">
                        <h3>üè¢ Projets par entreprise</h3>
                        ${Object.entries(projectsByCompany).map(([company, count]) => 
                            `<p>${company}: <strong>${count}</strong></p>`
                        ).join('')}
                    </div>
                    
                    <h2>Projects (${totalProjects})</h2>
                    <pre>${JSON.stringify(projects.data, null, 2)}</pre>
                    
                    <h2>Invoices (${totalInvoices})</h2>
                    <pre>${JSON.stringify(invoices.data, null, 2)}</pre>
                    
                    <h2>Companies</h2>
                    <pre>${JSON.stringify(companies.data, null, 2)}</pre>
                    
                    <h2>Transactions bancaires</h2>
                    <pre>${JSON.stringify(transactions.data, null, 2)}</pre>
                `;
            } catch (error) {
                statusEl.innerHTML = `<span class="error">‚ùå Erreur: ${error.message}</span>`;
                resultsEl.innerHTML = `<pre class="error">${error.stack}</pre>`;
            }
        }
        
        // Lancer le test au chargement
        testAPI();
    </script>
</body>
</html>