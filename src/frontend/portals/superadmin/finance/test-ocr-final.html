<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test OCR Final - V√©rification compl√®te</title>
    <link href="../../assets/css/tabler.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">
</head>
<body>
    <div class="page">
        <div class="page-wrapper">
            <div class="page-body">
                <div class="container-xl">
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Test OCR Final - Checklist de validation</h3>
                                </div>
                                <div class="card-body">
                                    <h4>‚úÖ V√©rifications du syst√®me OCR</h4>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-vcenter">
                                            <thead>
                                                <tr>
                                                    <th>Composant</th>
                                                    <th>Statut</th>
                                                    <th>Description</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Cl√© API OpenAI</td>
                                                    <td id="api-status">
                                                        <span class="badge bg-secondary">Non configur√©</span>
                                                    </td>
                                                    <td>Cl√© API pour GPT-4 Vision</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-primary" onclick="configureAPI()">Configurer</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>PDF.js</td>
                                                    <td id="pdfjs-status">
                                                        <span class="badge bg-secondary">Non charg√©</span>
                                                    </td>
                                                    <td>Biblioth√®que de conversion PDF</td>
                                                    <td>-</td>
                                                </tr>
                                                <tr>
                                                    <td>Templates Notion</td>
                                                    <td id="templates-status">
                                                        <span class="badge bg-secondary">Non charg√©</span>
                                                    </td>
                                                    <td>6 templates de documents</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" onclick="listTemplates()">Lister</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Interface OCR</td>
                                                    <td id="interface-status">
                                                        <span class="badge bg-secondary">Non initialis√©</span>
                                                    </td>
                                                    <td>Interface principale</td>
                                                    <td>
                                                        <a href="ocr-upload.html" class="btn btn-sm btn-success">Ouvrir</a>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h4>üìä Templates disponibles</h4>
                                        <div id="templates-list" class="row g-3"></div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h4>üß™ Test rapide</h4>
                                        <div class="alert alert-info">
                                            <h5 class="alert-title">Instructions de test</h5>
                                            <ol class="mb-0">
                                                <li>Configurez votre cl√© API OpenAI</li>
                                                <li>Configurez votre cl√© API Notion</li>
                                                <li>Ouvrez l'interface OCR</li>
                                                <li>Glissez un document (facture, note de frais, contrat)</li>
                                                <li>V√©rifiez que l'extraction d√©tecte le bon type</li>
                                                <li>Validez les donn√©es dans le formulaire</li>
                                                <li>Testez l'envoi vers Notion</li>
                                            </ol>
                                        </div>
                                        <div class="mt-3 d-flex gap-2">
                                            <a href="test-ocr-complete.html" class="btn btn-primary">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 4v16l13 -8z"/></svg>
                                                Test Complet Int√©gration
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h4>üìù Prompt utilis√© (Version am√©lior√©e)</h4>
                                        <pre class="bg-dark text-white p-3 rounded" style="font-size: 0.8rem; max-height: 300px; overflow-y: auto;">
Vous √™tes un expert comptable suisse sp√©cialis√© dans l'analyse de documents financiers.

ANALYSEZ CE DOCUMENT avec une PR√âCISION MAXIMALE et extrayez TOUTES les informations suivantes :

üîç IDENTIFICATION √âMETTEUR/DESTINATAIRE :
- Nom complet de l'entreprise √©mettrice (soci√©t√© qui facture)
- Adresse compl√®te √©mettrice (rue, ville, pays, CP)
- Num√©ro SIRET/TVA/IDE √©metteur si visible
- Nom complet du client/destinataire
- Adresse compl√®te destinataire
- Contact (email, t√©l√©phone) si visible

üí∞ INFORMATIONS FINANCI√àRES :
- Num√©ro de facture/document (format exact)
- Date d'√©mission (format JJ/MM/AAAA)
- Date d'√©ch√©ance si mentionn√©e
- Montant hors taxes (HT) avec devise
- Taux de TVA appliqu√© (%, exemple: 8.1%, 20%)
- Montant TVA en valeur absolue
- Montant toutes taxes comprises (TTC) avec devise
- Mode de paiement mentionn√©
- R√©f√©rences bancaires si pr√©sentes

üìÑ D√âTAILS SERVICES/PRODUITS :
- Description d√©taill√©e des services/produits
- Quantit√©s et unit√©s si applicable
- Prix unitaires si d√©taill√©s
- Remises ou ajustements
- P√©riode de facturation si mentionn√©e

üè¢ CLASSIFICATION AUTOMATIQUE :
D√©terminez le type selon ces r√®gles EXACTES :
- Si √âMETTEUR = "HYPERVISUAL" ou "DAINAMICS" ou "ENKI REALITY" ou "TAKEOUT" ou "LEXAIA" ‚Üí FACTURE_CLIENT
- Si DESTINATAIRE = une de ces entit√©s ‚Üí FACTURE_FOURNISSEUR
- Si contient "restaurant", "taxi", "h√¥tel", "transport", "essence", "repas" ‚Üí NOTE_FRAIS
- Si contient "contrat", "agreement", "accord", "convention" ‚Üí CONTRAT
- Sinon ‚Üí DOCUMENT_GENERAL

‚ö†Ô∏è EXIGENCES CRITIQUES :
1. Si une information n'est pas visible, mettez "NON_VISIBLE"
2. Pour les montants, incluez TOUJOURS la devise (CHF, EUR, USD)
3. Pour les dates, format OBLIGATOIRE : YYYY-MM-DD
4. Soyez EXHAUSTIF : cherchez dans TOUS les coins du document
5. Si le document est flou/illisible, indiquez "ILLEGIBLE" pour les champs concern√©s

R√âPONSE OBLIGATOIRE EN JSON :
{
  "document_type": "TYPE_D√âTECT√â",
  "confidence": 0.XX,
  "document_quality": "EXCELLENT|BON|MOYEN|ILLISIBLE",
  "extracted_data": {
    "numero_document": "valeur exacte ou NON_VISIBLE",
    "emetteur": {
      "nom": "nom complet",
      "adresse": "adresse compl√®te",
      "siret_tva": "num√©ro ou NON_VISIBLE"
    },
    "destinataire": {
      "nom": "nom complet",
      "adresse": "adresse compl√®te"
    },
    "dates": {
      "emission": "YYYY-MM-DD ou NON_VISIBLE",
      "echeance": "YYYY-MM-DD ou NON_VISIBLE"
    },
    "montants": {
      "ht": "montant avec devise ou NON_VISIBLE",
      "tva_taux": "XX% ou NON_VISIBLE",
      "tva_montant": "montant avec devise ou NON_VISIBLE", 
      "ttc": "montant avec devise"
    },
    "services": {
      "description": "description compl√®te",
      "periode": "p√©riode si mentionn√©e ou NON_VISIBLE"
    },
    "paiement": {
      "mode": "mode mentionn√© ou NON_VISIBLE",
      "iban": "IBAN si visible ou NON_VISIBLE"
    },
    "autres_infos": "toutes autres informations importantes visibles"
  },
  "zones_illisibles": ["liste des zones floues/illisibles"],
  "suggestions_amelioration": "suggestions si document de mauvaise qualit√©"
}

EXTRAYEZ ABSOLUMENT TOUT CE QUI EST LISIBLE. Soyez un d√©tective financier !
                                        </pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="../../assets/js/tabler.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="../../assets/js/Superadmin/ocr-templates-final.js"></script>
    <script src="../../assets/js/Superadmin/ocr-vision-final.js"></script>
    <script src="../../assets/js/Superadmin/ocr-interface-final.js"></script>
    
    <script>
        // V√©rifications au chargement
        document.addEventListener('DOMContentLoaded', () => {
            // API Key
            const apiKey = localStorage.getItem('openai_api_key');
            if (apiKey) {
                document.getElementById('api-status').innerHTML = '<span class="badge bg-success">Configur√©</span>';
            }
            
            // PDF.js
            if (typeof pdfjsLib !== 'undefined') {
                document.getElementById('pdfjs-status').innerHTML = '<span class="badge bg-success">Charg√©</span>';
            }
            
            // Templates
            if (typeof DOCUMENT_TYPES !== 'undefined') {
                document.getElementById('templates-status').innerHTML = '<span class="badge bg-success">6 templates charg√©s</span>';
            }
            
            // Interface
            if (typeof OCRInterfaceFinal !== 'undefined') {
                document.getElementById('interface-status').innerHTML = '<span class="badge bg-success">Pr√™t</span>';
            }
        });
        
        function configureAPI() {
            const apiKey = prompt('Entrez votre cl√© API OpenAI:');
            if (apiKey && apiKey.startsWith('sk-')) {
                localStorage.setItem('openai_api_key', apiKey);
                document.getElementById('api-status').innerHTML = '<span class="badge bg-success">Configur√©</span>';
                alert('Cl√© API sauvegard√©e!');
            }
        }
        
        function listTemplates() {
            const container = document.getElementById('templates-list');
            container.innerHTML = '';
            
            for (const [type, template] of Object.entries(DOCUMENT_TYPES)) {
                const card = `
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${type}</h5>
                                <p class="text-muted small">${template.database_name}</p>
                                <p class="mb-2"><strong>Champs:</strong> ${template.fields.length}</p>
                                <p class="mb-0"><small class="text-muted">ID: ${template.database_id}</small></p>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            }
        }
    </script>
</body>
</html>