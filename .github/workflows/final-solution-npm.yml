name: FINAL SOLUTION - NPM PUBLISH

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Mode'
        required: true
        default: 'test'
        type: choice
        options:
          - 'test'
          - 'publish'

jobs:
  final-build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Complete Fix and Build
        working-directory: packages/ui
        run: |
          echo "ðŸ§¹ Starting final solution..."
          
          # Clean everything
          rm -rf node_modules dist package-lock.json
          
          # Install all dependencies with force
          echo "ðŸ“¦ Installing dependencies..."
          npm install --force --legacy-peer-deps
          
          # Create optimized tsconfig
          echo "âš™ï¸ Creating optimized TypeScript config..."
          cat > tsconfig.json << 'EOF'
          {
            "compilerOptions": {
              "target": "ES2020",
              "module": "ESNext",
              "lib": ["ES2020", "DOM", "DOM.Iterable"],
              "jsx": "react-jsx",
              "declaration": true,
              "declarationMap": true,
              "outDir": "./dist",
              "rootDir": "./src",
              "strict": true,
              "noUnusedLocals": false,
              "noUnusedParameters": false,
              "noImplicitReturns": false,
              "noFallthroughCasesInSwitch": true,
              "esModuleInterop": true,
              "skipLibCheck": true,
              "allowSyntheticDefaultImports": true,
              "forceConsistentCasingInFileNames": true,
              "moduleResolution": "node",
              "resolveJsonModule": true,
              "isolatedModules": true,
              "noEmit": false
            },
            "include": ["src/**/*"],
            "exclude": ["node_modules", "dist", "**/*.test.*", "**/*.stories.*", "**/*.spec.*"]
          }
          EOF
          
          # Update tsup config for better compatibility
          echo "âš™ï¸ Updating tsup config..."
          cat > tsup.config.ts << 'EOF'
          import { defineConfig } from 'tsup'
          
          export default defineConfig({
            entry: ['src/index.ts'],
            format: ['cjs', 'esm'],
            dts: {
              resolve: true,
              entry: './src/index.ts'
            },
            splitting: false,
            sourcemap: true,
            clean: true,
            external: ['react', 'react-dom'],
            noExternal: [
              '@radix-ui/*',
              'class-variance-authority',
              'clsx',
              'tailwind-merge'
            ],
            minify: true,
            treeshake: true,
            target: 'es2020',
            platform: 'browser',
            esbuildOptions(options) {
              options.jsx = 'automatic'
            }
          })
          EOF
          
          # Build the package
          echo "ðŸ—ï¸ Building package..."
          npm run build || npx tsup --config tsup.config.ts
          
          # Verify build output
          echo "âœ… Verifying build output..."
          if [ -d "dist" ]; then
            echo "Build successful!"
            ls -la dist/
            echo "Bundle size: $(du -sh dist/)"
          else
            echo "Build failed - trying alternative method..."
            npx tsup src/index.ts --format cjs,esm --dts --external react --external react-dom --minify
          fi

      - name: Test Package
        if: github.event.inputs.mode == 'test'
        working-directory: packages/ui
        run: |
          echo "ðŸ§ª Testing package..."
          
          # Check if all required files exist
          if [ -f "dist/index.js" ] && [ -f "dist/index.mjs" ] && [ -f "dist/index.d.ts" ]; then
            echo "âœ… All required files present!"
            
            # Check bundle size
            BUNDLE_SIZE=$(du -b dist/index.js | cut -f1)
            BUNDLE_SIZE_KB=$((BUNDLE_SIZE / 1024))
            echo "ðŸ“¦ Bundle size: ${BUNDLE_SIZE_KB}KB"
            
            if [ $BUNDLE_SIZE_KB -gt 100 ]; then
              echo "âš ï¸ Warning: Bundle size exceeds 100KB (${BUNDLE_SIZE_KB}KB)"
            else
              echo "âœ… Bundle size is optimal (${BUNDLE_SIZE_KB}KB)"
            fi
            
            # Test import
            echo "Testing CommonJS import..."
            node -e "const ui = require('./dist/index.js'); console.log('âœ… CommonJS import works');"
            
            echo ""
            echo "ðŸŽ‰ Package is ready for publication!"
          else
            echo "âŒ Missing required files in dist/"
            ls -la dist/
            exit 1
          fi

      - name: Publish to NPM
        if: github.event.inputs.mode == 'publish'
        working-directory: packages/ui
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ðŸ“¤ Publishing to NPM..."
          
          # Update version if needed
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # Try to publish
          npm publish --access public || {
            echo "âš ï¸ Publish failed - trying with new version..."
            npm version patch
            npm publish --access public
          }
          
          echo "âœ… Package published successfully!"
          echo "View at: https://www.npmjs.com/package/@dainabase/ui"

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Final Solution Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            if [ "${{ github.event.inputs.mode }}" == "publish" ]; then
              echo "### âœ… Package Published!" >> $GITHUB_STEP_SUMMARY
              echo "NPM: https://www.npmjs.com/package/@dainabase/ui" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
              echo "Ready to publish. Run workflow again with mode='publish'" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for errors" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Workflow: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "Run: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY