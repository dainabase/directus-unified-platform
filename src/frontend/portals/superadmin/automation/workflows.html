<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Workflows n8n - SuperAdmin Dashboard</title>
    <!-- CSS files -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/icons-sprite.svg" rel="stylesheet"/>
    <link href="../../assets/css/custom.css" rel="stylesheet"/>
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"/>
    
    <!-- Mermaid pour visualisation workflows -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    
    <style>
        .role-superadmin { --tblr-primary: #2563eb; }
        .workflow-card { transition: all 0.3s ease; }
        .workflow-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .workflow-status-active { background: #10b981; }
        .workflow-status-inactive { background: #6b7280; }
        .workflow-status-error { background: #ef4444; }
        .workflow-diagram { background: #f8fafc; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .trigger-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
        .action-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .action-badge { background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; }
        .stats-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; }
        .stats-value { font-size: 2rem; font-weight: 600; color: #1f2937; }
        .stats-label { color: #6b7280; font-size: 0.875rem; }
        .execution-timeline { max-height: 400px; overflow-y: auto; }
        .execution-item { border-left: 3px solid #e5e7eb; padding-left: 1rem; margin-bottom: 1rem; }
        .execution-success { border-left-color: #10b981; }
        .execution-error { border-left-color: #ef4444; }
    </style>
</head>
<body class="layout-fluid role-superadmin">
    <script src="../../assets/js/demo-theme.js?1692870487"></script>
    
    <div class="page">
        <!-- Navbar -->
        <div id="navbar-container"></div>

        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <div class="page-wrapper">
            <!-- Page header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <div class="page-pretitle">
                                Automatisations
                            </div>
                            <h2 class="page-title">
                                ¡ Workflows n8n
                            </h2>
                            <div class="page-subtitle">
                                Gestion des processus automatisés
                            </div>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <a href="https://n8n.votredomaine.ch" target="_blank" class="btn btn-outline-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M11 7h-5a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-5"/>
                                        <path d="M10 14l10 -10"/>
                                        <path d="M15 4h5v5"/>
                                    </svg>
                                    Ouvrir n8n
                                </a>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createWorkflowModal">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Nouveau workflow
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page body -->
            <div class="page-body">
                <div class="container-xl">
                    
                    <!-- Statistiques -->
                    <div class="row row-cards mb-4">
                        <div class="col-sm-6 col-lg-3">
                            <div class="stats-card">
                                <div class="stats-value" id="active-workflows">0</div>
                                <div class="stats-label">Workflows actifs</div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="stats-card">
                                <div class="stats-value" id="executions-today">0</div>
                                <div class="stats-label">Exécutions aujourd'hui</div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="stats-card">
                                <div class="stats-value" id="success-rate">0%</div>
                                <div class="stats-label">Taux de succès</div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="stats-card">
                                <div class="stats-value text-danger" id="last-error-time">-</div>
                                <div class="stats-label">Dernière erreur</div>
                            </div>
                        </div>
                    </div>

                    <!-- Liste des workflows -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Workflows Automatisés</h3>
                            <div class="card-actions">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary active" data-filter="all">Tous</button>
                                    <button class="btn btn-sm btn-outline-primary" data-filter="active">Actifs</button>
                                    <button class="btn btn-sm btn-outline-primary" data-filter="inactive">Inactifs</button>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table" id="workflows-table">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Trigger</th>
                                        <th>Actions</th>
                                        <th>Dernière exécution</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="workflows-list">
                                    <!-- Workflows chargés dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Timeline des exécutions -->
                    <div class="row mt-4">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Diagramme du Workflow</h3>
                                </div>
                                <div class="card-body">
                                    <div id="workflow-diagram" class="workflow-diagram">
                                        <div class="mermaid">
                                            graph LR
                                            A[Trigger] --> B[Action 1]
                                            B --> C[Action 2]
                                            C --> D[Action 3]
                                            D --> E[Fin]
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Dernières Exécutions</h3>
                                </div>
                                <div class="card-body">
                                    <div class="execution-timeline" id="execution-timeline">
                                        <!-- Timeline chargée dynamiquement -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Création Workflow -->
    <div class="modal modal-blur fade" id="createWorkflowModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Créer un nouveau workflow</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="workflow-form">
                        <div class="mb-3">
                            <label class="form-label">Nom du workflow</label>
                            <input type="text" class="form-control" id="workflow-name" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Type de déclencheur</label>
                            <select class="form-select" id="workflow-trigger" required>
                                <option value="">Sélectionner un trigger</option>
                                <option value="webhook.notion.contact_created">Contact créé (Notion)</option>
                                <option value="webhook.revolut.transaction_matched">Paiement reçu (Revolut)</option>
                                <option value="cron.expression">Planifié (Cron)</option>
                                <option value="webhook.storage.file_uploaded">Fichier uploadé</option>
                                <option value="notion.property_changed">Propriété modifiée (Notion)</option>
                            </select>
                        </div>

                        <div class="mb-3" id="cron-config" style="display: none;">
                            <label class="form-label">Expression Cron</label>
                            <input type="text" class="form-control" id="workflow-schedule" placeholder="0 9 * * 1-5">
                            <div class="form-hint">Exemples: "0 9 * * 1-5" (9h en semaine), "0 18 L * *" (18h dernier jour du mois)</div>
                        </div>

                        <div class="mb-3" id="condition-config" style="display: none;">
                            <label class="form-label">Conditions</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" placeholder="Propriété" id="condition-property">
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="condition-operator">
                                        <option value="=">=</option>
                                        <option value="<"><</option>
                                        <option value=">">></option>
                                        <option value="contains">Contient</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" placeholder="Valeur" id="condition-value">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Actions à exécuter</label>
                            <div id="actions-list">
                                <div class="action-item mb-2">
                                    <div class="input-group">
                                        <select class="form-select action-type">
                                            <option value="">Sélectionner une action</option>
                                            <option value="notion.create">Créer dans Notion</option>
                                            <option value="notion.update">Mettre à jour Notion</option>
                                            <option value="email.send">Envoyer email</option>
                                            <option value="slack.notify">Notification Slack</option>
                                            <option value="report.generate">Générer rapport</option>
                                            <option value="ocr.process">Traiter OCR</option>
                                        </select>
                                        <button type="button" class="btn btn-outline-danger remove-action">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <line x1="18" y1="6" x2="6" y2="18"/>
                                                <line x1="6" y1="6" x2="18" y2="18"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-action">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Ajouter une action
                            </button>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <input type="checkbox" class="form-check-input" id="workflow-active" checked>
                                Activer immédiatement
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="save-workflow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2"/>
                            <circle cx="12" cy="14" r="2"/>
                            <polyline points="14 4 14 8 8 8 8 4"/>
                        </svg>
                        Créer le workflow
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
    <script src="../../assets/js/app.js"></script>
    
    <!-- DataTables -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Wrapper Notion MCP -->
    <script src="../../assets/js/mcp-notion-wrapper.js"></script>
    
    <!-- Module Workflows n8n -->
    <script src="../../assets/js/Superadmin/n8n-workflows-manager.js"></script>

    <script>
        // Initialisation Mermaid
        mermaid.initialize({ startOnLoad: true });
        
        // Initialisation module
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof window.N8nWorkflowsManager !== 'undefined') {
                window.N8nWorkflowsManager.init();
            } else {
                console.error('Module N8nWorkflowsManager non trouvé');
            }
        });
    </script>
</body>
</html>