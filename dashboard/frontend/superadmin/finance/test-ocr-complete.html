<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test OCR Complet - V√©rification Syst√®me</title>
    <link href="../../assets/css/tabler.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">
</head>
<body>
    <div class="page">
        <div class="page-wrapper">
            <div class="page-body">
                <div class="container-xl">
                    <div class="row g-4">
                        <!-- Header -->
                        <div class="col-12">
                            <div class="page-header">
                                <h1>üß™ Test OCR Complet - Syst√®me Premium</h1>
                                <p class="text-muted">V√©rification compl√®te du syst√®me OCR avec int√©gration Notion</p>
                            </div>
                        </div>
                        
                        <!-- Configuration Status -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">‚öôÔ∏è √âtat de la Configuration</h3>
                                </div>
                                <div class="card-body">
                                    <table class="table table-vcenter">
                                        <tbody>
                                            <tr>
                                                <td>Cl√© API OpenAI</td>
                                                <td id="openai-status">
                                                    <span class="badge bg-secondary">Non configur√©</span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-primary" onclick="configureOpenAI()">Configurer</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Cl√© API Notion</td>
                                                <td id="notion-status">
                                                    <span class="badge bg-secondary">Non configur√©</span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-primary" onclick="configureNotion()">Configurer</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>PDF.js</td>
                                                <td id="pdfjs-status">
                                                    <span class="badge bg-secondary">Non charg√©</span>
                                                </td>
                                                <td>-</td>
                                            </tr>
                                            <tr>
                                                <td>Templates</td>
                                                <td id="templates-status">
                                                    <span class="badge bg-secondary">Non charg√©</span>
                                                </td>
                                                <td>-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Databases Notion -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">üìä Bases de donn√©es Notion</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-primary" onclick="testNotionConnection()">
                                            <i class="ti ti-refresh"></i> Tester
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="notion-databases" class="space-y-2">
                                        <p class="text-muted">Cliquez sur "Tester" pour v√©rifier les databases</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Test Workflow -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">üöÄ Test du Workflow Complet</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row g-4">
                                        <!-- √âtape 1 -->
                                        <div class="col-md-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <div class="mb-3">
                                                        <span class="avatar avatar-xl bg-blue-lt">1</span>
                                                    </div>
                                                    <h4>Upload Document</h4>
                                                    <p class="text-muted">T√©l√©charger un fichier test</p>
                                                    <input type="file" id="test-file" class="form-control mb-2" accept=".pdf,.jpg,.png">
                                                    <button class="btn btn-primary" onclick="testStep1()" disabled id="btn-step1">
                                                        Tester Upload
                                                    </button>
                                                    <div id="step1-result" class="mt-2"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- √âtape 2 -->
                                        <div class="col-md-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <div class="mb-3">
                                                        <span class="avatar avatar-xl bg-azure-lt">2</span>
                                                    </div>
                                                    <h4>OCR Vision</h4>
                                                    <p class="text-muted">Extraction IA</p>
                                                    <button class="btn btn-azure" onclick="testStep2()" disabled id="btn-step2">
                                                        Tester OCR
                                                    </button>
                                                    <div id="step2-result" class="mt-2"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- √âtape 3 -->
                                        <div class="col-md-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <div class="mb-3">
                                                        <span class="avatar avatar-xl bg-green-lt">3</span>
                                                    </div>
                                                    <h4>Validation</h4>
                                                    <p class="text-muted">V√©rifier les donn√©es</p>
                                                    <button class="btn btn-green" onclick="testStep3()" disabled id="btn-step3">
                                                        Valider
                                                    </button>
                                                    <div id="step3-result" class="mt-2"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- √âtape 4 -->
                                        <div class="col-md-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <div class="mb-3">
                                                        <span class="avatar avatar-xl bg-success-lt">4</span>
                                                    </div>
                                                    <h4>Notion</h4>
                                                    <p class="text-muted">Sauvegarder</p>
                                                    <button class="btn btn-success" onclick="testStep4()" disabled id="btn-step4">
                                                        Envoyer
                                                    </button>
                                                    <div id="step4-result" class="mt-2"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Console de test -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">üìã Console de Test</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-ghost-secondary" onclick="clearConsole()">
                                            Effacer
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <pre id="test-console" class="bg-dark text-white p-3 rounded" style="min-height: 200px; max-height: 400px; overflow-y: auto;">Console de test OCR...
</pre>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <a href="ocr-upload.html" class="btn btn-primary">
                                    <i class="ti ti-arrow-left"></i> Retour √† l'OCR
                                </a>
                                <div>
                                    <button class="btn btn-success" onclick="runFullTest()">
                                        <i class="ti ti-player-play"></i> Test Complet Automatique
                                    </button>
                                    <button class="btn btn-warning" onclick="resetTest()">
                                        <i class="ti ti-refresh"></i> R√©initialiser
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="../../assets/js/tabler.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="../../assets/js/Superadmin/ocr-templates-final.js"></script>
    <script src="../../assets/js/Superadmin/ocr-vision-final.js"></script>
    <script src="../../assets/js/Superadmin/ocr-notion-integration.js"></script>
    
    <script>
        // √âtat global du test
        let testState = {
            file: null,
            extraction: null,
            validatedData: null,
            documentType: null
        };
        
        // Services
        let ocrVision = null;
        let notionIntegration = null;
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            log('üöÄ Initialisation du syst√®me de test...');
            
            // V√©rifier les configurations
            checkConfigurations();
            
            // Initialiser les services
            try {
                ocrVision = new OCRVisionFinal();
                notionIntegration = new OCRNotionIntegration();
                
                await ocrVision.init();
                log('‚úÖ OCR Vision initialis√©');
                
                await notionIntegration.init();
                log('‚úÖ Notion Integration initialis√©');
                
            } catch (error) {
                log(`‚ùå Erreur initialisation: ${error.message}`, 'error');
            }
            
            // Activer les boutons si fichier s√©lectionn√©
            document.getElementById('test-file').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    document.getElementById('btn-step1').disabled = false;
                }
            });
        });
        
        // V√©rifier les configurations
        function checkConfigurations() {
            // OpenAI
            const openaiKey = localStorage.getItem('openai_api_key');
            if (openaiKey) {
                document.getElementById('openai-status').innerHTML = '<span class="badge bg-success">Configur√©</span>';
            }
            
            // Notion
            const notionKey = localStorage.getItem('notion_api_key');
            if (notionKey) {
                document.getElementById('notion-status').innerHTML = '<span class="badge bg-success">Configur√©</span>';
            }
            
            // PDF.js
            if (typeof pdfjsLib !== 'undefined') {
                document.getElementById('pdfjs-status').innerHTML = '<span class="badge bg-success">Charg√©</span>';
            }
            
            // Templates
            if (typeof DOCUMENT_TYPES !== 'undefined') {
                document.getElementById('templates-status').innerHTML = '<span class="badge bg-success">6 templates</span>';
            }
        }
        
        // Fonctions de configuration
        function configureOpenAI() {
            const key = prompt('Entrez votre cl√© API OpenAI:');
            if (key && key.startsWith('sk-')) {
                localStorage.setItem('openai_api_key', key);
                checkConfigurations();
                location.reload();
            }
        }
        
        function configureNotion() {
            const key = prompt('Entrez votre cl√© API Notion:');
            if (key && key.startsWith('secret_')) {
                localStorage.setItem('notion_api_key', key);
                checkConfigurations();
                location.reload();
            }
        }
        
        // Test connexion Notion
        async function testNotionConnection() {
            log('üîÑ Test de connexion Notion...');
            const container = document.getElementById('notion-databases');
            
            try {
                const result = await notionIntegration.testConnection();
                
                if (result) {
                    container.innerHTML = '<div class="alert alert-success">‚úÖ Connexion OK</div>';
                    
                    // Afficher les databases
                    for (const [type, template] of Object.entries(DOCUMENT_TYPES)) {
                        const dbResult = await notionIntegration.verifyDatabase(template.database_id);
                        const status = dbResult.exists ? 
                            '<span class="badge bg-success">OK</span>' : 
                            '<span class="badge bg-danger">Non trouv√©</span>';
                        
                        container.innerHTML += `
                            <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                                <div>
                                    <strong>${type}</strong><br>
                                    <small class="text-muted">${template.database_name}</small>
                                </div>
                                ${status}
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = '<div class="alert alert-danger">‚ùå Connexion √©chou√©e</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">‚ùå Erreur: ${error.message}</div>`;
                log(`‚ùå Erreur test Notion: ${error.message}`, 'error');
            }
        }
        
        // √âtape 1: Upload
        async function testStep1() {
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('S√©lectionnez un fichier');
                return;
            }
            
            testState.file = file;
            log(`üìÑ Fichier s√©lectionn√©: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
            
            document.getElementById('step1-result').innerHTML = '<span class="badge bg-success">‚úÖ OK</span>';
            document.getElementById('btn-step2').disabled = false;
        }
        
        // √âtape 2: OCR
        async function testStep2() {
            if (!testState.file) return;
            
            log('ü§ñ D√©marrage extraction OCR...');
            document.getElementById('step2-result').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
            
            try {
                const result = await ocrVision.processDocument(testState.file, (progress, status) => {
                    log(`üìä Progression: ${progress}% - ${status}`);
                });
                
                if (result.success) {
                    testState.extraction = result;
                    testState.documentType = result.document_type;
                    
                    log(`‚úÖ Extraction r√©ussie!`);
                    log(`üìã Type d√©tect√©: ${result.document_type}`);
                    log(`üéØ Confiance: ${Math.round(result.confidence * 100)}%`);
                    log(`üìù Donn√©es extraites: ${JSON.stringify(result.extracted_data, null, 2)}`);
                    
                    document.getElementById('step2-result').innerHTML = '<span class="badge bg-success">‚úÖ OK</span>';
                    document.getElementById('btn-step3').disabled = false;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                log(`‚ùå Erreur OCR: ${error.message}`, 'error');
                document.getElementById('step2-result').innerHTML = '<span class="badge bg-danger">‚ùå Erreur</span>';
            }
        }
        
        // √âtape 3: Validation
        function testStep3() {
            if (!testState.extraction) return;
            
            log('‚úÖ Validation des donn√©es...');
            
            // Mapper les donn√©es
            const templateManager = new OCRTemplateManager();
            const mappedData = templateManager.mapExtractedDataToTemplate(
                testState.documentType,
                testState.extraction.extracted_data
            );
            
            // Valider
            const validation = templateManager.validateData(testState.documentType, mappedData);
            
            if (validation.valid) {
                testState.validatedData = mappedData;
                log('‚úÖ Donn√©es valid√©es avec succ√®s');
                document.getElementById('step3-result').innerHTML = '<span class="badge bg-success">‚úÖ OK</span>';
                document.getElementById('btn-step4').disabled = false;
            } else {
                log('‚ö†Ô∏è Erreurs de validation:', 'warning');
                validation.errors.forEach(err => log(`- ${err.message}`, 'warning'));
                document.getElementById('step3-result').innerHTML = '<span class="badge bg-warning">‚ö†Ô∏è Erreurs</span>';
            }
        }
        
        // √âtape 4: Notion
        async function testStep4() {
            if (!testState.validatedData) return;
            
            log('üì§ Envoi vers Notion...');
            document.getElementById('step4-result').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
            
            try {
                const result = await notionIntegration.sendDocument(
                    testState.documentType,
                    testState.validatedData,
                    testState.file
                );
                
                if (result.success) {
                    log(`‚úÖ Document envoy√© avec succ√®s!`);
                    log(`üìé Page ID: ${result.pageId}`);
                    log(`üîó URL: ${result.url}`);
                    
                    document.getElementById('step4-result').innerHTML = `
                        <span class="badge bg-success">‚úÖ OK</span>
                        <br>
                        <a href="${result.url}" target="_blank" class="btn btn-sm btn-primary mt-2">
                            Ouvrir dans Notion
                        </a>
                    `;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                log(`‚ùå Erreur Notion: ${error.message}`, 'error');
                document.getElementById('step4-result').innerHTML = '<span class="badge bg-danger">‚ùå Erreur</span>';
            }
        }
        
        // Test complet automatique
        async function runFullTest() {
            log('üöÄ D√©marrage du test complet automatique...');
            
            // V√©rifier qu'un fichier est s√©lectionn√©
            if (!document.getElementById('test-file').files[0]) {
                alert('S√©lectionnez d\'abord un fichier de test');
                return;
            }
            
            // R√©initialiser
            resetTest();
            
            // Ex√©cuter les √©tapes
            await testStep1();
            await new Promise(r => setTimeout(r, 1000));
            
            await testStep2();
            await new Promise(r => setTimeout(r, 1000));
            
            testStep3();
            await new Promise(r => setTimeout(r, 1000));
            
            await testStep4();
            
            log('‚úÖ Test complet termin√©!');
        }
        
        // R√©initialiser le test
        function resetTest() {
            testState = {
                file: null,
                extraction: null,
                validatedData: null,
                documentType: null
            };
            
            document.querySelectorAll('[id^="step"][id$="-result"]').forEach(el => {
                el.innerHTML = '';
            });
            
            document.querySelectorAll('[id^="btn-step"]').forEach((el, i) => {
                el.disabled = i > 0;
            });
            
            log('üîÑ Test r√©initialis√©');
        }
        
        // Logger
        function log(message, type = 'info') {
            const console = document.getElementById('test-console');
            const time = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'üìù',
                'success': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå'
            };
            
            console.innerHTML += `[${time}] ${typeIcon[type] || ''} ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }
        
        // Effacer la console
        function clearConsole() {
            document.getElementById('test-console').innerHTML = 'Console de test OCR...\n';
        }
    </script>
</body>
</html>