<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Automation - SuperAdmin</title>
    
    <!-- Tabler CSS -->
    <link href="../../shared/tabler/dist/css/tabler.min.css" rel="stylesheet"/>
    <link href="../../shared/tabler/dist/css/tabler-flags.min.css" rel="stylesheet"/>
    <link href="../../shared/tabler/dist/css/tabler-payments.min.css" rel="stylesheet"/>
    <link href="../../shared/tabler/dist/css/tabler-vendors.min.css" rel="stylesheet"/>
    
    <!-- Custom CSS -->
    <link href="css/modern-theme.css" rel="stylesheet">
    <link href="css/glassmorphism.css" rel="stylesheet">
    <link href="css/animations.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="mesh-gradient-bg">
    <div class="page">
        <!-- Header -->
        <header class="navbar navbar-expand-md navbar-dark glassmorphism-card m-3 slide-in-top">
            <div class="container-xl">
                <h1 class="navbar-brand d-none-navbar-horizontal pe-0 pe-md-3">
                    <a href="dashboard.html" class="text-decoration-none">
                        <span class="text-gradient">SuperAdmin</span> - Marketing Automation
                    </a>
                </h1>
                <div class="navbar-nav flex-row order-md-last">
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                            <span class="avatar avatar-sm glassmorphism-hover">JM</span>
                            <div class="d-none d-xl-block ps-2">
                                <div>Jean-Marie</div>
                                <div class="mt-1 small text-muted">Administrateur</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page content -->
        <div class="page-wrapper">
            <div class="container-xl">
                <!-- Page header -->
                <div class="page-header d-print-none mb-4">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <div class="page-pretitle slide-in-left">
                                Email Marketing & Automation
                            </div>
                            <h2 class="page-title text-gradient slide-in-left">
                                üìß Marketing Automation
                            </h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none slide-in-right">
                            <div class="btn-list">
                                <button class="btn btn-primary glassmorphism-hover" onclick="window.open('http://localhost:8084', '_blank')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M11 7h-5a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-5" />
                                        <line x1="10" y1="14" x2="20" y2="4" />
                                        <polyline points="15 4 20 4 20 9" />
                                    </svg>
                                    Ouvrir Mautic
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistiques -->
                <div class="row row-deck row-cards mb-4">
                    <div class="col-sm-6 col-lg-3 zoom-in">
                        <div class="card glassmorphism-card glow-effect-primary">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Contacts totaux</div>
                                    <div class="ms-auto lh-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon text-primary" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <circle cx="9" cy="7" r="4" />
                                            <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                                            <path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
                                        </svg>
                                    </div>
                                </div>
                                <div class="h1 mb-3 text-gradient" id="totalContacts">0</div>
                                <div class="d-flex mb-2">
                                    <div>Nouveaux cette semaine</div>
                                    <div class="ms-auto">
                                        <span class="text-success d-inline-flex align-items-center lh-1">
                                            +12 <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <polyline points="3 17 9 11 13 15 21 7" />
                                                <polyline points="14 7 21 7 21 14" />
                                            </svg>
                                        </span>
                                    </div>
                                </div>
                                <div class="progress progress-sm glassmorphism-progress">
                                    <div class="progress-bar bg-primary" style="width: 75%" role="progressbar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-6 col-lg-3 zoom-in" style="animation-delay: 0.1s">
                        <div class="card glassmorphism-card glow-effect-success">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Campagnes actives</div>
                                    <div class="ms-auto lh-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon text-success" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <line x1="3" y1="12" x2="6" y2="12" />
                                            <line x1="12" y1="3" x2="12" y2="6" />
                                            <line x1="7.8" y1="7.8" x2="5.6" y2="5.6" />
                                            <line x1="16.2" y1="7.8" x2="18.4" y2="5.6" />
                                            <line x1="7.8" y1="16.2" x2="5.6" y2="18.4" />
                                            <path d="M12 12l9 3l-4 2l-2 4l-3 -9" />
                                        </svg>
                                    </div>
                                </div>
                                <div class="h1 mb-3 text-gradient" id="activeCampaigns">0</div>
                                <div class="d-flex mb-2">
                                    <div>En cours d'ex√©cution</div>
                                    <div class="ms-auto">
                                        <span class="badge bg-success">Actif</span>
                                    </div>
                                </div>
                                <div class="progress progress-sm glassmorphism-progress">
                                    <div class="progress-bar bg-success" style="width: 100%" role="progressbar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-6 col-lg-3 zoom-in" style="animation-delay: 0.2s">
                        <div class="card glassmorphism-card glow-effect-info">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Emails envoy√©s</div>
                                    <div class="ms-auto lh-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon text-info" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <rect x="3" y="5" width="18" height="14" rx="2" />
                                            <polyline points="3 7 12 13 21 7" />
                                        </svg>
                                    </div>
                                </div>
                                <div class="h1 mb-3 text-gradient" id="emailsSent">0</div>
                                <div class="d-flex mb-2">
                                    <div>Ce mois-ci</div>
                                    <div class="ms-auto">
                                        <span id="emailsSentThisMonth">0</span>
                                    </div>
                                </div>
                                <div class="progress progress-sm glassmorphism-progress">
                                    <div class="progress-bar bg-info" style="width: 60%" role="progressbar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-6 col-lg-3 zoom-in" style="animation-delay: 0.3s">
                        <div class="card glassmorphism-card glow-effect-warning">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Taux d'ouverture</div>
                                    <div class="ms-auto lh-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon text-warning" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <circle cx="12" cy="12" r="2" />
                                            <path d="M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7" />
                                        </svg>
                                    </div>
                                </div>
                                <div class="h1 mb-3 text-gradient" id="avgOpenRate">0%</div>
                                <div class="d-flex mb-2">
                                    <div>Moyenne globale</div>
                                    <div class="ms-auto">
                                        <span class="text-warning">Bon</span>
                                    </div>
                                </div>
                                <div class="progress progress-sm glassmorphism-progress">
                                    <div class="progress-bar bg-warning" style="width: 45%" role="progressbar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import en masse -->
                <div class="card glassmorphism-card fade-in mb-4">
                    <div class="card-header">
                        <h3 class="card-title text-gradient">Import de contacts</h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">S√©lectionner les contacts √† importer</label>
                                <select class="form-select glassmorphism-input" id="importFilter">
                                    <option value="all">Tous les contacts</option>
                                    <option value="new">Nouveaux contacts (sans ID Mautic)</option>
                                    <option value="company">Par entreprise</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="companySelectDiv" style="display: none;">
                                <label class="form-label">Entreprise</label>
                                <select class="form-select glassmorphism-input" id="companySelect">
                                    <option value="hypervisual">HyperVisual</option>
                                    <option value="dynamics">Dynamics</option>
                                    <option value="lexia">Lexia</option>
                                    <option value="nkreality">NKReality</option>
                                    <option value="etekout">Etekout</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary glassmorphism-hover" onclick="importToMautic()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                                    <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                                    <line x1="12" y1="11" x2="12" y2="17" />
                                    <polyline points="9 14 12 11 15 14" />
                                </svg>
                                Importer dans Mautic
                            </button>
                            <button class="btn glassmorphism-hover ms-2" onclick="testMauticConnection()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M9 11l3 3l8 -8" />
                                    <path d="M20 12v6a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h9" />
                                </svg>
                                Tester connexion
                            </button>
                        </div>
                        <div id="importProgress" class="mt-3" style="display: none;">
                            <div class="progress glassmorphism-progress">
                                <div class="progress-bar progress-bar-indeterminate bg-primary"></div>
                            </div>
                            <p class="text-muted mt-2">Import en cours...</p>
                        </div>
                    </div>
                </div>

                <!-- Campagnes actives -->
                <div class="card glassmorphism-card fade-in">
                    <div class="card-header">
                        <h3 class="card-title text-gradient">Campagnes actives</h3>
                        <div class="card-actions">
                            <button class="btn btn-sm glassmorphism-hover" onclick="refreshCampaigns()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" />
                                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" />
                                </svg>
                                Actualiser
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table">
                                <thead>
                                    <tr>
                                        <th>Campagne</th>
                                        <th>Statut</th>
                                        <th>Contacts</th>
                                        <th>Taux conversion</th>
                                        <th class="w-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="campaignsList">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Chargement des campagnes...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Actions rapides -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card glassmorphism-card slide-in-bottom">
                            <div class="card-header">
                                <h3 class="card-title text-gradient">Actions rapides</h3>
                            </div>
                            <div class="card-body">
                                <div class="btn-list">
                                    <button class="btn glassmorphism-hover" onclick="createNewCampaign()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <line x1="12" y1="5" x2="12" y2="19" />
                                            <line x1="5" y1="12" x2="19" y2="12" />
                                        </svg>
                                        Nouvelle campagne
                                    </button>
                                    <button class="btn glassmorphism-hover" onclick="createNewSegment()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <circle cx="6" cy="12" r="3" />
                                            <circle cx="18" cy="12" r="3" />
                                            <line x1="9" y1="12" x2="15" y2="12" />
                                        </svg>
                                        Nouveau segment
                                    </button>
                                    <button class="btn glassmorphism-hover" onclick="createNewEmail()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <rect x="3" y="5" width="18" height="14" rx="2" />
                                            <polyline points="3 7 12 13 21 7" />
                                        </svg>
                                        Nouveau template email
                                    </button>
                                    <button class="btn btn-primary glassmorphism-hover" onclick="setupInitialCampaigns()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M7 4v16l13 -8z" />
                                        </svg>
                                        Configurer campagnes initiales
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabler JS -->
    <script src="../../shared/tabler/dist/js/tabler.min.js"></script>
    
    <!-- Custom JS -->
    <script src="js/theme-manager.js"></script>
    
    <script>
        // G√©rer l'affichage du s√©lecteur d'entreprise
        document.getElementById('importFilter').addEventListener('change', function() {
            document.getElementById('companySelectDiv').style.display = 
                this.value === 'company' ? 'block' : 'none';
        });

        async function loadMarketingStats() {
            try {
                const response = await fetch('/api/mautic/stats');
                const stats = await response.json();
                
                document.getElementById('totalContacts').textContent = stats.contacts || 0;
                document.getElementById('activeCampaigns').textContent = stats.campaigns || 0;
                document.getElementById('emailsSent').textContent = stats.emails_sent || 0;
                document.getElementById('avgOpenRate').textContent = (stats.open_rate || 0) + '%';
                
                // Charger les campagnes
                await loadCampaigns();
            } catch (error) {
                console.error('Erreur chargement stats:', error);
                showNotification('Erreur lors du chargement des statistiques', 'error');
            }
        }

        async function loadCampaigns() {
            try {
                const response = await fetch('/api/mautic/campaigns');
                const campaigns = await response.json();
                
                const tbody = document.getElementById('campaignsList');
                
                if (!campaigns || campaigns.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                Aucune campagne active
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = Object.values(campaigns).map(campaign => `
                    <tr>
                        <td>
                            <div class="text-reset">${campaign.name}</div>
                            <div class="text-muted small">${campaign.description || ''}</div>
                        </td>
                        <td>
                            <span class="badge bg-success">Actif</span>
                        </td>
                        <td>${campaign.leadCount || 0}</td>
                        <td>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-primary" style="width: ${campaign.conversionRate || 0}%"></div>
                            </div>
                            <small>${campaign.conversionRate || 0}%</small>
                        </td>
                        <td>
                            <button class="btn btn-sm glassmorphism-hover" onclick="viewCampaign(${campaign.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <circle cx="12" cy="12" r="2" />
                                    <path d="M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erreur chargement campagnes:', error);
            }
        }

        async function importToMautic() {
            const filter = document.getElementById('importFilter').value;
            const company = document.getElementById('companySelect').value;
            
            showLoadingIndicator(true);
            
            try {
                const body = { filter };
                if (filter === 'company') {
                    body.company_id = company;
                }
                
                const response = await fetch('/api/mautic/bulk-import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(`${result.imported} contacts import√©s avec succ√®s!`, 'success');
                    
                    if (result.errors && result.errors.length > 0) {
                        console.error('Erreurs import:', result.errors);
                        showNotification(`${result.errors.length} erreurs lors de l'import`, 'warning');
                    }
                    
                    // Recharger les stats
                    await loadMarketingStats();
                } else {
                    throw new Error('Erreur lors de l\'import');
                }
            } catch (error) {
                showNotification('Erreur lors de l\'import', 'error');
                console.error('Erreur import:', error);
            } finally {
                showLoadingIndicator(false);
            }
        }

        async function testMauticConnection() {
            try {
                const response = await fetch('/api/mautic/test');
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Connexion Mautic OK! ' + result.stats.contacts + ' contacts trouv√©s', 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showNotification('Erreur de connexion √† Mautic', 'error');
                console.error('Erreur test:', error);
            }
        }

        function showLoadingIndicator(show) {
            document.getElementById('importProgress').style.display = show ? 'block' : 'none';
        }

        function showNotification(message, type = 'info') {
            const alertClass = {
                'info': 'alert-info',
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning'
            };
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass[type]} alert-dismissible position-fixed top-0 end-0 m-3 fade show`;
            alert.style.zIndex = '9999';
            alert.innerHTML = `
                <div class="d-flex">
                    <div>${message}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 5000);
        }

        function refreshCampaigns() {
            loadCampaigns();
        }

        function viewCampaign(id) {
            window.open(`http://localhost:8084/s/campaigns/view/${id}`, '_blank');
        }

        function createNewCampaign() {
            window.open('http://localhost:8084/s/campaigns/new', '_blank');
        }

        function createNewSegment() {
            window.open('http://localhost:8084/s/segments/new', '_blank');
        }

        function createNewEmail() {
            window.open('http://localhost:8084/s/emails/new', '_blank');
        }

        async function setupInitialCampaigns() {
            if (!confirm('Voulez-vous configurer les campagnes et segments initiaux ?')) {
                return;
            }
            
            showNotification('Configuration des campagnes en cours...', 'info');
            
            // Ici on pourrait appeler un endpoint qui ex√©cute le script de setup
            window.open('http://localhost:8084/s/dashboard', '_blank');
            showNotification('Veuillez configurer manuellement les campagnes dans Mautic', 'info');
        }

        // Charger au d√©marrage
        document.addEventListener('DOMContentLoaded', loadMarketingStats);
        
        // Actualiser toutes les 30 secondes
        setInterval(loadMarketingStats, 30000);
    </script>
</body>
</html>