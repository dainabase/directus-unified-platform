<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Templates Email - SuperAdmin Dashboard</title>
    <!-- CSS files -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/icons-sprite.svg" rel="stylesheet"/>
    <link href="../../assets/css/custom.css" rel="stylesheet"/>
    
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"/>
    
    <!-- CodeMirror pour syntaxe HTML -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <style>
        .role-superadmin { --tblr-primary: #2563eb; }
        .template-card { 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .template-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        .template-category { 
            padding: 0.25rem 0.75rem; 
            border-radius: 4px; 
            font-size: 0.75rem; 
            font-weight: 600;
        }
        .category-onboarding { background: #dbeafe; color: #1e40af; }
        .category-finance { background: #d1fae5; color: #065f46; }
        .category-alerts { background: #fee2e2; color: #991b1b; }
        .category-reports { background: #e9d5ff; color: #6b21a8; }
        .editor-container { 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            overflow: hidden; 
        }
        .variable-tag {
            background: #fef3c7;
            color: #92400e;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
            cursor: pointer;
            margin: 0.25rem;
            display: inline-block;
        }
        .preview-container {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 2rem;
            min-height: 400px;
        }
        .email-preview {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            margin: 0 auto;
        }
        .CodeMirror { height: 400px; }
        .view-toggle { cursor: pointer; }
        .view-toggle.active { 
            background: var(--tblr-primary); 
            color: white; 
        }
        .template-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f3f4f6;
            border-radius: 6px;
        }
    </style>
</head>
<body class="layout-fluid role-superadmin">
    <script src="../../assets/js/demo-theme.js?1692870487"></script>
    
    <div class="page">
        <!-- Navbar -->
        <div id="navbar-container"></div>

        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <div class="page-wrapper">
            <!-- Page header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <div class="page-pretitle">
                                Automatisations
                            </div>
                            <h2 class="page-title">
                                	 Templates Email
                            </h2>
                            <div class="page-subtitle">
                                Gestion des modèles d'emails transactionnels
                            </div>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <button type="button" class="btn btn-outline-primary" id="test-email">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <rect x="3" y="5" width="18" height="14" rx="2"/>
                                        <polyline points="3 7 12 13 21 7"/>
                                    </svg>
                                    Tester l'envoi
                                </button>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Nouveau template
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page body -->
            <div class="page-body">
                <div class="container-xl">
                    
                    <!-- Filtres par catégorie -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="btn-group">
                                <button class="btn btn-outline-primary active" data-category="all">Tous</button>
                                <button class="btn btn-outline-primary" data-category="onboarding">Onboarding</button>
                                <button class="btn btn-outline-primary" data-category="finance">Finance</button>
                                <button class="btn btn-outline-primary" data-category="alerts">Alertes</button>
                                <button class="btn btn-outline-primary" data-category="reports">Rapports</button>
                            </div>
                        </div>
                    </div>

                    <!-- Grille de templates -->
                    <div class="row row-cards" id="templates-grid">
                        <!-- Templates chargés dynamiquement -->
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal Création/Édition Template -->
    <div class="modal modal-blur fade" id="createTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Créer/Éditer un template email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <form id="template-form">
                                <div class="mb-3">
                                    <label class="form-label">Nom du template</label>
                                    <input type="text" class="form-control" id="template-name" required>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <label class="form-label">Sujet de l'email</label>
                                        <input type="text" class="form-control" id="template-subject" placeholder="Ex: Bienvenue {{client_name}} !" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Catégorie</label>
                                        <select class="form-select" id="template-category" required>
                                            <option value="onboarding">Onboarding</option>
                                            <option value="finance">Finance</option>
                                            <option value="alerts">Alertes</option>
                                            <option value="reports">Rapports</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Variables disponibles</label>
                                    <div id="variables-list">
                                        <span class="variable-tag" data-var="client_name">{{client_name}}</span>
                                        <span class="variable-tag" data-var="company_name">{{company_name}}</span>
                                        <span class="variable-tag" data-var="project_name">{{project_name}}</span>
                                        <span class="variable-tag" data-var="portal_url">{{portal_url}}</span>
                                        <span class="variable-tag" data-var="amount">{{amount}}</span>
                                        <span class="variable-tag" data-var="date">{{date}}</span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Contenu de l'email</label>
                                    <div class="btn-group mb-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary view-toggle active" data-view="visual">Éditeur visuel</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary view-toggle" data-view="code">Code HTML</button>
                                    </div>
                                    
                                    <div id="editor-visual" class="editor-container">
                                        <div id="quill-editor" style="height: 400px;"></div>
                                    </div>
                                    
                                    <div id="editor-code" class="editor-container" style="display: none;">
                                        <textarea id="code-editor"></textarea>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        <input type="checkbox" class="form-check-input" id="template-active" checked>
                                        Template actif
                                    </label>
                                </div>
                            </form>
                        </div>
                        
                        <div class="col-lg-4">
                            <h6>Aperçu en temps réel</h6>
                            <div class="preview-container">
                                <div class="email-preview" id="email-preview">
                                    <!-- Aperçu généré dynamiquement -->
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Statistiques d'utilisation</h6>
                                <div class="template-stats">
                                    <div class="stat-item">
                                        <div class="h4">0</div>
                                        <div class="text-muted small">Envois total</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="h4">0%</div>
                                        <div class="text-muted small">Taux ouverture</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="h4">0%</div>
                                        <div class="text-muted small">Taux clic</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="save-template">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2"/>
                            <circle cx="12" cy="14" r="2"/>
                            <polyline points="14 4 14 8 8 8 8 4"/>
                        </svg>
                        Sauvegarder le template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Test Email -->
    <div class="modal modal-blur fade" id="testEmailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tester l'envoi d'email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Template à tester</label>
                        <select class="form-select" id="test-template-select">
                            <option value="">Sélectionner un template</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email destinataire</label>
                        <input type="email" class="form-control" id="test-recipient" placeholder="test@example.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Variables de test (JSON)</label>
                        <textarea class="form-control" id="test-variables" rows="4">{
  "client_name": "Jean Dupont",
  "company_name": "Test SA",
  "amount": "CHF 1'500"
}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="send-test-email">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <line x1="10" y1="14" x2="21" y2="3"/>
                            <path d="M21 3l-6.5 18a0.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a0.55 .55 0 0 1 0 -1l18 -6.5"/>
                        </svg>
                        Envoyer le test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
    <script src="../../assets/js/app.js"></script>
    
    <!-- Quill Editor -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <!-- CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    
    <!-- DataTables -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Handlebars pour templates -->
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.min.js"></script>
    
    <!-- Wrapper Notion MCP -->
    <script src="../../assets/js/mcp-notion-wrapper.js"></script>
    
    <!-- Module Email Templates -->
    <script src="../../assets/js/Superadmin/email-templates-manager.js"></script>

    <script>
        // Initialisation module
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof window.EmailTemplatesManager !== 'undefined') {
                window.EmailTemplatesManager.init();
            } else {
                console.error('Module EmailTemplatesManager non trouvé');
            }
        });
    </script>
</body>
</html>