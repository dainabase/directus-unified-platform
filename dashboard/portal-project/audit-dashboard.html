<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Syst√®me - Dashboard Multi-R√¥les</title>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet">
    <link href="assets/css/custom.css" rel="stylesheet">
    <style>
        .audit-module {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .audit-module:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-success { color: #2fb344; }
        .status-partial { color: #f76707; }
        .status-error { color: #d63939; }
        .status-critical { color: #c41e1e; }
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .score-circle {
            width: 200px;
            height: 200px;
            position: relative;
            margin: 0 auto;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            stroke-dasharray: 565.48;
            stroke-dashoffset: 565.48;
            transition: stroke-dashoffset 1s ease;
        }
        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
        }
        .recommendation-card {
            border-left: 4px solid;
            padding-left: 15px;
            margin-bottom: 15px;
        }
        .recommendation-high { border-color: #d63939; }
        .recommendation-medium { border-color: #f76707; }
        .recommendation-low { border-color: #74b816; }
        .tree-view {
            font-family: monospace;
            line-height: 1.5;
        }
        .tree-view ul {
            list-style: none;
            padding-left: 20px;
        }
        .tree-view li:before {
            content: "‚îú‚îÄ‚îÄ ";
            color: #666;
        }
        .tree-view li:last-child:before {
            content: "‚îî‚îÄ‚îÄ ";
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="page-wrapper">
            <div class="container-xl">
                <!-- Page header -->
                <div class="page-header d-print-none">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                üîç Audit Syst√®me Complet
                            </h2>
                            <div class="text-muted mt-1">Dashboard Multi-R√¥les - Analyse compl√®te du syst√®me</div>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <button class="btn btn-primary" onclick="runAudit()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-refresh" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"></path>
                                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                                    </svg>
                                    Lancer l'audit
                                </button>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                                            <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path>
                                            <line x1="9" y1="9" x2="10" y2="9"></line>
                                            <line x1="9" y1="13" x2="15" y2="13"></line>
                                            <line x1="9" y1="17" x2="15" y2="17"></line>
                                        </svg>
                                        Exporter
                                    </button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#" onclick="exportReport('json')">
                                            Export JSON
                                        </a>
                                        <a class="dropdown-item" href="#" onclick="exportReport('markdown')">
                                            Export Markdown
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress bar -->
                <div class="progress mb-4" style="height: 20px; display: none;" id="audit-progress-container">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="audit-progress" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="text-center mb-4" id="audit-progress-text"></div>

                <!-- Score global -->
                <div class="row mb-4" id="score-section" style="display: none;">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="score-circle">
                                    <svg width="200" height="200">
                                        <circle class="progress-ring-circle" stroke="#e0e0e0" stroke-width="10" fill="transparent" r="90" cx="100" cy="100"></circle>
                                        <circle class="progress-ring progress-ring-circle" id="score-ring" stroke="#2fb344" stroke-width="10" fill="transparent" r="90" cx="100" cy="100"></circle>
                                    </svg>
                                    <div class="score-text" id="score-value">0</div>
                                </div>
                                <h3 class="mt-3">Score Global</h3>
                                <p class="text-muted" id="score-status">En attente d'audit</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card h-100">
                            <div class="card-body">
                                <h3>R√©sum√© de l'audit</h3>
                                <div class="row mt-4">
                                    <div class="col-4 text-center">
                                        <h2 class="status-error mb-0" id="critical-count">0</h2>
                                        <p class="text-muted">Erreurs critiques</p>
                                    </div>
                                    <div class="col-4 text-center">
                                        <h2 class="status-partial mb-0" id="warning-count">0</h2>
                                        <p class="text-muted">Avertissements</p>
                                    </div>
                                    <div class="col-4 text-center">
                                        <h2 class="status-success mb-0" id="success-count">0</h2>
                                        <p class="text-muted">Modules OK</p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p><strong>Date de l'audit:</strong> <span id="audit-date">-</span></p>
                                    <p><strong>Dur√©e:</strong> <span id="audit-duration">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modules -->
                <div class="card mb-4" id="modules-section" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">√âtat des Modules</h3>
                    </div>
                    <div class="card-body">
                        <div class="module-grid" id="modules-grid">
                            <!-- Modules seront ajout√©s dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- Recommandations -->
                <div class="card mb-4" id="recommendations-section" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Recommandations</h3>
                    </div>
                    <div class="card-body" id="recommendations-list">
                        <!-- Recommandations seront ajout√©es dynamiquement -->
                    </div>
                </div>

                <!-- Navigation Map -->
                <div class="card mb-4" id="navigation-section" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Carte de Navigation</h3>
                    </div>
                    <div class="card-body">
                        <div class="tree-view" id="navigation-tree">
                            <!-- Arbre de navigation sera ajout√© dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- Databases Status -->
                <div class="card mb-4" id="databases-section" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">√âtat des Bases de Donn√©es Notion</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-vcenter">
                                <thead>
                                    <tr>
                                        <th>Base de donn√©es</th>
                                        <th>ID</th>
                                        <th>Statut</th>
                                        <th>Enregistrements</th>
                                    </tr>
                                </thead>
                                <tbody id="databases-table">
                                    <!-- Donn√©es seront ajout√©es dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="assets/js/Core/audit-system.js"></script>
    <script>
        let auditResults = null;

        async function runAudit() {
            // Afficher la barre de progression
            document.getElementById('audit-progress-container').style.display = 'block';
            
            // Cacher les sections de r√©sultats
            ['score-section', 'modules-section', 'recommendations-section', 'navigation-section', 'databases-section']
                .forEach(id => document.getElementById(id).style.display = 'none');

            try {
                // Lancer l'audit
                auditResults = await AuditSystem.runCompleteAudit();
                
                // Afficher les r√©sultats
                displayResults();
                
                // Afficher la navigation
                displayNavigationMap();
                
            } catch (error) {
                console.error('Erreur audit:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Une erreur est survenue pendant l\'audit'
                });
            } finally {
                // Cacher la barre de progression
                setTimeout(() => {
                    document.getElementById('audit-progress-container').style.display = 'none';
                }, 1000);
            }
        }

        function displayResults() {
            if (!auditResults) return;

            // Afficher les sections
            ['score-section', 'modules-section', 'recommendations-section', 'databases-section']
                .forEach(id => document.getElementById(id).style.display = 'block');

            // Score global
            const scoreRing = document.getElementById('score-ring');
            const scoreValue = document.getElementById('score-value');
            const scoreStatus = document.getElementById('score-status');
            
            scoreValue.textContent = auditResults.score;
            const offset = 565.48 - (565.48 * auditResults.score) / 100;
            scoreRing.style.strokeDashoffset = offset;
            
            // Couleur selon le score
            if (auditResults.score >= 80) {
                scoreRing.style.stroke = '#2fb344';
                scoreStatus.textContent = 'Excellent';
            } else if (auditResults.score >= 60) {
                scoreRing.style.stroke = '#f76707';
                scoreStatus.textContent = 'Am√©liorations n√©cessaires';
            } else {
                scoreRing.style.stroke = '#d63939';
                scoreStatus.textContent = 'Critique';
            }

            // Compteurs
            document.getElementById('critical-count').textContent = auditResults.errors.length;
            document.getElementById('warning-count').textContent = auditResults.warnings.length;
            document.getElementById('success-count').textContent = 
                Object.values(auditResults.modules).filter(m => m.status === 'success').length;
            
            // Date et dur√©e
            document.getElementById('audit-date').textContent = new Date(auditResults.timestamp).toLocaleString('fr-CH');

            // Modules
            displayModules();
            
            // Recommandations
            displayRecommendations();
            
            // Bases de donn√©es
            displayDatabases();
        }

        function displayModules() {
            const container = document.getElementById('modules-grid');
            container.innerHTML = '';

            const moduleConfigs = {
                'authentication': { icon: 'üîê', name: 'Authentification' },
                'notionMCP': { icon: 'üóÇÔ∏è', name: 'Notion MCP' },
                'finance': { icon: 'üí∞', name: 'Finance' },
                'crm': { icon: 'üë•', name: 'CRM' },
                'projects': { icon: 'üìä', name: 'Projets' },
                'automation': { icon: 'ü§ñ', name: 'Automatisations' },
                'externalAPIs': { icon: 'üîå', name: 'APIs Externes' },
                'performance': { icon: '‚ö°', name: 'Performance' },
                'security': { icon: 'üõ°Ô∏è', name: 'S√©curit√©' }
            };

            for (const [moduleName, moduleData] of Object.entries(auditResults.modules)) {
                const config = moduleConfigs[moduleName] || { icon: 'üì¶', name: moduleName };
                const statusClass = `status-${moduleData.status}`;
                
                const moduleHtml = `
                    <div class="audit-module">
                        <div class="d-flex align-items-center mb-3">
                            <span style="font-size: 2em; margin-right: 10px;">${config.icon}</span>
                            <div class="flex-fill">
                                <h4 class="mb-0">${config.name}</h4>
                                <span class="${statusClass}">${moduleData.status.toUpperCase()}</span>
                            </div>
                        </div>
                        ${moduleData.issues && moduleData.issues.length > 0 ? `
                            <div class="mt-3">
                                <strong>Probl√®mes:</strong>
                                <ul class="mb-0">
                                    ${moduleData.issues.map(issue => 
                                        `<li class="text-${issue.type === 'error' ? 'danger' : 'warning'}">${issue.message}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.innerHTML += moduleHtml;
            }
        }

        function displayRecommendations() {
            const container = document.getElementById('recommendations-list');
            container.innerHTML = '';

            if (auditResults.recommendations.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucune recommandation - Syst√®me optimal !</p>';
                return;
            }

            auditResults.recommendations.forEach(rec => {
                const recHtml = `
                    <div class="recommendation-card recommendation-${rec.priority}">
                        <h5>${rec.module}</h5>
                        <p><strong>Action:</strong> ${rec.action}</p>
                        <p class="text-muted mb-0"><strong>Impact:</strong> ${rec.impact}</p>
                    </div>
                `;
                container.innerHTML += recHtml;
            });
        }

        function displayDatabases() {
            const tbody = document.getElementById('databases-table');
            tbody.innerHTML = '';

            if (!auditResults.modules.notionMCP || !auditResults.modules.notionMCP.databases) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Aucune donn√©e disponible</td></tr>';
                return;
            }

            for (const [dbName, dbInfo] of Object.entries(auditResults.modules.notionMCP.databases)) {
                const statusClass = dbInfo.status === 'connected' ? 'text-success' : 'text-danger';
                const statusIcon = dbInfo.status === 'connected' ? '‚úÖ' : '‚ùå';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${dbName}</td>
                        <td><code>${dbInfo.id}</code></td>
                        <td class="${statusClass}">${statusIcon} ${dbInfo.status}</td>
                        <td>${dbInfo.recordCount || '-'}</td>
                    </tr>
                `;
            }
        }

        async function displayNavigationMap() {
            const navMap = await AuditSystem.createNavigationMap();
            const container = document.getElementById('navigation-tree');
            
            function createTree(obj, level = 0) {
                let html = '<ul>';
                for (const [key, value] of Object.entries(obj)) {
                    if (typeof value === 'string') {
                        html += `<li><a href="${value}" target="_blank">${key}</a></li>`;
                    } else {
                        html += `<li><strong>${key}/</strong>${createTree(value, level + 1)}</li>`;
                    }
                }
                html += '</ul>';
                return html;
            }
            
            container.innerHTML = createTree(navMap);
            document.getElementById('navigation-section').style.display = 'block';
        }

        function exportReport(format) {
            if (!auditResults) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Aucun audit',
                    text: 'Veuillez d\'abord lancer un audit'
                });
                return;
            }

            AuditSystem.exportAuditReport(format);
            
            Swal.fire({
                icon: 'success',
                title: 'Export r√©ussi',
                text: `Rapport export√© au format ${format.toUpperCase()}`
            });
        }

        // Auto-run audit on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                Swal.fire({
                    title: 'Lancer l\'audit automatique ?',
                    text: 'Voulez-vous analyser le syst√®me maintenant ?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Oui, lancer',
                    cancelButtonText: 'Plus tard'
                }).then((result) => {
                    if (result.isConfirmed) {
                        runAudit();
                    }
                });
            }, 1000);
        });
    </script>
</body>
</html>