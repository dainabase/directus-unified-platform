<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test OCR HYPERVISUAL - Debug & Fix</title>
    
    <!-- Tabler CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css" rel="stylesheet">
    
    <style>
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .test-document {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            padding: 2rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            min-height: 400px;
            margin: 1rem 0;
        }
        
        .test-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 1rem 0;
        }
        
        .result-section {
            margin-top: 2rem;
        }
        
        .result-box {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .result-success {
            border-color: #2fb344;
            background: #f1f8f4;
        }
        
        .result-error {
            border-color: #d63939;
            background: #fef2f2;
        }
        
        .log-console {
            background: #1a1a1a;
            color: #0f0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            padding: 1rem;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }
        
        .log-line {
            margin: 2px 0;
            padding: 2px 4px;
        }
        
        .log-error {
            color: #f44;
        }
        
        .log-warning {
            color: #fa0;
        }
        
        .log-success {
            color: #4f4;
        }
        
        .memory-stats {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            z-index: 9999;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="container-fluid py-4">
            <h1 class="mb-4">üß™ Test OCR HYPERVISUAL - Debug & Fix</h1>
            
            <!-- Memory Stats -->
            <div class="memory-stats" id="memoryStats">
                <div>Memory: <span id="memUsage">--</span></div>
                <div>Cache: <span id="cacheStats">--</span></div>
                <div>Resources: <span id="resourceStats">--</span></div>
            </div>
            
            <!-- Test Document -->
            <div class="test-section">
                <h3>üìÑ Document Test: Facture HYPERVISUAL ‚Üí PROMIDEA</h3>
                <div class="test-document" id="testDocument" contenteditable="true">PROMIDEA SRL
Via Alessandro Manzoni, 15
20121 Milano MI
Italy
P.IVA: IT12345678901

<span class="highlight">HYPERVISUAL by HMF Corporation SA</span>
Avenue de Beauregard 1
1700 Fribourg
Switzerland
CHE-317.833.626

Offer AN-00094
Date: 21.07.2025
Valid to: 04.08.2025
Customer number: 000002

Project: Marketing Campaign Q3 2025
Digital Marketing Services for European Market

Service Description                              Quantity    Unit Price    Amount
================================================================================
Social Media Management (3 months)                    3      ‚Ç¨840.00    ‚Ç¨2,520.00
- Facebook, Instagram, LinkedIn
- Daily posts and engagement
- Monthly analytics reports

Content Creation Package                              1      ‚Ç¨500.00      ‚Ç¨500.00
- 20 custom graphics
- 5 video animations
- Copywriting included

                                              Subtotal:               ‚Ç¨3,020.00
                                              VAT 8.10%:               ‚Ç¨244.62
                                              ===============================
                                              <span class="highlight">Total: ‚Ç¨3,264.62</span>

Payment Terms: 30 days net
Bank: UBS Switzerland
IBAN: CH71 0024 0240 C022 2310 T
SWIFT: UBSWCHZH80A</div>
                
                <div class="test-controls">
                    <button class="btn btn-primary" onclick="testOCRExtraction()">
                        <i class="ti ti-brain"></i> Tester Extraction OCR
                    </button>
                    <button class="btn btn-secondary" onclick="testCacheSystem()">
                        <i class="ti ti-database"></i> Tester Cache
                    </button>
                    <button class="btn btn-warning" onclick="testMemoryLeaks()">
                        <i class="ti ti-cpu"></i> Test Memory Leaks
                    </button>
                    <button class="btn btn-info" onclick="testWorkflow()">
                        <i class="ti ti-git-merge"></i> Test Workflow Complet
                    </button>
                    <button class="btn btn-danger" onclick="clearAll()">
                        <i class="ti ti-trash"></i> Nettoyer Tout
                    </button>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div id="progressContainer"></div>
            
            <!-- Results Section -->
            <div class="result-section" id="resultsSection" style="display: none;">
                <h3>üìä R√©sultats de l'Extraction</h3>
                <div id="resultsContainer"></div>
            </div>
            
            <!-- Log Console -->
            <div class="test-section">
                <h3>üñ•Ô∏è Console de Debug</h3>
                <div class="log-console" id="logConsole">
                    <div class="log-line log-success">OCR Test Console Ready...</div>
                </div>
                <button class="btn btn-sm btn-ghost-secondary" onclick="clearLogs()">
                    Effacer Logs
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- OCR Modules -->
    <script src="../../assets/js/Superadmin/ocr-cache-manager.js"></script>
    <script src="../../assets/js/Superadmin/ocr-error-handler.js"></script>
    <script src="../../assets/js/Superadmin/ocr-progress-manager.js"></script>
    <script src="../../assets/js/Superadmin/ocr-memory-manager.js"></script>
    <script src="../../assets/js/Superadmin/ocr-notion-workflow.js"></script>
    <script src="../../assets/js/Superadmin/ocr-api-client.js"></script>
    
    <script>
        // Initialisation des modules
        let cacheManager, errorHandler, progressManager, memoryManager, apiClient;
        
        // Logs
        function log(message, type = 'info') {
            const console = document.getElementById('logConsole');
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logConsole').innerHTML = '<div class="log-line log-success">Console cleared...</div>';
        }
        
        // Memory stats update
        function updateMemoryStats() {
            if (performance.memory) {
                const used = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
                const total = (performance.memory.totalJSHeapSize / 1048576).toFixed(1);
                document.getElementById('memUsage').textContent = `${used}MB / ${total}MB`;
            }
            
            if (cacheManager) {
                const stats = cacheManager.getStats();
                document.getElementById('cacheStats').textContent = `${stats.size}/${stats.maxSize} (${stats.hitRate})`;
            }
            
            if (memoryManager) {
                const stats = memoryManager.getStats();
                document.getElementById('resourceStats').textContent = `${stats.total} objects`;
            }
        }
        
        // Initialisation
        window.addEventListener('DOMContentLoaded', () => {
            log('Initialisation des modules OCR...', 'info');
            
            try {
                // Cache Manager
                cacheManager = new OCRCacheManager({
                    maxSize: 10,
                    debug: true
                });
                log('‚úÖ Cache Manager initialis√©', 'success');
                
                // Error Handler
                errorHandler = new OCRErrorHandler({
                    debug: true,
                    enableRemoteLogging: false
                });
                log('‚úÖ Error Handler initialis√©', 'success');
                
                // Progress Manager
                progressManager = new OCRProgressManager('progressContainer', {
                    enableAnimations: true,
                    enableSound: false
                });
                log('‚úÖ Progress Manager initialis√©', 'success');
                
                // Memory Manager
                memoryManager = new OCRMemoryManager({
                    debug: true,
                    autoCleanup: true
                });
                log('‚úÖ Memory Manager initialis√©', 'success');
                
                // API Client
                apiClient = new OCRAPIClient('http://localhost:3001/api');
                log('‚úÖ API Client initialis√©', 'success');
                
                // Update memory stats
                setInterval(updateMemoryStats, 1000);
                
            } catch (error) {
                log(`‚ùå Erreur initialisation: ${error.message}`, 'error');
            }
        });
        
        // Test extraction OCR
        async function testOCRExtraction() {
            log('üîç D√©marrage test extraction OCR...', 'info');
            
            const text = document.getElementById('testDocument').innerText;
            
            // V√©rifier le cache d'abord
            const mockFile = {
                name: 'test-hypervisual.txt',
                size: text.length,
                lastModified: Date.now()
            };
            
            const cached = cacheManager.get(mockFile);
            if (cached) {
                log('üì¶ R√©sultat trouv√© dans le cache!', 'success');
                displayResults(cached);
                return;
            }
            
            try {
                // Afficher la progression
                progressManager.show();
                
                // Simuler l'extraction (remplacer par vraie extraction)
                log('üìÑ Analyse du document...', 'info');
                progressManager.setStep('analyze');
                
                // D√©tecter le type de document
                const docType = OCRNotionWorkflow.detectDocumentType(text);
                log(`üìã Type d√©tect√©: ${docType}`, 'success');
                
                // Extraire les donn√©es
                const extractedData = {
                    type: docType,
                    client: 'PROMIDEA SRL',
                    numero: 'AN-00094',
                    date: '21.07.2025',
                    dateEcheance: '04.08.2025',
                    montantHT: 3020.00,
                    tva: 244.62,
                    montantTTC: 3264.62,
                    devise: 'EUR',
                    emetteur: 'HYPERVISUAL',
                    details: 'Marketing Campaign Q3 2025'
                };
                
                // Mettre en cache
                cacheManager.set(mockFile, extractedData);
                log('üíæ R√©sultat mis en cache', 'success');
                
                // Afficher les r√©sultats
                displayResults(extractedData);
                
                // Masquer la progression
                progressManager.complete();
                
            } catch (error) {
                log(`‚ùå Erreur extraction: ${error.message}`, 'error');
                progressManager.error(error.message);
                
                const errorInfo = errorHandler.handle(error, 'test_extraction');
                log(`üõ°Ô∏è Error Handler: ${errorInfo.message}`, 'warning');
            }
        }
        
        // Afficher les r√©sultats
        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContainer = document.getElementById('resultsContainer');
            
            resultsSection.style.display = 'block';
            
            const isCorrect = data.type === 'FACTURE_CLIENT' && data.emetteur === 'HYPERVISUAL';
            
            resultsContainer.innerHTML = `
                <div class="result-box ${isCorrect ? 'result-success' : 'result-error'}">
                    <h4>${isCorrect ? '‚úÖ D√©tection Correcte!' : '‚ùå D√©tection Incorrecte'}</h4>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <strong>Type d√©tect√©:</strong> ${data.type}<br>
                            <strong>√âmetteur:</strong> ${data.emetteur || 'Non d√©tect√©'}<br>
                            <strong>Client:</strong> ${data.client}<br>
                            <strong>Num√©ro:</strong> ${data.numero}
                        </div>
                        <div class="col-md-6">
                            <strong>Date:</strong> ${data.date}<br>
                            <strong>Montant HT:</strong> ${data.devise} ${data.montantHT}<br>
                            <strong>TVA:</strong> ${data.devise} ${data.tva}<br>
                            <strong>Total TTC:</strong> ${data.devise} ${data.montantTTC}
                        </div>
                    </div>
                    <hr>
                    <pre class="mb-0">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
            
            log(`üìä R√©sultats affich√©s - ${isCorrect ? 'SUCC√àS' : '√âCHEC'}`, isCorrect ? 'success' : 'error');
        }
        
        // Test cache system
        async function testCacheSystem() {
            log('üóÑÔ∏è Test du syst√®me de cache...', 'info');
            
            // Test 1: Ajout au cache
            const testData = { test: true, timestamp: Date.now() };
            const testFile = {
                name: 'cache-test.pdf',
                size: 1024,
                lastModified: Date.now()
            };
            
            cacheManager.set(testFile, testData);
            log('‚úÖ Donn√©es ajout√©es au cache', 'success');
            
            // Test 2: R√©cup√©ration
            const retrieved = cacheManager.get(testFile);
            if (retrieved && retrieved.test === true) {
                log('‚úÖ Donn√©es r√©cup√©r√©es du cache', 'success');
            } else {
                log('‚ùå √âchec r√©cup√©ration cache', 'error');
            }
            
            // Test 3: Stats
            const stats = cacheManager.getStats();
            log(`üìä Stats cache: ${JSON.stringify(stats)}`, 'info');
            
            // Test 4: Persistance
            cacheManager.persist();
            log('‚úÖ Cache persist√© dans localStorage', 'success');
        }
        
        // Test memory leaks
        async function testMemoryLeaks() {
            log('üíæ Test de fuites m√©moire...', 'warning');
            
            const initialMemory = performance.memory?.usedJSHeapSize || 0;
            log(`M√©moire initiale: ${(initialMemory / 1048576).toFixed(1)}MB`, 'info');
            
            // Cr√©er des ressources
            for (let i = 0; i < 5; i++) {
                log(`It√©ration ${i + 1}/5...`, 'info');
                
                // Cr√©er un canvas
                const canvas = document.createElement('canvas');
                canvas.width = 1000;
                canvas.height = 1000;
                memoryManager.registerCanvas(canvas);
                
                // Cr√©er une image
                const img = new Image();
                img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
                memoryManager.registerImage(img);
                
                // Cr√©er un worker (simul√©)
                const worker = { terminate: async () => {} };
                memoryManager.registerWorker(worker);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            const beforeCleanup = performance.memory?.usedJSHeapSize || 0;
            log(`M√©moire avant nettoyage: ${(beforeCleanup / 1048576).toFixed(1)}MB`, 'warning');
            
            // Nettoyer
            await memoryManager.cleanupAll();
            
            const afterCleanup = performance.memory?.usedJSHeapSize || 0;
            log(`M√©moire apr√®s nettoyage: ${(afterCleanup / 1048576).toFixed(1)}MB`, 'success');
            
            const leaked = afterCleanup - initialMemory;
            if (leaked > 5 * 1048576) { // 5MB
                log(`‚ö†Ô∏è Fuite potentielle d√©tect√©e: ${(leaked / 1048576).toFixed(1)}MB`, 'error');
            } else {
                log('‚úÖ Pas de fuite m√©moire significative', 'success');
            }
        }
        
        // Test workflow complet
        async function testWorkflow() {
            log('üîÑ Test du workflow complet...', 'info');
            
            try {
                // 1. Extraction
                await testOCRExtraction();
                
                // 2. Validation (simul√©e)
                log('‚úÖ Validation des donn√©es...', 'success');
                
                // 3. Envoi Notion (simul√©)
                log('üì§ Envoi vers Notion...', 'info');
                
                // Simuler l'appel API
                const mockData = {
                    documentType: 'FACTURE_CLIENT',
                    extractedData: {
                        numero: 'AN-00094',
                        client: 'PROMIDEA SRL',
                        montantTTC: 3264.62
                    }
                };
                
                // apiClient.saveToNotion(...) 
                log('‚úÖ Document sauvegard√© dans Notion (simul√©)', 'success');
                
                log('üéâ Workflow compl√©t√© avec succ√®s!', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur workflow: ${error.message}`, 'error');
            }
        }
        
        // Nettoyer tout
        async function clearAll() {
            log('üóëÔ∏è Nettoyage complet...', 'warning');
            
            // Nettoyer cache
            cacheManager.clear();
            log('‚úÖ Cache vid√©', 'success');
            
            // Nettoyer logs erreurs
            errorHandler.clearLogs();
            log('‚úÖ Logs erreurs effac√©s', 'success');
            
            // Nettoyer m√©moire
            await memoryManager.cleanupAll();
            log('‚úÖ M√©moire nettoy√©e', 'success');
            
            // Masquer r√©sultats
            document.getElementById('resultsSection').style.display = 'none';
            
            log('üßπ Nettoyage termin√©', 'success');
        }
    </script>
</body>
</html>