<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Syst√®me de Pagination</title>
    <!-- CSS Tabler -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler-flags.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler-payments.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler-vendors.min.css" rel="stylesheet">
    
    <!-- Tabler Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">
    <link href="assets/css/custom.css" rel="stylesheet">
    
    <style>
        /* Dark mode toggle visibility */
        [data-bs-theme="dark"] .hide-theme-dark { display: none !important; }
        [data-bs-theme="light"] .hide-theme-light { display: none !important; }
        
        /* JetBrains Mono pour les valeurs num√©riques */
        #render-time,
        #memory-used,
        #items-rendered,
        #cache-hits,
        .metric-value,
        .percentage-value,
        .timer-value,
        .data-count {
            font-family: 'JetBrains Mono', monospace !important;
            font-weight: 600;
        }
    </style>
</head>
<body data-bs-theme="light">
    <div class="page">
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                Test du Syst√®me de Pagination
                            </h2>
                            <div class="text-muted mt-1">
                                D√©monstration des optimisations de performance
                            </div>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="nav-item d-none d-md-flex me-3">
                                <div class="btn-list-item">
                                    <a href="#" class="nav-link px-0 hide-theme-dark" title="Activer le mode sombre" data-bs-toggle="tooltip" data-bs-placement="bottom" onclick="document.body.setAttribute('data-bs-theme', 'dark')">
                                        <i class="ti ti-moon"></i>
                                    </a>
                                    <a href="#" class="nav-link px-0 hide-theme-light" title="Activer le mode clair" data-bs-toggle="tooltip" data-bs-placement="bottom" onclick="document.body.setAttribute('data-bs-theme', 'light')">
                                        <i class="ti ti-sun"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="page-body">
                <div class="container-xl">
                    <!-- S√©lecteur de test -->
                    <div class="card mb-3">
                        <div class="card-stamp">
                            <div class="card-stamp-icon bg-blue">
                                <i class="ti ti-test-pipe"></i>
                            </div>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">Tests disponibles</h3>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <button class="btn btn-primary w-100" onclick="testPagination()">
                                        <i class="ti ti-list-numbers"></i> Test Pagination
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-info w-100" onclick="testVirtualScroll()">
                                        <i class="ti ti-arrows-vertical"></i> Test Virtual Scroll
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-success w-100" onclick="testAdvancedCache()">
                                        <i class="ti ti-database"></i> Test Cache Avanc√©
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-warning w-100" onclick="testLazyLoader()">
                                        <i class="ti ti-loader"></i> Test Lazy Loading
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zone de test -->
                    <div class="card">
                        <div class="card-stamp">
                            <div class="card-stamp-icon bg-primary">
                                <i class="ti ti-flask"></i>
                            </div>
                        </div>
                        <div class="card-header">
                            <h3 class="card-title">Zone de Test</h3>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-ghost-secondary" onclick="clearTest()">
                                    <i class="ti ti-trash"></i> Effacer
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="test-container">
                                <div class="text-center text-muted py-5">
                                    S√©lectionnez un test ci-dessus pour commencer
                                </div>
                            </div>
                            
                            <!-- Conteneur pour la pagination -->
                            <div id="test-pagination" class="mt-3"></div>
                        </div>
                    </div>
                    
                    <!-- Statistiques de performance -->
                    <div class="card mt-3">
                        <div class="card-stamp">
                            <div class="card-stamp-icon bg-green">
                                <i class="ti ti-chart-line"></i>
                            </div>
                        </div>
                        <div class="card-header">
                            <h3 class="card-title">Statistiques de Performance</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Temps de rendu</label>
                                        <div class="fw-bold" id="render-time">-</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">M√©moire utilis√©e</label>
                                        <div class="fw-bold" id="memory-used">-</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Items rendus</label>
                                        <div class="fw-bold" id="items-rendered">-</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Cache hits</label>
                                        <div class="fw-bold" id="cache-hits">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script src="assets/js/pagination-system.js"></script>
    <script src="assets/js/virtual-scroll.js"></script>
    <script src="assets/js/advanced-cache.js"></script>
    <script src="assets/js/lazy-loader.js"></script>
    
    <script>
        // Variables globales pour les tests
        let testData = [];
        let performanceStats = {
            renderTime: 0,
            memoryUsed: 0,
            itemsRendered: 0,
            cacheHits: 0
        };
        
        // G√©n√©rer des donn√©es de test
        function generateTestData(count) {
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push({
                    id: i + 1,
                    name: `Item ${i + 1}`,
                    description: `Description d√©taill√©e de l'item ${i + 1}`,
                    value: Math.floor(Math.random() * 100000),
                    date: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000),
                    status: ['Active', 'Inactive', 'Pending'][Math.floor(Math.random() * 3)],
                    category: ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)]
                });
            }
            return data;
        }
        
        // Test du syst√®me de pagination
        async function testPagination() {
            const startTime = performance.now();
            const container = document.getElementById('test-container');
            
            // G√©n√©rer 500 items de test
            testData = generateTestData(500);
            
            // Cr√©er l'√©tat de pagination
            PaginationSystem.createPaginationState('test', {
                pageSize: 20,
                sortBy: 'name',
                sortOrder: 'asc'
            });
            
            // Fonction de rendu
            const renderPage = (page, pageSize) => {
                const state = PaginationSystem.getState('test');
                const paginatedData = PaginationSystem.paginateArray(testData, page, pageSize);
                
                container.innerHTML = `
                    <h4>Test de Pagination - ${testData.length} items</h4>
                    <table class="table table-vcenter">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Description</th>
                                <th>Valeur</th>
                                <th>Date</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${paginatedData.map(item => `
                                <tr>
                                    <td>${item.id}</td>
                                    <td>${item.name}</td>
                                    <td>${item.description}</td>
                                    <td>CHF ${item.value.toLocaleString('fr-CH')}</td>
                                    <td>${item.date.toLocaleDateString('fr-FR')}</td>
                                    <td>
                                        <span class="badge bg-${item.status === 'Active' ? 'success' : item.status === 'Inactive' ? 'danger' : 'warning'}">
                                            ${item.status}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Mettre √† jour les stats
                updateStats({
                    renderTime: performance.now() - startTime,
                    itemsRendered: paginatedData.length
                });
            };
            
            // Mettre √† jour l'√©tat avec le nombre total d'items
            PaginationSystem.updateState('test', {
                totalItems: testData.length
            });
            
            // Rendre la premi√®re page
            renderPage(1, 20);
            
            // Cr√©er les contr√¥les de pagination
            PaginationSystem.createControls('test', 'test-pagination', renderPage);
        }
        
        // Test du virtual scrolling
        function testVirtualScroll() {
            const startTime = performance.now();
            const container = document.getElementById('test-container');
            
            // G√©n√©rer 10000 items pour tester les performances
            testData = generateTestData(10000);
            
            container.innerHTML = '<h4>Test Virtual Scrolling - 10,000 items</h4><div id="virtual-scroll-test"></div>';
            
            // Cr√©er le virtual scroll
            const virtualScroll = VirtualScroll.create('virtual-scroll-test', testData, (item, index) => {
                return `
                    <div class="d-flex align-items-center p-2 border-bottom">
                        <div class="flex-fill">
                            <div class="fw-bold">${item.name}</div>
                            <div class="text-muted small">${item.description}</div>
                        </div>
                        <div class="ms-3">
                            <span class="badge bg-primary">CHF ${item.value.toLocaleString('fr-CH')}</span>
                        </div>
                    </div>
                `;
            }, {
                height: 500,
                itemHeight: 60
            });
            
            updateStats({
                renderTime: performance.now() - startTime,
                itemsRendered: Math.ceil(500 / 60) + 10 // viewport items + buffer
            });
        }
        
        // Test du cache avanc√©
        async function testAdvancedCache() {
            const container = document.getElementById('test-container');
            container.innerHTML = '<h4>Test Cache Avanc√©</h4><div class="space-y-3"></div>';
            
            const results = container.querySelector('.space-y-3');
            
            // Test 1: Sauvegarder et r√©cup√©rer
            try {
                const testData = { id: 1, name: 'Test Item', value: 1000 };
                await AdvancedCache.set('test-key', testData, { ttl: 60000 });
                results.innerHTML += '<div class="alert alert-success">‚úÖ Donn√©es sauvegard√©es dans le cache</div>';
                
                const retrieved = await AdvancedCache.get('test-key');
                if (retrieved && retrieved.name === 'Test Item') {
                    results.innerHTML += '<div class="alert alert-success">‚úÖ Donn√©es r√©cup√©r√©es correctement</div>';
                    performanceStats.cacheHits++;
                }
            } catch (error) {
                results.innerHTML += `<div class="alert alert-danger">‚ùå Erreur: ${error.message}</div>`;
            }
            
            // Test 2: Cache avec fallback
            try {
                let fetchCount = 0;
                const fetchFn = async () => {
                    fetchCount++;
                    return { data: 'Fetched data', timestamp: Date.now() };
                };
                
                // Premier appel - fetch
                await AdvancedCache.getOrFetch('test-fetch', fetchFn);
                results.innerHTML += `<div class="alert alert-info">üì• Premier appel: donn√©es r√©cup√©r√©es (fetch count: ${fetchCount})</div>`;
                
                // Deuxi√®me appel - cache
                await AdvancedCache.getOrFetch('test-fetch', fetchFn);
                results.innerHTML += `<div class="alert alert-success">‚úÖ Deuxi√®me appel: donn√©es du cache (fetch count: ${fetchCount})</div>`;
                
                if (fetchCount === 1) {
                    performanceStats.cacheHits++;
                }
            } catch (error) {
                results.innerHTML += `<div class="alert alert-danger">‚ùå Erreur fallback: ${error.message}</div>`;
            }
            
            // Test 3: Taille du cache
            try {
                const size = await AdvancedCache.getSize();
                results.innerHTML += `<div class="alert alert-info">üìä Taille du cache: ${size.itemCount} items, ${size.formattedSize}</div>`;
            } catch (error) {
                results.innerHTML += `<div class="alert alert-danger">‚ùå Erreur taille: ${error.message}</div>`;
            }
            
            updateStats({ cacheHits: performanceStats.cacheHits });
        }
        
        // Test du lazy loader
        async function testLazyLoader() {
            const container = document.getElementById('test-container');
            container.innerHTML = '<h4>Test Lazy Loading</h4><div class="space-y-3"></div>';
            
            const results = container.querySelector('.space-y-3');
            
            // Test pr√©chargement
            results.innerHTML += '<div class="alert alert-info">üîÑ Pr√©chargement des modules charts...</div>';
            LazyLoader.preload(['charts']);
            
            // Test chargement d'un module
            try {
                results.innerHTML += '<div class="alert alert-info">üîÑ Chargement du module charts...</div>';
                await LazyLoader.load('charts');
                
                if (window.ApexCharts) {
                    results.innerHTML += '<div class="alert alert-success">‚úÖ Module ApexCharts charg√© avec succ√®s</div>';
                    
                    // Cr√©er un petit graphique de d√©mo
                    results.innerHTML += '<div id="test-chart" style="height: 200px;"></div>';
                    
                    const chart = new ApexCharts(document.querySelector("#test-chart"), {
                        chart: { type: 'line', height: 200 },
                        series: [{
                            name: 'Performance',
                            data: [30, 40, 35, 50, 49, 60, 70]
                        }],
                        xaxis: { categories: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'] }
                    });
                    chart.render();
                }
            } catch (error) {
                results.innerHTML += `<div class="alert alert-danger">‚ùå Erreur chargement: ${error.message}</div>`;
            }
            
            // Test modules d√©j√† charg√©s
            const startTime = performance.now();
            await LazyLoader.load('charts'); // Devrait √™tre instantan√©
            const loadTime = performance.now() - startTime;
            
            results.innerHTML += `<div class="alert alert-success">‚úÖ Module d√©j√† charg√© r√©cup√©r√© en ${loadTime.toFixed(2)}ms</div>`;
        }
        
        // Effacer les tests
        function clearTest() {
            document.getElementById('test-container').innerHTML = `
                <div class="text-center text-muted py-5">
                    S√©lectionnez un test ci-dessus pour commencer
                </div>
            `;
            document.getElementById('test-pagination').innerHTML = '';
            
            // R√©initialiser les stats
            updateStats({
                renderTime: 0,
                memoryUsed: 0,
                itemsRendered: 0,
                cacheHits: 0
            });
        }
        
        // Mettre √† jour les statistiques
        function updateStats(stats) {
            if (stats.renderTime !== undefined) {
                document.getElementById('render-time').textContent = stats.renderTime.toFixed(2) + ' ms';
            }
            if (stats.memoryUsed !== undefined) {
                document.getElementById('memory-used').textContent = stats.memoryUsed;
            }
            if (stats.itemsRendered !== undefined) {
                document.getElementById('items-rendered').textContent = stats.itemsRendered;
            }
            if (stats.cacheHits !== undefined) {
                document.getElementById('cache-hits').textContent = stats.cacheHits;
            }
        }
        
        // Mesurer la m√©moire si disponible
        if (performance.memory) {
            setInterval(() => {
                const usedMemory = (performance.memory.usedJSHeapSize / 1048576).toFixed(2) + ' MB';
                updateStats({ memoryUsed: usedMemory });
            }, 1000);
        }
    </script>
</body>
</html>