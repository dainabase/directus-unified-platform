name: UI Accessibility
on:
  push:
    branches: [ feat/design-system-apple ]
  pull_request:
    branches: [ feat/design-system-apple, main, master ]
jobs:
  a11y:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install Playwright
        run: pnpm exec playwright install chromium
      
      - name: Build Storybook
        run: pnpm --filter @dainabase/ui build:sb:static
      
      - name: Run a11y tests with report generation
        id: a11y-test
        run: |
          mkdir -p a11y-reports
          npx concurrently -k -s first -n "SB,TEST" -c "magenta,blue" \
            "npx http-server packages/ui/storybook-static --port 6006 --silent" \
            "npx wait-on tcp:6006 && pnpm --filter @dainabase/ui test:stories --reporter=json > a11y-reports/results.json 2>&1 || true"
          
          # Capture exit code
          TEST_EXIT_CODE=$?
          
          # Generate summary report
          echo "# üìä A11y Test Summary" > a11y-reports/summary.md
          echo "" >> a11y-reports/summary.md
          echo "**Date**: $(date)" >> a11y-reports/summary.md
          echo "**Branch**: ${{ github.ref_name }}" >> a11y-reports/summary.md
          echo "**Commit**: ${{ github.sha }}" >> a11y-reports/summary.md
          echo "" >> a11y-reports/summary.md
          
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ **Status**: All a11y tests passed" >> a11y-reports/summary.md
            echo "::notice title=A11y Tests::‚úÖ All accessibility tests passed successfully"
          else
            echo "‚ùå **Status**: A11y violations detected" >> a11y-reports/summary.md
            echo "::error title=A11y Tests::‚ùå Accessibility violations found - check artifacts for details"
          fi
          
          # Generate HTML report if violations exist
          if [ -f "test-results/a11y-report.html" ]; then
            cp test-results/a11y-report.html a11y-reports/
          fi
          
          # Exit with original code
          exit $TEST_EXIT_CODE
      
      - name: Upload a11y reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: a11y-reports-${{ github.sha }}
          path: |
            a11y-reports/
            test-results/
          retention-days: 30
      
      - name: Comment PR with a11y results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summaryContent = '## ‚ôø Accessibility Test Results\n\n';
            
            try {
              if (fs.existsSync('a11y-reports/summary.md')) {
                const summary = fs.readFileSync('a11y-reports/summary.md', 'utf8');
                summaryContent += summary;
              } else {
                summaryContent += '${{ steps.a11y-test.outcome }}' === 'success' 
                  ? '‚úÖ All accessibility tests passed!' 
                  : '‚ùå Accessibility tests failed - check workflow artifacts for details';
              }
            } catch (error) {
              summaryContent += '‚ö†Ô∏è Could not read test summary';
            }
            
            summaryContent += '\n\n[View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summaryContent
            });
