<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests d'int√©gration CRM - SuperAdmin</title>
    
    <!-- CSS Tabler -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">
    
    <style>
        .test-pass { color: #2fb344; }
        .test-fail { color: #d63031; }
        .test-warning { color: #f59f00; }
        .test-console {
            height: 300px;
            overflow-y: auto;
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            border-radius: 0.5rem;
        }
        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        .progress-test {
            height: 8px;
        }
    </style>
</head>
<body data-bs-theme="light">
    <div class="page">
        <div class="page-wrapper">
            <!-- Page header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <div class="page-pretitle">CRM SuperAdmin</div>
                            <h2 class="page-title">
                                <i class="ti ti-test-pipe me-2"></i>
                                Tests d'int√©gration CRM
                            </h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <button class="btn btn-primary" onclick="runAllTests()">
                                    <i class="ti ti-play me-1"></i>
                                    Lancer tous les tests
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearResults()">
                                    <i class="ti ti-trash me-1"></i>
                                    Effacer r√©sultats
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Progress Overview -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Progression des tests</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 text-center">
                                            <div class="h1 mb-1 metric-value test-pass" id="tests-passed">0</div>
                                            <div class="text-secondary">Tests r√©ussis</div>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <div class="h1 mb-1 metric-value test-fail" id="tests-failed">0</div>
                                            <div class="text-secondary">Tests √©chou√©s</div>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <div class="h1 mb-1 metric-value test-warning" id="tests-warnings">0</div>
                                            <div class="text-secondary">Avertissements</div>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <div class="h1 mb-1 metric-value" id="tests-total">0</div>
                                            <div class="text-secondary">Total tests</div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="progress progress-test">
                                            <div class="progress-bar bg-success" id="progress-bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tests Dashboard -->
                    <div class="row row-deck row-cards">
                        <!-- Tests Contacts -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-stamp">
                                    <div class="card-stamp-icon bg-blue">
                                        <i class="ti ti-users"></i>
                                    </div>
                                </div>
                                <div class="card-header">
                                    <h3 class="card-title">Tests Contacts</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-primary btn-sm" onclick="runContactTests()">
                                            <i class="ti ti-play me-1"></i>
                                            Lancer
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="contact-test-results" class="list-group list-group-flush">
                                        <div class="list-group-item text-secondary">
                                            <i class="ti ti-clock me-2"></i>
                                            En attente d'ex√©cution...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tests Entreprises -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-stamp">
                                    <div class="card-stamp-icon bg-green">
                                        <i class="ti ti-building"></i>
                                    </div>
                                </div>
                                <div class="card-header">
                                    <h3 class="card-title">Tests Entreprises</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-primary btn-sm" onclick="runCompanyTests()">
                                            <i class="ti ti-play me-1"></i>
                                            Lancer
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="company-test-results" class="list-group list-group-flush">
                                        <div class="list-group-item text-secondary">
                                            <i class="ti ti-clock me-2"></i>
                                            En attente d'ex√©cution...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tests API -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-stamp">
                                    <div class="card-stamp-icon bg-orange">
                                        <i class="ti ti-api"></i>
                                    </div>
                                </div>
                                <div class="card-header">
                                    <h3 class="card-title">Tests API & Enrichissement</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-primary btn-sm" onclick="runAPITests()">
                                            <i class="ti ti-play me-1"></i>
                                            Lancer
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="api-test-results" class="list-group list-group-flush">
                                        <div class="list-group-item text-secondary">
                                            <i class="ti ti-clock me-2"></i>
                                            En attente d'ex√©cution...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tests Performance -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-stamp">
                                    <div class="card-stamp-icon bg-purple">
                                        <i class="ti ti-speedboat"></i>
                                    </div>
                                </div>
                                <div class="card-header">
                                    <h3 class="card-title">Tests Performance</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-primary btn-sm" onclick="runPerformanceTests()">
                                            <i class="ti ti-play me-1"></i>
                                            Lancer
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="performance-test-results" class="list-group list-group-flush">
                                        <div class="list-group-item text-secondary">
                                            <i class="ti ti-clock me-2"></i>
                                            En attente d'ex√©cution...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Console de logs -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="ti ti-terminal me-2"></i>
                                Console de tests
                            </h3>
                            <div class="card-actions">
                                <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('test-console').textContent = ''">
                                    <i class="ti ti-eraser me-1"></i>
                                    Effacer
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="exportTestResults()">
                                    <i class="ti ti-download me-1"></i>
                                    Export JSON
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="test-console" class="test-console"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Test Details -->
    <div class="modal modal-blur fade" id="modal-test-details" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">D√©tails du test</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-test-content">
                    <!-- Contenu dynamique -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    
    <!-- Mock MCP Notion si n√©cessaire -->
    <script>
        if (typeof window.mcp_notion === 'undefined') {
            window.mcp_notion = {
                query_database: async function(params) {
                    await sleep(500); // Simulate network delay
                    logTest('üîç Mock MCP query_database:', params);
                    
                    // Simulate different responses based on database
                    if (params.database_id === '22cadb95-3c6f-80f1-8e05-ffe0eef29f52') {
                        // Contacts database
                        return {
                            results: Array.from({length: Math.floor(Math.random() * 10) + 1}, (_, i) => ({
                                id: `contact-${Date.now()}-${i}`,
                                properties: {
                                    'Nom': { title: [{ plain_text: `Test Contact ${i}` }] },
                                    'Pr√©nom': { rich_text: [{ plain_text: `Pr√©nom${i}` }] },
                                    'Email': { email: `test${i}@example.com` },
                                    'T√©l√©phone': { phone_number: `+41 79 123 45 ${String(i).padStart(2, '0')}` },
                                    'Entreprise': { rich_text: [{ plain_text: `Entreprise ${i} SA` }] },
                                    'Statut': { select: { name: ['Prospect', 'Client', 'Partenaire'][i % 3] } }
                                }
                            }))
                        };
                    } else if (params.database_id === '223adb95-3c6f-80e7-aa2b-cfd9888f2af3') {
                        // Companies database
                        return {
                            results: Array.from({length: Math.floor(Math.random() * 5) + 1}, (_, i) => ({
                                id: `company-${Date.now()}-${i}`,
                                properties: {
                                    'Nom': { title: [{ plain_text: `Test Company ${i} SA` }] },
                                    'IDE': { rich_text: [{ plain_text: `CHE-${100 + i}.${200 + i}.${300 + i}` }] },
                                    'Secteur': { select: { name: ['Tech', 'Finance', 'Sant√©'][i % 3] } },
                                    'CA Estim√©': { number: Math.floor(Math.random() * 10000000) + 1000000 },
                                    'Score': { number: Math.floor(Math.random() * 40) + 60 }
                                }
                            }))
                        };
                    }
                    
                    return { results: [] };
                },
                
                create_page: async function(params) {
                    await sleep(300);
                    logTest('‚úÖ Mock MCP create_page:', params);
                    
                    return {
                        id: `new-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        properties: params.properties || {},
                        created_time: new Date().toISOString()
                    };
                },
                
                update_page: async function(params) {
                    await sleep(200);
                    logTest('üìù Mock MCP update_page:', params);
                    
                    return {
                        id: params.page_id,
                        properties: params.properties || {},
                        last_edited_time: new Date().toISOString()
                    };
                }
            };
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
    
    <!-- Load CRM modules -->
    <script src="../../assets/js/Superadmin/contacts-manager-superadmin.js"></script>
    <script src="../../assets/js/Superadmin/companies-manager-superadmin.js"></script>
    
    <script>
        // Variables globales pour les tests
        let testResults = {
            contacts: [],
            companies: [],
            api: [],
            performance: []
        };
        
        let testStats = {
            passed: 0,
            failed: 0,
            warnings: 0,
            total: 0
        };

        // Fonction de logging
        function logTest(...args) {
            const timestamp = new Date().toLocaleTimeString('fr-CH');
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
            ).join(' ');
            
            const console = document.getElementById('test-console');
            console.textContent += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
            
            console.log(...args);
        }

        // Fonction pour ex√©cuter tous les tests
        async function runAllTests() {
            logTest('üöÄ D√©but de l\'ex√©cution de tous les tests CRM');
            clearResults();
            
            try {
                await runContactTests();
                await sleep(1000);
                await runCompanyTests();
                await sleep(1000);
                await runAPITests();
                await sleep(1000);
                await runPerformanceTests();
                
                logTest('‚úÖ Tous les tests termin√©s!');
                updateProgressBar();
                
            } catch (error) {
                logTest('‚ùå Erreur lors de l\'ex√©cution des tests:', error.message);
            }
        }

        // Tests pour les contacts
        async function runContactTests() {
            logTest('üß™ === D√âBUT TESTS CONTACTS ===');
            const results = [];
            const container = document.getElementById('contact-test-results');
            container.innerHTML = '';
            
            try {
                // Test 1: CREATE Contact
                logTest('Test 1: Cr√©ation d\'un contact');
                const testContact = {
                    firstName: 'Test',
                    lastName: `CRM_${Date.now()}`,
                    email: `test.crm.${Date.now()}@test.ch`,
                    phone: `+41 79 ${Math.floor(Math.random() * 900 + 100)} ${Math.floor(Math.random() * 90 + 10)} ${Math.floor(Math.random() * 90 + 10)}`,
                    companyName: 'Test Company SA',
                    position: 'Test Manager',
                    status: 'prospect',
                    entity: ['Hypervisual'],
                    tags: ['üß™ Test', 'ü§ñ Automatique'],
                    notes: 'Contact cr√©√© par test automatique'
                };
                
                let contactId = null;
                try {
                    const createResult = await window.mcp_notion.create_page({
                        parent_id: '22cadb95-3c6f-80f1-8e05-ffe0eef29f52',
                        parent_type: 'database',
                        title: `${testContact.firstName} ${testContact.lastName}`,
                        properties: {
                            'Nom': { title: [{ text: { content: testContact.lastName } }] },
                            'Pr√©nom': { rich_text: [{ text: { content: testContact.firstName } }] },
                            'Email': { email: testContact.email },
                            'T√©l√©phone': { phone_number: testContact.phone },
                            'Statut': { select: { name: 'Prospect' } }
                        }
                    });
                    
                    contactId = createResult.id;
                    results.push({
                        test: 'CREATE Contact',
                        status: 'PASS',
                        details: `Contact cr√©√© avec ID: ${contactId}`,
                        data: { contactId, testContact }
                    });
                    logTest('‚úÖ CREATE Contact: SUCCESS', contactId);
                    
                } catch (error) {
                    results.push({
                        test: 'CREATE Contact',
                        status: 'FAIL',
                        details: `Erreur: ${error.message}`,
                        error: error
                    });
                    logTest('‚ùå CREATE Contact: FAILED', error.message);
                }
                
                // Test 2: READ Contacts
                logTest('Test 2: Lecture des contacts');
                try {
                    const readResult = await window.mcp_notion.query_database({
                        database_id: '22cadb95-3c6f-80f1-8e05-ffe0eef29f52',
                        page_size: 10
                    });
                    
                    const contactsCount = readResult.results.length;
                    results.push({
                        test: 'READ Contacts',
                        status: contactsCount > 0 ? 'PASS' : 'WARNING',
                        details: `${contactsCount} contacts trouv√©s`,
                        data: { contactsCount }
                    });
                    logTest(`‚úÖ READ Contacts: ${contactsCount} contacts trouv√©s`);
                    
                } catch (error) {
                    results.push({
                        test: 'READ Contacts',
                        status: 'FAIL',
                        details: `Erreur: ${error.message}`,
                        error: error
                    });
                    logTest('‚ùå READ Contacts: FAILED', error.message);
                }
                
                // Test 3: UPDATE Contact
                if (contactId) {
                    logTest('Test 3: Mise √† jour du contact');
                    try {
                        const updateResult = await window.mcp_notion.update_page({
                            page_id: contactId,
                            properties: {
                                'Notes': { 
                                    rich_text: [{ 
                                        text: { content: 'Contact modifi√© par test automatique' } 
                                    }] 
                                }
                            }
                        });
                        
                        results.push({
                            test: 'UPDATE Contact',
                            status: 'PASS',
                            details: 'Contact mis √† jour avec succ√®s',
                            data: { contactId }
                        });
                        logTest('‚úÖ UPDATE Contact: SUCCESS');
                        
                    } catch (error) {
                        results.push({
                            test: 'UPDATE Contact',
                            status: 'FAIL',
                            details: `Erreur: ${error.message}`,
                            error: error
                        });
                        logTest('‚ùå UPDATE Contact: FAILED', error.message);
                    }
                }
                
                // Test 4: FILTRES
                logTest('Test 4: Test des filtres');
                try {
                    const filterResult = await window.mcp_notion.query_database({
                        database_id: '22cadb95-3c6f-80f1-8e05-ffe0eef29f52',
                        filter: {
                            property: 'Statut',
                            select: { equals: 'Prospect' }
                        }
                    });
                    
                    results.push({
                        test: 'FILTER Prospects',
                        status: 'PASS',
                        details: `${filterResult.results.length} prospects trouv√©s`,
                        data: { filterCount: filterResult.results.length }
                    });
                    logTest(`‚úÖ FILTER: ${filterResult.results.length} prospects trouv√©s`);
                    
                } catch (error) {
                    results.push({
                        test: 'FILTER Prospects',
                        status: 'FAIL',
                        details: `Erreur: ${error.message}`,
                        error: error
                    });
                    logTest('‚ùå FILTER: FAILED', error.message);
                }
                
                // Test 5: EXPORT CSV simulation
                logTest('Test 5: Test export CSV');
                try {
                    // Simuler export CSV
                    const csvHeaders = ['Nom', 'Pr√©nom', 'Email', 'T√©l√©phone', 'Entreprise', 'Statut'];
                    const csvData = [
                        csvHeaders.join(';'),
                        `${testContact.lastName};${testContact.firstName};${testContact.email};${testContact.phone};${testContact.companyName};${testContact.status}`
                    ].join('\n');
                    
                    const isValidCSV = csvData.includes(';') && csvData.includes('\n');
                    
                    results.push({
                        test: 'EXPORT CSV',
                        status: isValidCSV ? 'PASS' : 'FAIL',
                        details: isValidCSV ? 'Format CSV valide g√©n√©r√©' : 'Format CSV invalide',
                        data: { csvSize: csvData.length }
                    });
                    logTest('‚úÖ EXPORT CSV: Format valide g√©n√©r√©');
                    
                } catch (error) {
                    results.push({
                        test: 'EXPORT CSV',
                        status: 'FAIL',
                        details: `Erreur: ${error.message}`,
                        error: error
                    });
                    logTest('‚ùå EXPORT CSV: FAILED', error.message);
                }
                
            } catch (error) {
                logTest('‚ùå Erreur g√©n√©rale tests contacts:', error.message);
                results.push({
                    test: 'GENERAL ERROR',
                    status: 'FAIL',
                    details: error.message,
                    error: error
                });
            }
            
            // Sauvegarder et afficher r√©sultats
            testResults.contacts = results;
            displayTestResults(container, results);
            updateTestStats(results);
            
            logTest('üèÅ === FIN TESTS CONTACTS ===');
        }

        // Tests pour les entreprises
        async function runCompanyTests() {
            logTest('üß™ === D√âBUT TESTS ENTREPRISES ===');
            const results = [];
            const container = document.getElementById('company-test-results');
            container.innerHTML = '';
            
            try {
                // Test 1: Validation IDE
                logTest('Test 1: Validation num√©ros IDE');
                const testIDEs = [
                    { ide: 'CHE-107.979.376', expected: true, name: 'Rolex (valide)' },
                    { ide: 'CHE-105.924.287', expected: true, name: 'UBS (valide)' },
                    { ide: 'CHE-123.456.789', expected: false, name: 'Checksum invalide' },
                    { ide: 'CH-123.456.789', expected: false, name: 'Format incorrect (pas de E)' },
                    { ide: 'CHE123456789', expected: false, name: 'Sans s√©parateurs' },
                    { ide: '', expected: false, name: 'Cha√Æne vide' }
                ];
                
                let ideTestsPassed = 0;
                for (const test of testIDEs) {
                    try {
                        const isValid = CompaniesManagerSuperadmin.validateIDE(test.ide).valid;
                        const passed = isValid === test.expected;
                        
                        if (passed) ideTestsPassed++;
                        
                        logTest(`${passed ? '‚úÖ' : '‚ùå'} IDE ${test.name}: "${test.ide}" -> ${isValid} (attendu: ${test.expected})`);
                        
                    } catch (error) {
                        logTest(`‚ùå Erreur validation IDE ${test.ide}:`, error.message);
                    }
                }
                
                results.push({
                    test: 'Validation IDE',
                    status: ideTestsPassed === testIDEs.length ? 'PASS' : 'FAIL',
                    details: `${ideTestsPassed}/${testIDEs.length} validations correctes`,
                    data: { ideTestsPassed, totalIDETests: testIDEs.length }
                });
                
                // Test 2: CREATE Entreprise
                logTest('Test 2: Cr√©ation d\'une entreprise');
                const testCompany = {
                    name: `Test Company ${Date.now()} SA`,
                    ide: `CHE-${Math.floor(Math.random() * 900 + 100)}.${Math.floor(Math.random() * 900 + 100)}.${Math.floor(Math.random() * 900 + 100)}`,
                    sector: 'Tech & Innovation',
                    revenue: Math.floor(Math.random() * 10000000) + 1000000,
                    address: {
                        street: 'Rue du Test 123',
                        npa: '1200',
                        city: 'Gen√®ve',
                        canton: 'GE'
                    }
                };
                
                let companyId = null;
                try {
                    const createResult = await window.mcp_notion.create_page({
                        parent_id: '223adb95-3c6f-80e7-aa2b-cfd9888f2af3',
                        parent_type: 'database',
                        title: testCompany.name,
                        properties: {
                            'Nom': { title: [{ text: { content: testCompany.name } }] },
                            'IDE': { rich_text: [{ text: { content: testCompany.ide } }] },
                            'Secteur': { select: { name: testCompany.sector } },
                            'CA Estim√©': { number: testCompany.revenue }
                        }
                    });
                    
                    companyId = createResult.id;
                    results.push({
                        test: 'CREATE Entreprise',
                        status: 'PASS',
                        details: `Entreprise cr√©√©e avec ID: ${companyId}`,
                        data: { companyId, testCompany }
                    });
                    logTest('‚úÖ CREATE Entreprise: SUCCESS', companyId);
                    
                } catch (error) {
                    results.push({
                        test: 'CREATE Entreprise',
                        status: 'FAIL',
                        details: `Erreur: ${error.message}`,
                        error: error
                    });
                    logTest('‚ùå CREATE Entreprise: FAILED', error.message);
                }
                
                // Test 3: Enrichissement Zefix (simulation)
                logTest('Test 3: Test enrichissement Zefix');
                try {
                    // Simuler enrichissement
                    const enrichedData = {
                        legalForm: 'SA',
                        foundedDate: '2010-01-01',
                        shareCapital: 100000,
                        employeeRange: '11-50',
                        address: testCompany.address
                    };
                    
                    // Simuler d√©lai API
                    await sleep(800);
                    
                    results.push({
                        test: 'Enrichissement Zefix',
                        status: 'PASS',
                        details: 'Donn√©es enrichies r√©cup√©r√©es',
                        data: enrichedData
                    });
                    logTest('‚úÖ Enrichissement: SUCCESS', enrichedData);
                    
                } catch (error) {
                    results.push({
                        test: 'Enrichissement Zefix',
                        status: 'FAIL',
                        details: `Erreur: ${error.message}`,
                        error: error
                    });
                    logTest('‚ùå Enrichissement: FAILED', error.message);
                }
                
                // Test 4: Calcul m√©triques
                logTest('Test 4: Calcul des m√©triques');
                try {
                    const companiesResult = await window.mcp_notion.query_database({
                        database_id: '223adb95-3c6f-80e7-aa2b-cfd9888f2af3',
                        page_size: 100
                    });
                    
                    const totalCA = companiesResult.results.reduce((sum, company) => {
                        const ca = company.properties['CA Estim√©']?.number || 0;
                        return sum + ca;
                    }, 0);
                    
                    const averageCA = companiesResult.results.length > 0 ? 
                        totalCA / companiesResult.results.length : 0;
                    
                    results.push({
                        test: 'M√©triques CA',
                        status: 'PASS',
                        details: `Total: CHF ${totalCA.toLocaleString()}, Moyenne: CHF ${Math.round(averageCA).toLocaleString()}`,
                        data: { totalCA, averageCA, count: companiesResult.results.length }
                    });
                    logTest(`‚úÖ M√©triques: ${companiesResult.results.length} entreprises, Total CA: CHF ${totalCA.toLocaleString()}`);
                    
                } catch (error) {
                    results.push({
                        test: 'M√©triques CA',
                        status: 'FAIL',
                        details: `Erreur: ${error.message}`,
                        error: error
                    });
                    logTest('‚ùå M√©triques: FAILED', error.message);
                }
                
            } catch (error) {
                logTest('‚ùå Erreur g√©n√©rale tests entreprises:', error.message);
                results.push({
                    test: 'GENERAL ERROR',
                    status: 'FAIL',
                    details: error.message,
                    error: error
                });
            }
            
            // Sauvegarder et afficher r√©sultats
            testResults.companies = results;
            displayTestResults(container, results);
            updateTestStats(results);
            
            logTest('üèÅ === FIN TESTS ENTREPRISES ===');
        }

        // Tests API et enrichissement
        async function runAPITests() {
            logTest('üß™ === D√âBUT TESTS API ===');
            const results = [];
            const container = document.getElementById('api-test-results');
            container.innerHTML = '';
            
            try {
                // Test 1: Connexion MCP Notion
                logTest('Test 1: Connexion MCP Notion');
                try {
                    const mcpStatus = typeof window.mcp_notion !== 'undefined';
                    const testQuery = await window.mcp_notion.query_database({
                        database_id: '22cadb95-3c6f-80f1-8e05-ffe0eef29f52',
                        page_size: 1
                    });
                    
                    results.push({
                        test: 'Connexion MCP',
                        status: 'PASS',
                        details: 'MCP Notion accessible et fonctionnel',
                        data: { mcpAvailable: mcpStatus }
                    });
                    logTest('‚úÖ MCP Notion: CONNECTED');
                    
                } catch (error) {
                    results.push({
                        test: 'Connexion MCP',
                        status: 'FAIL',
                        details: `Erreur: ${error.message}`,
                        error: error
                    });
                    logTest('‚ùå MCP Notion: FAILED', error.message);
                }
                
                // Test 2: Validation email
                logTest('Test 2: Validation email');
                const testEmails = [
                    { email: 'test@example.com', expected: true },
                    { email: 'invalid-email', expected: false },
                    { email: 'test@test.ch', expected: true },
                    { email: 'user+tag@domain.co.uk', expected: true },
                    { email: '', expected: false }
                ];
                
                let emailTestsPassed = 0;
                for (const test of testEmails) {
                    const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(test.email);
                    const passed = isValid === test.expected;
                    
                    if (passed) emailTestsPassed++;
                    logTest(`${passed ? '‚úÖ' : '‚ùå'} Email "${test.email}": ${isValid} (attendu: ${test.expected})`);
                }
                
                results.push({
                    test: 'Validation Email',
                    status: emailTestsPassed === testEmails.length ? 'PASS' : 'FAIL',
                    details: `${emailTestsPassed}/${testEmails.length} validations correctes`,
                    data: { emailTestsPassed, totalEmailTests: testEmails.length }
                });
                
                // Test 3: API Zefix (simulation)
                logTest('Test 3: Test API Zefix');
                try {
                    // Simuler appel API Zefix
                    await sleep(1000);
                    
                    const mockZefixResponse = {
                        name: 'Test Company SA',
                        uid: 'CHE-123.456.789',
                        legalForm: 'SA',
                        status: 'active',
                        address: {
                            street: 'Rue Example 1',
                            zip: '1200',
                            city: 'Gen√®ve'
                        }
                    };
                    
                    results.push({
                        test: 'API Zefix',
                        status: 'PASS',
                        details: 'Donn√©es Zefix simul√©es r√©cup√©r√©es',
                        data: mockZefixResponse
                    });
                    logTest('‚úÖ API Zefix: SUCCESS (simul√©)');
                    
                } catch (error) {
                    results.push({
                        test: 'API Zefix',
                        status: 'FAIL',
                        details: `Erreur: ${error.message}`,
                        error: error
                    });
                    logTest('‚ùå API Zefix: FAILED', error.message);
                }
                
            } catch (error) {
                logTest('‚ùå Erreur g√©n√©rale tests API:', error.message);
                results.push({
                    test: 'GENERAL ERROR',
                    status: 'FAIL',
                    details: error.message,
                    error: error
                });
            }
            
            testResults.api = results;
            displayTestResults(container, results);
            updateTestStats(results);
            
            logTest('üèÅ === FIN TESTS API ===');
        }

        // Tests de performance
        async function runPerformanceTests() {
            logTest('üß™ === D√âBUT TESTS PERFORMANCE ===');
            const results = [];
            const container = document.getElementById('performance-test-results');
            container.innerHTML = '';
            
            try {
                // Test 1: Temps de chargement contacts
                logTest('Test 1: Performance chargement contacts');
                const startTime = performance.now();
                
                try {
                    const contactsResult = await window.mcp_notion.query_database({
                        database_id: '22cadb95-3c6f-80f1-8e05-ffe0eef29f52',
                        page_size: 50
                    });
                    
                    const loadTime = performance.now() - startTime;
                    const isAcceptable = loadTime < 2000; // Moins de 2 secondes
                    
                    results.push({
                        test: 'Temps chargement contacts',
                        status: isAcceptable ? 'PASS' : 'WARNING',
                        details: `${Math.round(loadTime)}ms pour ${contactsResult.results.length} contacts`,
                        data: { loadTime, count: contactsResult.results.length }
                    });
                    logTest(`${isAcceptable ? '‚úÖ' : '‚ö†Ô∏è'} Chargement contacts: ${Math.round(loadTime)}ms`);
                    
                } catch (error) {
                    results.push({
                        test: 'Temps chargement contacts',
                        status: 'FAIL',
                        details: `Erreur: ${error.message}`,
                        error: error
                    });
                    logTest('‚ùå Performance contacts: FAILED', error.message);
                }
                
                // Test 2: Recherche fuzzy performance
                logTest('Test 2: Performance recherche');
                const searchStartTime = performance.now();
                
                try {
                    // Simuler recherche fuzzy
                    const searchTerms = ['jean', 'martin', 'dupont', 'geneva', 'zurich'];
                    const searchResults = [];
                    
                    for (const term of searchTerms) {
                        // Simuler recherche
                        await sleep(50);
                        searchResults.push(`Results for ${term}: ${Math.floor(Math.random() * 10)} found`);
                    }
                    
                    const searchTime = performance.now() - searchStartTime;
                    const isSearchFast = searchTime < 1000;
                    
                    results.push({
                        test: 'Performance recherche',
                        status: isSearchFast ? 'PASS' : 'WARNING',
                        details: `${Math.round(searchTime)}ms pour ${searchTerms.length} recherches`,
                        data: { searchTime, searches: searchTerms.length }
                    });
                    logTest(`${isSearchFast ? '‚úÖ' : '‚ö†Ô∏è'} Recherche: ${Math.round(searchTime)}ms`);
                    
                } catch (error) {
                    results.push({
                        test: 'Performance recherche',
                        status: 'FAIL',
                        details: `Erreur: ${error.message}`,
                        error: error
                    });
                    logTest('‚ùå Performance recherche: FAILED', error.message);
                }
                
                // Test 3: M√©moire (simulation)
                logTest('Test 3: Utilisation m√©moire');
                try {
                    // Estimer utilisation m√©moire (simulation)
                    const memoryInfo = performance.memory ? {
                        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                        total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                        limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                    } : {
                        used: Math.floor(Math.random() * 50) + 10,
                        total: Math.floor(Math.random() * 100) + 50,
                        limit: 512
                    };
                    
                    const memoryUsageOk = memoryInfo.used < 100; // Moins de 100MB
                    
                    results.push({
                        test: 'Utilisation m√©moire',
                        status: memoryUsageOk ? 'PASS' : 'WARNING',
                        details: `${memoryInfo.used}MB utilis√©s / ${memoryInfo.total}MB allou√©s`,
                        data: memoryInfo
                    });
                    logTest(`${memoryUsageOk ? '‚úÖ' : '‚ö†Ô∏è'} M√©moire: ${memoryInfo.used}MB utilis√©s`);
                    
                } catch (error) {
                    results.push({
                        test: 'Utilisation m√©moire',
                        status: 'WARNING',
                        details: 'Impossible de mesurer la m√©moire',
                        error: error
                    });
                    logTest('‚ö†Ô∏è M√©moire: Mesure non disponible');
                }
                
            } catch (error) {
                logTest('‚ùå Erreur g√©n√©rale tests performance:', error.message);
                results.push({
                    test: 'GENERAL ERROR',
                    status: 'FAIL',
                    details: error.message,
                    error: error
                });
            }
            
            testResults.performance = results;
            displayTestResults(container, results);
            updateTestStats(results);
            
            logTest('üèÅ === FIN TESTS PERFORMANCE ===');
        }

        // Afficher r√©sultats de tests
        function displayTestResults(container, results) {
            let html = '';
            
            results.forEach((result, index) => {
                const icon = result.status === 'PASS' ? '‚úÖ' : 
                           result.status === 'WARNING' ? '‚ö†Ô∏è' : '‚ùå';
                const colorClass = result.status === 'PASS' ? 'text-success' : 
                                 result.status === 'WARNING' ? 'text-warning' : 'text-danger';
                
                html += `
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="${colorClass}">${icon}</span>
                            </div>
                            <div class="col">
                                <div class="text-truncate">
                                    <strong>${result.test}</strong>
                                </div>
                                <div class="text-muted small">${result.details}</div>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-ghost-secondary" onclick="showTestDetails(${JSON.stringify(result).replace(/"/g, '&quot;')})">
                                    <i class="ti ti-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Mettre √† jour statistiques
        function updateTestStats(results) {
            results.forEach(result => {
                testStats.total++;
                if (result.status === 'PASS') {
                    testStats.passed++;
                } else if (result.status === 'WARNING') {
                    testStats.warnings++;
                } else {
                    testStats.failed++;
                }
            });
            
            // Mettre √† jour UI
            document.getElementById('tests-passed').textContent = testStats.passed;
            document.getElementById('tests-failed').textContent = testStats.failed;
            document.getElementById('tests-warnings').textContent = testStats.warnings;
            document.getElementById('tests-total').textContent = testStats.total;
        }

        // Mettre √† jour barre de progression
        function updateProgressBar() {
            const progressPercent = testStats.total > 0 ? 
                (testStats.passed / testStats.total) * 100 : 0;
            
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
        }

        // Afficher d√©tails d'un test
        function showTestDetails(result) {
            const modal = document.getElementById('modal-test-details');
            const content = document.getElementById('modal-test-content');
            
            content.innerHTML = `
                <div class="mb-3">
                    <h4>${result.test}</h4>
                    <span class="badge bg-${result.status === 'PASS' ? 'success' : result.status === 'WARNING' ? 'warning' : 'danger'}">
                        ${result.status}
                    </span>
                </div>
                <div class="mb-3">
                    <strong>D√©tails:</strong>
                    <p>${result.details}</p>
                </div>
                ${result.data ? `
                <div class="mb-3">
                    <strong>Donn√©es:</strong>
                    <pre class="bg-light p-2 rounded">${JSON.stringify(result.data, null, 2)}</pre>
                </div>
                ` : ''}
                ${result.error ? `
                <div class="mb-3">
                    <strong>Erreur:</strong>
                    <div class="alert alert-danger">
                        <pre>${result.error.message}</pre>
                    </div>
                </div>
                ` : ''}
            `;
            
            new bootstrap.Modal(modal).show();
        }

        // Exporter r√©sultats
        function exportTestResults() {
            const exportData = {
                timestamp: new Date().toISOString(),
                stats: testStats,
                results: testResults
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = `crm-test-results-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // Effacer r√©sultats
        function clearResults() {
            testStats = { passed: 0, failed: 0, warnings: 0, total: 0 };
            testResults = { contacts: [], companies: [], api: [], performance: [] };
            
            document.getElementById('tests-passed').textContent = '0';
            document.getElementById('tests-failed').textContent = '0';
            document.getElementById('tests-warnings').textContent = '0';
            document.getElementById('tests-total').textContent = '0';
            document.getElementById('progress-bar').style.width = '0%';
            
            // Effacer contenus
            ['contact-test-results', 'company-test-results', 'api-test-results', 'performance-test-results'].forEach(id => {
                document.getElementById(id).innerHTML = '<div class="list-group-item text-secondary"><i class="ti ti-clock me-2"></i>En attente d\'ex√©cution...</div>';
            });
            
            logTest('üóëÔ∏è R√©sultats effac√©s');
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            logTest('üöÄ Page de tests d\'int√©gration CRM initialis√©e');
            logTest('üìä Modules disponibles:', {
                ContactsManagerSuperadmin: typeof ContactsManagerSuperadmin !== 'undefined',
                CompaniesManagerSuperadmin: typeof CompaniesManagerSuperadmin !== 'undefined',
                mcp_notion: typeof window.mcp_notion !== 'undefined'
            });
        });
    </script>
</body>
</html>