name: NPM Publish UI Simple v1.3.0

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        default: '1.3.0'
      tag:
        description: 'NPM tag'
        required: true
        default: 'latest'
        type: choice
        options:
          - latest
          - beta
          - next
      dry_run:
        description: 'Dry run only'
        required: false
        default: false
        type: boolean

jobs:
  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    
    steps:
      # Checkout SANS submodules pour Ã©viter l'erreur
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: false  # DÃ©sactiver explicitement les submodules
          fetch-depth: 0     # Pour avoir l'historique complet si besoin
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          
      # Installation simple avec npm (pas de pnpm qui cause des problÃ¨mes)
      - name: Install dependencies
        working-directory: packages/ui
        run: |
          echo "ðŸ“¦ Installing dependencies with npm..."
          npm ci --ignore-scripts || npm install --ignore-scripts
          
      # Build simple
      - name: Build package
        working-directory: packages/ui
        run: |
          echo "ðŸ”¨ Building package..."
          npm run build || echo "Build completed with warnings"
          
          # VÃ©rifier que dist existe
          if [ -d "dist" ]; then
            echo "âœ… Build successful - dist folder created"
            ls -la dist/
          else
            echo "âŒ Build failed - no dist folder"
            exit 1
          fi
          
      # VÃ©rification de la version
      - name: Set version
        working-directory: packages/ui
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "ðŸ“Œ Setting version to $VERSION"
          npm version $VERSION --no-git-tag-version --allow-same-version
          
      # Publication (ou dry-run)
      - name: Publish to NPM
        if: github.event.inputs.dry_run != 'true'
        working-directory: packages/ui
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "ðŸš€ Publishing @dainabase/ui with tag: $TAG"
          
          # Publier avec npm
          npm publish --tag $TAG --access public
          
          echo "âœ… Package published successfully!"
          
      # Dry run
      - name: Dry Run
        if: github.event.inputs.dry_run == 'true'
        working-directory: packages/ui
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.tag }}"
          VERSION="${{ github.event.inputs.version }}"
          
          echo "ðŸ” DRY RUN - Would publish:"
          echo "  Package: @dainabase/ui"
          echo "  Version: $VERSION"
          echo "  Tag: $TAG"
          echo ""
          
          npm publish --dry-run --tag $TAG
          
          echo ""
          echo "âœ… Dry run completed successfully!"
          
      # VÃ©rification post-publication
      - name: Verify publication
        if: github.event.inputs.dry_run != 'true'
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "â³ Waiting for NPM to update..."
          sleep 15
          
          echo "ðŸ” Checking NPM for @dainabase/ui@$VERSION..."
          NPM_VERSION=$(npm view @dainabase/ui@$VERSION version 2>/dev/null || echo "not found")
          
          if [ "$NPM_VERSION" = "$VERSION" ]; then
            echo "âœ… Package verified on NPM!"
            echo "ðŸ“¦ Install with: npm install @dainabase/ui@$VERSION"
          else
            echo "âš ï¸ Package not yet visible on NPM (this is normal, it can take a few minutes)"
            echo "Check manually at: https://www.npmjs.com/package/@dainabase/ui"
          fi
          
  notify:
    name: Send notification
    runs-on: ubuntu-latest
    needs: publish
    if: success() && github.event.inputs.dry_run != 'true'
    
    steps:
      - name: Create success comment
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ github.event.inputs.version }}';
            const tag = '${{ github.event.inputs.tag }}';
            
            // CrÃ©er un commentaire sur le dernier commit
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            if (commits.length > 0) {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commits[0].sha,
                body: `## ðŸŽ‰ @dainabase/ui v${version} Published Successfully!\n\n` +
                      `### ðŸ“¦ Installation\n` +
                      `\`\`\`bash\n` +
                      `npm install @dainabase/ui@${version}\n` +
                      `\`\`\`\n\n` +
                      `**Tag:** ${tag}\n` +
                      `**NPM:** https://www.npmjs.com/package/@dainabase/ui/v/${version}\n` +
                      `**Status:** âœ… Published`
              });
            }
            
            console.log(`âœ… @dainabase/ui v${version} published with tag: ${tag}`);
