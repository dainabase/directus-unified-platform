<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>Mes Missions - Espace Prestataire</title>
    
    <!-- CSS Tabler -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css" rel="stylesheet">
    <link href="../../../assets/css/custom.css" rel="stylesheet">
</head>
<body data-bs-theme="light">
    <div class="page">
        <!-- Navbar from prestataire dashboard -->
        <header class="navbar navbar-expand-md navbar-light d-print-none">
            <div class="container-xl">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                    <a href="../dashboard.html">
                        <img src="../../../assets/img/logo.svg" width="110" height="32" alt="Dashboard" class="navbar-brand-image">
                        Espace Prestataire
                    </a>
                </h1>
                <div class="navbar-nav flex-row order-md-last">
                    <div class="nav-item d-none d-md-flex me-3">
                        <div class="btn-list">
                            <span class="badge bg-green">PRESTATAIRE</span>
                        </div>
                    </div>
                    <div class="d-none d-md-flex">
                        <a href="#" class="nav-link px-0 hide-theme-dark" onclick="document.body.setAttribute('data-bs-theme', 'dark')" title="Activer le mode sombre" data-bs-toggle="tooltip" data-bs-placement="bottom">
                            <i class="ti ti-moon"></i>
                        </a>
                        <a href="#" class="nav-link px-0 hide-theme-light" onclick="document.body.setAttribute('data-bs-theme', 'light')" title="Activer le mode clair" data-bs-toggle="tooltip" data-bs-placement="bottom">
                            <i class="ti ti-sun"></i>
                        </a>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
                            <span class="avatar avatar-sm bg-green-lt">PR</span>
                            <div class="d-none d-xl-block ps-2">
                                <div>Jean Dupont</div>
                                <div class="mt-1 small text-secondary">Consultant Senior</div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                            <a href="../profile.html" class="dropdown-item">
                                <i class="ti ti-user me-2"></i>
                                Mon profil
                            </a>
                            <a href="./missions.html" class="dropdown-item">
                                <i class="ti ti-briefcase me-2"></i>
                                Mes missions
                            </a>
                            <a href="../calendar.html" class="dropdown-item">
                                <i class="ti ti-calendar me-2"></i>
                                Calendrier
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item text-danger" onclick="logout()">
                                <i class="ti ti-logout me-2"></i>
                                Déconnexion
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Horizontal menu -->
        <header class="navbar-expand-md">
            <div class="collapse navbar-collapse" id="navbar-menu">
                <div class="navbar">
                    <div class="container-xl">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" href="../dashboard.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-home"></i>
                                    </span>
                                    <span class="nav-link-title">Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-item active">
                                <a class="nav-link" href="./missions.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-briefcase"></i>
                                    </span>
                                    <span class="nav-link-title">Missions</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="../calendar.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-calendar"></i>
                                    </span>
                                    <span class="nav-link-title">Calendrier</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="../timesheets.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-clock"></i>
                                    </span>
                                    <span class="nav-link-title">Temps</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="../knowledge.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-book"></i>
                                    </span>
                                    <span class="nav-link-title">Base de connaissances</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">Mes Missions</h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <button class="btn" onclick="exportMissions()">
                                    <i class="ti ti-download"></i> Exporter
                                </button>
                                <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#timesheet-modal">
                                    <i class="ti ti-clock-plus"></i> Saisir temps
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="page-body">
                <div class="container-xl">
                    <!-- Stats cards -->
                    <div class="row row-cards mb-4">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <span class="bg-primary text-white avatar">
                                                <i class="ti ti-briefcase"></i>
                                            </span>
                                        </div>
                                        <div class="col">
                                            <div class="font-weight-medium">Missions actives</div>
                                            <div class="text-muted">4 en cours</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <span class="bg-success text-white avatar">
                                                <i class="ti ti-calendar-check"></i>
                                            </span>
                                        </div>
                                        <div class="col">
                                            <div class="font-weight-medium">Jours ce mois</div>
                                            <div class="text-muted">18 jours</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <span class="bg-info text-white avatar">
                                                <i class="ti ti-clock"></i>
                                            </span>
                                        </div>
                                        <div class="col">
                                            <div class="font-weight-medium">Heures facturables</div>
                                            <div class="text-muted">152 heures</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <span class="bg-yellow text-white avatar">
                                                <i class="ti ti-currency-dollar"></i>
                                            </span>
                                        </div>
                                        <div class="col">
                                            <div class="font-weight-medium">CA généré</div>
                                            <div class="text-muted">CHF 28'800</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtres -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Statut</label>
                                    <select class="form-select" id="filter-status">
                                        <option value="">Tous</option>
                                        <option value="active">En cours</option>
                                        <option value="upcoming">À venir</option>
                                        <option value="completed">Terminées</option>
                                        <option value="on-hold">En pause</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Client</label>
                                    <select class="form-select" id="filter-client">
                                        <option value="">Tous les clients</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Rechercher</label>
                                    <input type="text" class="form-control" id="filter-search" placeholder="Nom, client, projet...">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                                        <i class="ti ti-filter"></i> Filtrer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Liste des missions -->
                    <div class="row row-cards" id="missions-container">
                        <!-- Sera rempli par JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal saisie temps -->
    <div class="modal modal-blur fade" id="timesheet-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Saisir temps de travail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Mission</label>
                        <select class="form-select" id="timesheet-mission">
                            <option value="">Sélectionner une mission</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="timesheet-date" value="">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Durée (heures)</label>
                                <input type="number" class="form-control" id="timesheet-hours" step="0.5" min="0.5" max="12" placeholder="Ex: 7.5">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type d'activité</label>
                        <select class="form-select" id="timesheet-activity">
                            <option value="development">Développement</option>
                            <option value="meeting">Réunion</option>
                            <option value="analysis">Analyse</option>
                            <option value="documentation">Documentation</option>
                            <option value="testing">Tests</option>
                            <option value="support">Support</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="timesheet-description" rows="3" placeholder="Décrivez votre activité..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn me-auto" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveTimesheet()">
                        <i class="ti ti-check"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script src="../../../assets/js/app.js"></script>
    <script src="../../../assets/js/auth-directus.js"></script>
    
    <script>
        let allMissions = [];
        
        async function loadMissions() {
            try {
                const response = await window.App.api.get('/items/missions');
                allMissions = response.data || [];
                
                // Données de test si pas de missions
                if (allMissions.length === 0) {
                    allMissions = [
                        {
                            id: 1,
                            name: 'Développement App Mobile',
                            client: 'TechCorp SA',
                            project: 'Application e-commerce',
                            status: 'active',
                            start_date: '2025-01-01',
                            end_date: '2025-03-31',
                            daily_rate: 1200,
                            progress: 45,
                            days_worked: 12,
                            days_total: 60,
                            description: 'Développement d\'une application mobile iOS/Android pour le commerce électronique'
                        },
                        {
                            id: 2,
                            name: 'Audit Sécurité',
                            client: 'BankSecure AG',
                            project: 'Audit annuel',
                            status: 'active',
                            start_date: '2025-01-15',
                            end_date: '2025-02-15',
                            daily_rate: 1500,
                            progress: 20,
                            days_worked: 3,
                            days_total: 20,
                            description: 'Audit de sécurité complet des systèmes bancaires'
                        },
                        {
                            id: 3,
                            name: 'Formation DevOps',
                            client: 'StartupHub',
                            project: 'Formation équipe',
                            status: 'upcoming',
                            start_date: '2025-02-01',
                            end_date: '2025-02-05',
                            daily_rate: 1800,
                            progress: 0,
                            days_worked: 0,
                            days_total: 5,
                            description: 'Formation DevOps et CI/CD pour l\'équipe de développement'
                        },
                        {
                            id: 4,
                            name: 'Migration Cloud',
                            client: 'RetailMax',
                            project: 'Infrastructure AWS',
                            status: 'active',
                            start_date: '2024-12-01',
                            end_date: '2025-02-28',
                            daily_rate: 1400,
                            progress: 70,
                            days_worked: 35,
                            days_total: 50,
                            description: 'Migration de l\'infrastructure on-premise vers AWS'
                        }
                    ];
                }
                
                displayMissions(allMissions);
                populateFilters();
                populateMissionSelect();
            } catch (error) {
                console.error('Erreur:', error);
                window.App.utils.showAlert('Erreur de chargement des missions', 'danger');
            }
        }
        
        function displayMissions(missions) {
            const container = document.getElementById('missions-container');
            
            if (missions.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="card"><div class="card-body text-center text-muted">Aucune mission trouvée</div></div></div>';
                return;
            }
            
            container.innerHTML = missions.map(mission => `
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-status-start bg-${getStatusColor(mission.status)}"></div>
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div>
                                    <h3 class="card-title mb-0">${mission.name}</h3>
                                    <div class="text-muted">${mission.client} - ${mission.project}</div>
                                </div>
                                <div class="ms-auto">
                                    <span class="badge bg-${getStatusColor(mission.status)}">
                                        ${getStatusLabel(mission.status)}
                                    </span>
                                </div>
                            </div>
                            
                            <p class="text-muted small">${mission.description}</p>
                            
                            <div class="mb-3">
                                <div class="row align-items-center mb-2">
                                    <div class="col-auto">
                                        <span class="text-muted">Progression</span>
                                    </div>
                                    <div class="col">
                                        <div class="progress">
                                            <div class="progress-bar bg-${getStatusColor(mission.status)}" style="width: ${mission.progress}%" role="progressbar">
                                                <span class="visually-hidden">${mission.progress}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <span class="small">${mission.progress}%</span>
                                    </div>
                                </div>
                                
                                <div class="row text-muted small">
                                    <div class="col">
                                        <i class="ti ti-calendar me-1"></i>
                                        ${new Date(mission.start_date).toLocaleDateString('fr-CH')} - ${new Date(mission.end_date).toLocaleDateString('fr-CH')}
                                    </div>
                                    <div class="col-auto">
                                        <i class="ti ti-clock me-1"></i>
                                        ${mission.days_worked}/${mission.days_total} jours
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row align-items-center">
                                <div class="col">
                                    <div class="text-muted">Taux journalier</div>
                                    <div class="h4 mb-0">${window.App.utils.formatCurrency(mission.daily_rate)}</div>
                                </div>
                                <div class="col-auto">
                                    <div class="btn-list">
                                        <a href="./mission-detail.html?id=${mission.id}" class="btn btn-sm">
                                            <i class="ti ti-eye"></i> Détails
                                        </a>
                                        <button class="btn btn-sm btn-primary" onclick="openTimesheetModal(${mission.id})">
                                            <i class="ti ti-clock-plus"></i> Temps
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function getStatusColor(status) {
            const colors = {
                'active': 'primary',
                'upcoming': 'info',
                'completed': 'success',
                'on-hold': 'warning',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }
        
        function getStatusLabel(status) {
            const labels = {
                'active': 'En cours',
                'upcoming': 'À venir',
                'completed': 'Terminée',
                'on-hold': 'En pause',
                'cancelled': 'Annulée'
            };
            return labels[status] || status;
        }
        
        function populateFilters() {
            const clientSelect = document.getElementById('filter-client');
            const uniqueClients = [...new Set(allMissions.map(m => m.client))];
            
            clientSelect.innerHTML = '<option value="">Tous les clients</option>' +
                uniqueClients.map(client => `<option value="${client}">${client}</option>`).join('');
        }
        
        function populateMissionSelect() {
            const missionSelect = document.getElementById('timesheet-mission');
            const activeMissions = allMissions.filter(m => m.status === 'active');
            
            missionSelect.innerHTML = '<option value="">Sélectionner une mission</option>' +
                activeMissions.map(m => `<option value="${m.id}">${m.name} - ${m.client}</option>`).join('');
        }
        
        function applyFilters() {
            const status = document.getElementById('filter-status').value;
            const client = document.getElementById('filter-client').value;
            const search = document.getElementById('filter-search').value.toLowerCase();
            
            let filtered = allMissions;
            
            if (status) {
                filtered = filtered.filter(m => m.status === status);
            }
            
            if (client) {
                filtered = filtered.filter(m => m.client === client);
            }
            
            if (search) {
                filtered = filtered.filter(m => 
                    m.name?.toLowerCase().includes(search) ||
                    m.client?.toLowerCase().includes(search) ||
                    m.project?.toLowerCase().includes(search)
                );
            }
            
            displayMissions(filtered);
        }
        
        function openTimesheetModal(missionId) {
            if (missionId) {
                document.getElementById('timesheet-mission').value = missionId;
            }
            // Set today's date
            document.getElementById('timesheet-date').value = new Date().toISOString().split('T')[0];
            
            const modal = new bootstrap.Modal(document.getElementById('timesheet-modal'));
            modal.show();
        }
        
        async function saveTimesheet() {
            const missionId = document.getElementById('timesheet-mission').value;
            const date = document.getElementById('timesheet-date').value;
            const hours = document.getElementById('timesheet-hours').value;
            const activity = document.getElementById('timesheet-activity').value;
            const description = document.getElementById('timesheet-description').value;
            
            if (!missionId || !date || !hours || !description) {
                window.App.utils.showAlert('Veuillez remplir tous les champs obligatoires', 'warning');
                return;
            }
            
            try {
                // En production, faire un vrai POST vers Directus
                // const response = await window.App.api.post('/items/timesheets', { ... });
                
                window.App.utils.showAlert('Temps enregistré avec succès!', 'success');
                
                // Fermer le modal
                bootstrap.Modal.getInstance(document.getElementById('timesheet-modal')).hide();
                
                // Réinitialiser le formulaire
                document.getElementById('timesheet-mission').value = '';
                document.getElementById('timesheet-hours').value = '';
                document.getElementById('timesheet-description').value = '';
                
            } catch (error) {
                console.error('Erreur:', error);
                window.App.utils.showAlert('Erreur lors de l\'enregistrement', 'danger');
            }
        }
        
        function exportMissions() {
            window.App.utils.showAlert('Export en cours de développement', 'info');
        }
        
        function logout() {
            if (window.AuthDirectus) {
                window.AuthDirectus.logout();
            }
        }
        
        // Charger au démarrage
        document.addEventListener('DOMContentLoaded', loadMissions);
    </script>
</body>
</html>